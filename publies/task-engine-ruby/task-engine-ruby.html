<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Julien Kirch">
<title>Écrire un moteur de tâches en Ruby</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Écrire un moteur de tâches en Ruby</h1>
<div class="details">
<span id="author" class="author">Julien Kirch</span><br>
<span id="revdate">2020-10-12</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#MDT-01">Partie 1 : introduction</a></li>
<li><a href="#MDT-02">Partie 2 : la boucle de traitement</a>
<ul class="sectlevel2">
<li><a href="#_la_boucle_de_traitement">La boucle de traitement</a></li>
<li><a href="#_augmenter_la_capacité_de_traitement">Augmenter la capacité de traitement</a></li>
<li><a href="#_threading_et_ruby">Threading et Ruby</a></li>
<li><a href="#_démarrer_le_projet">Démarrer le projet</a></li>
</ul>
</li>
<li><a href="#MDT-03">Partie 3 : le début de la persistance</a>
<ul class="sectlevel2">
<li><a href="#_quoi_et_comment_stocker">Quoi et comment stocker&#160;?</a></li>
<li><a href="#_les_technologies_du_projet">Les technologies du projet</a></li>
<li><a href="#_modéliser_et_créer_les_tâches">Modéliser et créer les tâches</a></li>
<li><a href="#_ne_pas_perdre_de_tâche">Ne pas perdre de tâche</a></li>
<li><a href="#_verrou_et_transaction">Verrou et transaction</a></li>
<li><a href="#_la_nouvelle_boucle">La nouvelle boucle</a></li>
</ul>
</li>
<li><a href="#MDT-04">Partie 4 : l&#8217;arrêt</a>
<ul class="sectlevel2">
<li><a href="#_pourquoi_lextinction_est_importante">Pourquoi l&#8217;extinction est importante</a></li>
<li><a href="#_les_signaux">Les signaux</a></li>
<li><a href="#_le_signal_darrêt_dans_le_moteur_de_tâches">Le signal d&#8217;arrêt dans le moteur de tâches</a></li>
<li><a href="#_sarrêter_vraiment">S&#8217;arrêter vraiment</a></li>
</ul>
</li>
<li><a href="#MDT-05">Partie 5 : le redémarrage</a>
<ul class="sectlevel2">
<li><a href="#_la_théorie">La théorie</a></li>
<li><a href="#_la_pratique">La pratique</a></li>
</ul>
</li>
<li><a href="#MDT-06">Partie 6 : le paramétrage des tâches</a>
<ul class="sectlevel2">
<li><a href="#_définition_de_lapi_des_tâches">Définition de l&#8217;API des tâches</a></li>
<li><a href="#_modification_de_schéma">Modification de schéma</a></li>
<li><a href="#_définition_dune_classe_de_tâche">Définition d&#8217;une classe de tâche</a></li>
<li><a href="#_création_de_tâches">Création de tâches</a></li>
<li><a href="#_lexécution">L&#8217;exécution</a></li>
</ul>
</li>
<li><a href="#MDT-07">Partie 7 : l&#8217;ajout de tâches</a>
<ul class="sectlevel2">
<li><a href="#_le_principe_des_notifications">Le principe des notifications</a></li>
<li><a href="#_la_nouvelle_boucle_de_traitement_des_workers">La nouvelle boucle de traitement des workers</a></li>
<li><a href="#_envoyer_une_notification_ou_le_contenu_dune_tâche">Envoyer une notification ou le contenu d&#8217;une tâche</a></li>
<li><a href="#_pourquoi_ne_pas_utiliser_une_id_pour_récupérer_la_prochaine_tâche">Pourquoi ne pas utiliser une <code>id</code> pour récupérer la prochaine tâche&#160;?</a></li>
<li><a href="#_la_partie_notification">La partie notification</a></li>
<li><a href="#_notifications_et_transations">Notifications et transations</a></li>
</ul>
</li>
<li><a href="#MDT-08">Partie 8 : le monitoring unitaire</a>
<ul class="sectlevel2">
<li><a href="#_les_informations_de_monitoring">Les informations de monitoring</a></li>
<li><a href="#_lajout_des_informations">L&#8217;ajout des informations</a></li>
<li><a href="#_le_test">Le test</a></li>
<li><a href="#_et_un_index">Et un index</a></li>
</ul>
</li>
<li><a href="#_explain_select_from_tasks_where_status_waiting_order_by_created_at_limit_1">explain SELECT * FROM "tasks" WHERE ("status" = 'waiting') ORDER BY "created_at" LIMIT 1;</a></li>
<li><a href="#MDT-09">Partie 9 : la planification</a>
<ul class="sectlevel2">
<li><a href="#_les_tâches_à_exécution_régulière">Les tâches à exécution régulière</a></li>
<li><a href="#_les_tâches_à_exécution_unique">Les tâches à exécution unique</a></li>
<li><a href="#_allo_la_tâche">Allo la tâche ?</a></li>
</ul>
</li>
<li><a href="#MDT-10">Partie 10 : la gestion d&#8217;erreurs</a>
<ul class="sectlevel2">
<li><a href="#_une_tâche_qui_plante">Une tâche qui plante</a></li>
<li><a href="#_réessayer">Réessayer</a></li>
<li><a href="#_réessayer_mais_pas_tout_le_temps">Réessayer mais pas tout le temps</a></li>
</ul>
</li>
<li><a href="#MDT-11">Conclusion</a></li>
<li><a href="#MDT-12">Annexe : le code source</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="MDT-01">Partie 1 : introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un moteur de tâches est une brique logicielle dont le rôle est d&#8217;exécuter de manière asynchrone des morceaux de code qu&#8217;on lui fournit qu&#8217;on appelle tâches.
On l&#8217;alimente en tâches (par exemple via une file de messages) et il les consomme, en général aussi vite que possible.</p>
</div>
<div class="paragraph">
<p>Vous avez par exemple Quartz en Java ou Sidekiq en Ruby.</p>
</div>
<div class="paragraph">
<p>Ils sont généralement très simple à utiliser, surtout si on s&#8217;en tient aux fonctionnalités standard, mais ce n&#8217;est pas le cas de leur fonctionnement interne.</p>
</div>
<div class="paragraph">
<p>En effet un moteur de tâches se doit (en principe) d&#8217;être efficace via du parallélisme, de ne pas perdre de données, de fournir une gestion d&#8217;erreur qui permette d&#8217;investiguer les problèmes et un tas d&#8217;autres choses.</p>
</div>
<div class="paragraph">
<p>Ces caractéristiques ne sont pas propres aux moteurs de tâches, au contraire on les retrouve, ou on est sensé les retrouver, dans la majorité des logiciels serveurs.</p>
</div>
<div class="paragraph">
<p>Aucune d&#8217;entre elle ne requiert de code particulièrement complexe, du moins tant qu&#8217;on choisi de s&#8217;appuyer sur des outils existants comme des moteurs de bases de données.</p>
</div>
<div class="paragraph">
<p>Il s&#8217;agit plutôt de s&#8217;appuyer sur des patterns bien choisis et éprouvés.
<a href="https://archiloque.net/blog/comment-se-mettre-a-l-echelle-en-presence-d-erreurs/">Cet article</a> illustre cette situation dans le domaine de la gestion d&#8217;erreur.</p>
</div>
<div class="paragraph">
<p>Cela signifie que bien comprendre le fonctionnement d&#8217;un moteur de tâches permet de comprendre le fonctionnement d&#8217;autres logiciels qui ont les mêmes caractéristiques.</p>
</div>
<div class="paragraph">
<p>Pour cela je vous propose donc de décrire pas à pas la construction de ce type d&#8217;outil.
À chaque étape, je vais expliquer le besoin auquel répond chaque nouvel élément, et la manière d&#8217;y répondre.</p>
</div>
<div class="paragraph">
<p>Si l&#8217;outil résultant ne sera pas aussi complet qu&#8217;un &#8220;vrai&#8221; moteur de tâches, il en comportera tous les éléments essentiels.</p>
</div>
<div class="paragraph">
<p>Il est temps de passer aux choses sérieuses, et je vais commencer par construire la boucle de traitement qui forme le centre de l&#8217;outil.</p>
</div>
<div class="paragraph">
<p>Le code source complet de l&#8217;outil est disponible en annexe, et il est également disponible en ligne <a href="https://github.com/archiloque/task_engine">ici</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-02">Partie 2 : la boucle de traitement</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_la_boucle_de_traitement">La boucle de traitement</h3>
<div class="paragraph">
<p>Le centre d&#8217;un moteur de tâches c&#8217;est une boucle qui fait quatre choses&#160;:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuNDAuMSAoMjAxNjEyMjUuMDMwNCkKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIzNDRwdCIgaGVpZ2h0PSIyNjBwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAzNDQuMTUgMjYwLjAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDI1NikiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0idHJhbnNwYXJlbnQiIHBvaW50cz0iLTQsNCAtNCwtMjU2IDM0MC4xNTA1LC0yNTYgMzQwLjE1MDUsNCAtNCw0Ii8+CjwhLS0gcyAtLT4KPGcgaWQ9Im5vZGUxIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5zPC90aXRsZT4KPGVsbGlwc2UgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMDAwIiBjeD0iMTk5Ljc2NzgiIGN5PSItMjM0IiByeD0iMTM2LjI2NTUiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxOTkuNzY3OCIgeT0iLTIyOS44IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiIGZpbGw9IiMwMDAwMDAiPlPDqWxlY3Rpb25uZXIgbGEgcHJvY2hhaW5lIHTDomNoZTwvdGV4dD4KPC9nPgo8IS0tIHByZSAtLT4KPGcgaWQ9Im5vZGUyIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5wcmU8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIGN4PSIxMjMuNzY3OCIgY3k9Ii0xNjIiIHJ4PSIxMjMuNTM2MSIgcnk9IjE4Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjEyMy43Njc4IiB5PSItMTU3LjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCIgZmlsbD0iIzAwMDAwMCI+RWZmZWN0dWVyIGRlcyBwcsOpJiM0NTt0cmFpdGVtZW50czwvdGV4dD4KPC9nPgo8IS0tIHMmIzQ1OyZndDtwcmUgLS0+CjxnIGlkPSJlZGdlMSIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+cyYjNDU7Jmd0O3ByZTwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgZD0iTTE4MC41ODk4LC0yMTUuODMxNEMxNzEuMzM4OSwtMjA3LjA2NzMgMTYwLjA5NywtMTk2LjQxNzEgMTUwLjA2MiwtMTg2LjkxMDMiLz4KPHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjMDAwMDAwIiBwb2ludHM9IjE1Mi4zNDMxLC0xODQuMjUgMTQyLjY3NjQsLTE3OS45MTM0IDE0Ny41Mjg5LC0xODkuMzMxNyAxNTIuMzQzMSwtMTg0LjI1Ii8+CjwvZz4KPCEtLSB4IC0tPgo8ZyBpZD0ibm9kZTMiIGNsYXNzPSJub2RlIj4KPHRpdGxlPng8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9IiMwMDAwMDAiIGN4PSIxNDQuNzY3OCIgY3k9Ii05MCIgcng9IjgxLjg4OTEiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxNDQuNzY3OCIgeT0iLTg1LjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCIgZmlsbD0iIzAwMDAwMCI+RXjDqWN1dGVyIGxhIHTDomNoZTwvdGV4dD4KPC9nPgo8IS0tIHByZSYjNDU7Jmd0O3ggLS0+CjxnIGlkPSJlZGdlMiIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+cHJlJiM0NTsmZ3Q7eDwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgZD0iTTEyOS4wNjcsLTE0My44MzE0QzEzMS4zMzc2LC0xMzYuMDQ2MyAxMzQuMDQyNCwtMTI2Ljc3MjkgMTM2LjU2MTksLTExOC4xMzQ3Ii8+Cjxwb2x5Z29uIGZpbGw9IiMwMDAwMDAiIHN0cm9rZT0iIzAwMDAwMCIgcG9pbnRzPSIxMzkuOTU3MiwtMTE4Ljk5MzMgMTM5LjM5NzMsLTEwOC40MTMzIDEzMy4yMzcyLC0xMTcuMDMzMiAxMzkuOTU3MiwtMTE4Ljk5MzMiLz4KPC9nPgo8IS0tIHBvc3QgLS0+CjxnIGlkPSJub2RlNCIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+cG9zdDwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMDAwMCIgY3g9IjE5OS43Njc4IiBjeT0iLTE4IiByeD0iMTI2LjczNzUiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxOTkuNzY3OCIgeT0iLTEzLjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCIgZmlsbD0iIzAwMDAwMCI+RWZmZWN0dWVyIGRlcyBwb3N0JiM0NTt0cmFpdGVtZW50czwvdGV4dD4KPC9nPgo8IS0tIHgmIzQ1OyZndDtwb3N0IC0tPgo8ZyBpZD0iZWRnZTMiIGNsYXNzPSJlZGdlIj4KPHRpdGxlPngmIzQ1OyZndDtwb3N0PC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMDAwIiBkPSJNMTU4LjM2MzMsLTcyLjIwMjJDMTY0Ljc5MzEsLTYzLjc4NTEgMTcyLjU5OSwtNTMuNTY2NSAxNzkuNjkyNSwtNDQuMjgwNSIvPgo8cG9seWdvbiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50cz0iMTgyLjY1NzYsLTQ2LjE2NDUgMTg1Ljk0NjcsLTM2LjA5MzEgMTc3LjA5NDksLTQxLjkxNTIgMTgyLjY1NzYsLTQ2LjE2NDUiLz4KPC9nPgo8IS0tIHBvc3QmIzQ1OyZndDtzIC0tPgo8ZyBpZD0iZWRnZTQiIGNsYXNzPSJlZGdlIj4KPHRpdGxlPnBvc3QmIzQ1OyZndDtzPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMDAwIiBkPSJNMjE1LjEzNzUsLTM2LjI4NjVDMjM4LjY2MTMsLTY2LjYyMTYgMjc4LjY4MDIsLTEyOS4wNTY2IDI1Ni43Njc4LC0xODAgMjUxLjg4NjYsLTE5MS4zNDgzIDI0My4zMTgxLC0yMDEuNDI5MSAyMzQuMjg0NywtMjA5LjcxNzciLz4KPHBvbHlnb24gZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjMDAwMDAwIiBwb2ludHM9IjIzMS45NzgzLC0yMDcuMDg0OCAyMjYuNjU4MSwtMjE2LjI0NzEgMjM2LjUzMDcsLTIxMi40MDIzIDIzMS45NzgzLC0yMDcuMDg0OCIvPgo8L2c+CjwvZz4KPC9zdmc+" alt="workflow 2 1">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sélectionner la prochaine tâche à exécuter</p>
</li>
<li>
<p>Effectuer des pré-traitements (par exemple loguer)</p>
</li>
<li>
<p>Exécuter la tâche</p>
</li>
<li>
<p>Effectuer des post-traitements (par exemple loguer et faire des traitements spécifiques en cas d&#8217;erreur)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Les composants du système qui effectuent cette boucle sont généralement appelés des &#8220;workers&#8221;.</p>
</div>
</div>
<div class="sect2">
<h3 id="_augmenter_la_capacité_de_traitement">Augmenter la capacité de traitement</h3>
<div class="paragraph">
<p>Un moteur de tâches passe la très grande majorité de son temps à exécuter les tâches.</p>
</div>
<div class="paragraph">
<p>Une fois que les tâches ont été correctement optimisées, augmenter la capacité de traitement nécessite de pouvoir lancer des tâches supplémentaires, et donc ajouter des workers.</p>
</div>
<div class="paragraph">
<p>Cela signifie que les phases en dehors de celle d&#8217;exécution de la tâche doivent pouvoir être parallélisées le plus possible.
Cela passe principalement par éviter ou limiter les moment où les différents workers peuvent interférer les uns avec les autres.</p>
</div>
<div class="paragraph">
<p>Si les tâches à exécuter ont elles-même des problèmes de contention, cela va limiter la parallélisation de tout le système, mais c&#8217;est est en dehors du périmètre du moteur de tâches en lui-même.</p>
</div>
<div class="paragraph">
<p>Tout ce qu&#8217;il à faire pendant l&#8217;exécution c&#8217;est de ne pas être une gène.</p>
</div>
<div class="paragraph">
<p>Ajouter des workers peut se faire de deux manières&#160;: en lançant plusieurs workers dans un même processus et en lançant plusieurs processus.</p>
</div>
<div class="paragraph">
<p>La première approche s&#8217;appuie souvent sur des threads, qui est un mécanisme fournit par la plupart des systèmes d&#8217;exploitations.
Elle a l&#8217;avantage de limiter la consommation mémoire car les différents threads peuvent partager des ressources, par exemple la mémoire dans laquelle le code qui s&#8217;exécute est chargé.</p>
</div>
<div class="paragraph">
<p>Utiliser plusieurs processus évite d&#8217;être limité par la puissance d&#8217;une machine, en effets les différents processus peuvent être lancés sur des serveurs différents.
Par contre elle transforme le moteur de tâches en système distribué, et subit par conséquents les contraintes de ce type de programmes.</p>
</div>
<div class="paragraph">
<p>Les deux options sont complémentaires&#160;: on peut avoir plusieurs processus hébergeant chacun plusieurs threads.</p>
</div>
<div class="paragraph">
<p>L&#8217;idéal est d&#8217;avoir un système qui sache tirer partie des threads pour bénéficier de l&#8217;économie de ressources, tout en fonctionnant bien en multi-process quand ça devient nécessaire.</p>
</div>
</div>
<div class="sect2">
<h3 id="_threading_et_ruby">Threading et Ruby</h3>
<div class="paragraph">
<p>Les thread en Ruby ont une spécificité&#160;: l&#8217;implémentation Ruby de référence (probablement celle que vous utilisez si vous n&#8217;avez pas choisi spécifiquement d&#8217;en utiliser une autre) ne permet pas plusieurs thread de s&#8217;exécuter en même temps, à cause de limitations dans la manière dont elle est implémentée.
Si vous utilisez un moteur de tâches en Ruby et que vous voulez pleinement profiter d&#8217;avoir plusieurs threads, il faut ainsi utiliser des implémentation alternatives comme JRuby.</p>
</div>
<div class="paragraph">
<p>Cela ne signifie pas qu&#8217;utiliser plusieurs threads en Ruby soit inutile dans un moteur de tâches avec l&#8217;implémentation de référence.
Car même si un seul thread s&#8217;exécute à la fois, plusieurs tâches peuvent tout de même être en train de progresser.
C&#8217;est le cas parce que lorsqu&#8217;un appel extérieur est fait, par exemple une requête en base de données ou un appel réseau, le thread qui fait l&#8217;appel est mis en pause et un autre thread peut alors s&#8217;exécuter, pendant que l&#8217;appel est en train de se faire.
Lorsqu&#8217;il se termine, le premier thread va alors attendre son tour et continuer son traitement.</p>
</div>
<div class="paragraph">
<p>Dans un système ou la majorité du temps est passé à attendre le reste du monde, avoir plusieurs threads peut donc être tout de même assez avantageux.
À l&#8217;inverse si les traitements demandent des traitements longs dans le moteur de tâches, les threads sont pratiquement inutiles et faudra alors s&#8217;appuyer uniquement sur des processus ou utiliser une autre machine virtuelle.</p>
</div>
</div>
<div class="sect2">
<h3 id="_démarrer_le_projet">Démarrer le projet</h3>
<div class="paragraph">
<p>Je vais mettre l&#8217;ensemble du code (framework et code d&#8217;exemple) dans un projet unique et je ne le packagerai pas sous forme d&#8217;une gem.</p>
</div>
<div class="paragraph">
<p>Le faire ajouterait de la configuration et du code et donc un peu de complexité sans que cela apporte quelque chose aux sujets dont je veux discuter ici.</p>
</div>
<div class="paragraph">
<p>Je commence par définir la version de Ruby à utiliser</p>
</div>
<div class="listingblock">
<div class="title">.ruby-version</div>
<div class="content">
<pre class="pygments highlight"><code><span></span>2.7.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>et ma dépendance de départ</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-n">source</span> <span class="tok-s1">&#39;https://rubygems.org&#39;</span>

<span class="tok-n">gem</span> <span class="tok-s1">&#39;rake&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;~&gt; 13.0&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour montrer comment fonctionnent le threading, la première implémentation des tâches se contentera d&#8217;attendre quelques secondes via la méthode <code>Kernel#sleep</code> ce qui permet aux autres threads de s&#8217;exécuter.
Et pour le moment elle n&#8217;iront pas chercher quelles tâches sont disponibles, mais s&#8217;exécuteront de manière continue dans une boucle infinie.</p>
</div>
<div class="paragraph">
<p>La version simplifiée d&#8217;un worker se résume alors à&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
  <span class="tok-k">while</span> <span class="tok-kp">true</span>
    <span class="tok-n">execute</span>
  <span class="tok-k">end</span>

<span class="tok-k">def</span> <span class="tok-nf">execute</span>
  <span class="tok-nb">p</span> <span class="tok-s1">&#39;Task is starting&#39;</span>
  <span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">)</span>
  <span class="tok-nb">p</span> <span class="tok-s1">&#39;Task is stopping&#39;</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le thread principal du moteur de tâches va démarrer les différent workers puis se mettre en pause pour leur permettre s&#8217;exécuter.</p>
</div>
<div class="paragraph">
<p>Pour vérifier que cela fonctionne, il est nécessaire de lancer plusieurs workers, et d&#8217;ajouter des logs.</p>
</div>
<div class="paragraph">
<p>Je vais placer le code des workers dans un classe spécifique <code>TaskEngine::Worker</code>, et une autre classe <code>TaskEngine::Engine</code> sera chargée de les lancer, c&#8217;est elle qui sera exécutée au démarrage du moteur de tâches.</p>
</div>
<div class="paragraph">
<p>Chaque instance de worker reçoit un numéro de façon à pouvoir suivre ce qu&#8217;elle fait dans les logs.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-nb">require</span> <span class="tok-s1">&#39;date&#39;</span>
<span class="tok-nb">require</span> <span class="tok-s1">&#39;logger&#39;</span>

<span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>

  <span class="tok-no">WORKERS_NUMBER</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
  <span class="tok-no">MILLISECONDS_IN_A_DAY</span> <span class="tok-o">=</span> <span class="tok-mi">24</span> <span class="tok-o">*</span> <span class="tok-mi">60</span> <span class="tok-o">*</span> <span class="tok-mi">60</span> <span class="tok-o">*</span> <span class="tok-mi">1000</span>
  <span class="tok-no">LOGGER</span> <span class="tok-o">=</span> <span class="tok-no">Logger</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-no">STDOUT</span><span class="tok-p">)</span>

  <span class="tok-k">class</span> <span class="tok-nc">Engine</span>
    <span class="tok-k">def</span> <span class="tok-nf">initialize</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Starting engine&#39;</span><span class="tok-p">)</span>
      <span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">upto</span><span class="tok-p">(</span><span class="tok-no">WORKERS_NUMBER</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">worker_index</span><span class="tok-o">|</span>
        <span class="tok-no">Worker</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">worker_index</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
      <span class="tok-nb">sleep</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>

  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>

    <span class="tok-c1"># @param [Integer] worker_index</span>
    <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">worker_index</span><span class="tok-p">)</span>
      <span class="tok-vi">@worker_index</span> <span class="tok-o">=</span> <span class="tok-n">worker_index</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Starting worker </span><span class="tok-si">#{</span><span class="tok-n">worker_index</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
      <span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
        <span class="tok-k">while</span> <span class="tok-kp">true</span>
          <span class="tok-n">execute</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>

    <span class="tok-kp">private</span>

    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-n">starting_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is starting&quot;</span><span class="tok-p">)</span>
      <span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">)</span>
      <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
      <span class="tok-c1"># The difference between two DateTimes is a Rational</span>
      <span class="tok-c1"># representing the value as a number of days</span>
      <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">((</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is stopping, took </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>

<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le nombre de workers est défini dans une constante, passer par un fichier de configuration ajouterait du code sans changer l&#8217;idée.</p>
</div>
<div class="paragraph">
<p>Il me reste à écrire une tâche Rake pour pouvoir démarrer le moteur&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Rakefile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-n">desc</span> <span class="tok-s1">&#39;Start the engine&#39;</span>
<span class="tok-n">task</span> <span class="tok-ss">:start_engine</span> <span class="tok-k">do</span>
  <span class="tok-n">require_relative</span> <span class="tok-s1">&#39;task_engine&#39;</span>
  <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">Engine</span><span class="tok-o">.</span><span class="tok-n">new</span>
<span class="tok-k">end</span>

<span class="tok-n">task</span> <span class="tok-ss">default</span><span class="tok-p">:</span> <span class="tok-ss">:start_engine</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et je peux vérifier que tout fonctionne comme prévu&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ rake
Starting engine
Starting worker <span class="tok-m">0</span>
Starting worker <span class="tok-m">1</span>
Starting worker <span class="tok-m">2</span>
Starting worker <span class="tok-m">3</span>
Starting worker <span class="tok-m">4</span>
Worker <span class="tok-m">0</span> is starting
Worker <span class="tok-m">2</span> is starting
Worker <span class="tok-m">1</span> is starting
Worker <span class="tok-m">3</span> is starting
Worker <span class="tok-m">4</span> is starting
Worker <span class="tok-m">0</span> is stopping, took <span class="tok-m">5006</span>.025ms
Worker <span class="tok-m">0</span> is starting
Worker <span class="tok-m">1</span> is stopping, took <span class="tok-m">5007</span>.419ms
Worker <span class="tok-m">1</span> is starting
Worker <span class="tok-m">4</span> is stopping, took <span class="tok-m">5006</span>.673ms
Worker <span class="tok-m">3</span> is stopping, took <span class="tok-m">5006</span>.849ms
Worker <span class="tok-m">3</span> is starting
Worker <span class="tok-m">4</span> is starting
Worker <span class="tok-m">2</span> is stopping, took <span class="tok-m">5006</span>.9259999999995ms
Worker <span class="tok-m">2</span> is starting
Worker <span class="tok-m">4</span> is stopping, took <span class="tok-m">5002</span>.389ms
Worker <span class="tok-m">4</span> is starting
Worker <span class="tok-m">1</span> is stopping, took <span class="tok-m">5003</span>.09ms
Worker <span class="tok-m">1</span> is starting
Worker <span class="tok-m">0</span> is stopping, took <span class="tok-m">5003</span>.359ms
Worker <span class="tok-m">0</span> is starting
Worker <span class="tok-m">2</span> is stopping, took <span class="tok-m">5002</span>.508ms
Worker <span class="tok-m">2</span> is starting
Worker <span class="tok-m">3</span> is stopping, took <span class="tok-m">5002</span>.456ms
Worker <span class="tok-m">3</span> is starting</code></pre>
</div>
</div>
<div class="paragraph">
<p>Les tâches se bien lancent les unes après les autres, et se passent effectivement la main après avoir démarré une fois qu&#8217;elles atteignent le <code>sleep</code>.
La boucle de traitement fonctionne donc bien, ou du moins sa version simplifiée.</p>
</div>
<div class="paragraph">
<p>Arrêter le programme stoppe immédiatement toutes les tâches en cours d&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>Dans la partie suivante je vais m&#8217;intéresser au stockage des tâches pour que les workers aillent chercher ce qu&#8217;ils ont à faire.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-03">Partie 3 : le début de la persistance</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_quoi_et_comment_stocker">Quoi et comment stocker&#160;?</h3>
<div class="paragraph">
<p>Un moteur de tâches a besoin de stocker deux types de données : les tâches qui ne sont pas encore lancées et les logs de tâches exécutées.</p>
</div>
<div class="paragraph">
<p>Pour les tâches qui ne sont pas encore lancées, l&#8217;idéal est d&#8217;avoir un système de stockage&#160;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>fiable (pour ne pas perdre de tâches même en cas de crash),</p>
</li>
<li>
<p>qui gère la parallélisation (pour qu&#8217;il soit possible d&#8217;avoir un nombre importants de workers, et pouvoir faire en sorte qu&#8217;une tâche ne soit prise en compte que par <em>un seul</em> worker),</p>
</li>
<li>
<p>qui gère des notification pour être prévenu quand des tâches sont disponibles pour être exécutées (ce besoin peut être couvert en exécutant régulièrement du code qui vérifie si des  tâches sont en attente, mais un système de notification est en général plus rapide et plus économe en ressources).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour les logs de tâches exécutées, les contraintes sont plus faibles (même si on préfère tout de même éviter de perdre des données et que le système ne soit pas trop lent), on a surtout besoin d&#8217;un système qui permette de la recherche pour faciliter les investigations.</p>
</div>
<div class="paragraph">
<p>Il est possible d&#8217;utiliser deux systèmes différents pour les deux usages, par exemple pour les tâches pas encore lancées il est courant d&#8217;utiliser un bus de messages, car en plus du stockage il peut servir de médiateur entre un système qui créé des tâches et le moteur de tâches en fournissant une API facile à utiliser.</p>
</div>
<div class="paragraph">
<p>Il est également possible d&#8217;utiliser un seul système, par exemple une base de données SQL ou même une base de données comme Redis.</p>
</div>
</div>
<div class="sect2">
<h3 id="_les_technologies_du_projet">Les technologies du projet</h3>
<div class="paragraph">
<p>J&#8217;ai choisi d&#8217;utiliser PostgreSQL pour l&#8217;ensemble du stockage&#160;: le fonctionnement des transactions des bases de données SQL sera utile pour éviter la perte de données et gérer la parallélisation, et PostgreSQL fournit un système de notification permettant de répondre au troisième point.
Pour la recherche, les capacités d&#8217;indexation SQL seront bien suffisantes.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;accès aux données je vais utiliser un ORM.
Plutôt qu&#8217;ActiveRecord qui amène avec lui tout l&#8217;écosystème Rails, je vais utiliser <a href="http://sequel.jeremyevans.net">Sequel</a>.</p>
</div>
<div class="paragraph">
<p>Sequel n&#8217;est pas aussi complet qu&#8217;ActiveRecord mais il a trois avantages :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les API se ressemble pas mal</p>
</li>
<li>
<p>il embarque beaucoup moins de code</p>
</li>
<li>
<p>il permet de maîtriser le SQL généré de façon assez simple, alors qu&#8217;avec ActiveRecord c&#8217;est un peu moins naturel.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>J&#8217;ajoute donc les dépendances au Gemfile&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-n">source</span> <span class="tok-s1">&#39;https://rubygems.org&#39;</span>

<span class="tok-n">gem</span> <span class="tok-s1">&#39;rake&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;~&gt; 13.0&#39;</span>
<span class="tok-n">gem</span> <span class="tok-s1">&#39;sequel&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;~&gt; 5.34&#39;</span>
<span class="tok-n">gem</span> <span class="tok-s1">&#39;pg&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;~&gt; 1.2.3&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et je créé la base de donnée avec un accès pour le compte de l&#8217;application&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ createuser task_engine
$ createdb --owner<span class="tok-o">=</span>task_engine task_engine</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modéliser_et_créer_les_tâches">Modéliser et créer les tâches</h3>
<div class="paragraph">
<p>Pour commencer je vais m&#8217;intéresser aux tâches qui ne sont pas encore lancées.</p>
</div>
<div class="paragraph">
<p>Les tâches seront créées dans un état <code>waiting</code>, et passeront dans un état <code>running</code> lorsqu&#8217;un des worker du moteur de tâches les lancera.
Les tâches les plus anciennes seront choisies d&#8217;abord.
Après exécution, les tâches seront supprimées de la base (la gestion de l&#8217;historique sera faite plus tard).</p>
</div>
<div class="paragraph">
<p>Pour le moment je vais continuer d&#8217;utiliser les mêmes tâches qui se contentent de mettre le worker en attente, ce qui signifie que je n&#8217;ai pas à gérer de paramètres pour le moment.</p>
</div>
<div class="paragraph">
<p>Pour stocker l&#8217;état des tâches je vais utiliser un <a href="https://www.postgresql.org/docs/current/datatype-enum.html">type énuméré</a> (on dit aussi une énumération).
Un peu comme dans les langages comme C ou Java, cela signifie que la base de données pourra vérifier que les valeurs qu&#8217;on lui fournit seront valides (en cas de valeur inconnue la base renvoie une erreur), et que si dans le code Ruby et dans les requêtes on utilisera les valeur textuelles, en interne la base le stockera de manière efficace comme un nombre.</p>
</div>
<div class="paragraph">
<p>Voici la migration permettant de créer la table <code>tasks</code> (si vous avez l&#8217;habitude des migrations ActiveRecord, vous ne devriez pas être dépaysé·e)&#160;:</p>
</div>
<div class="listingblock">
<div class="title">migrations/01_create_tasks.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-c1"># Load enum-related methods</span>
    <span class="tok-n">extension</span> <span class="tok-ss">:pg_enum</span>

    <span class="tok-c1"># Declare the enum with the list of allowed values</span>
    <span class="tok-n">create_enum</span><span class="tok-p">(</span><span class="tok-ss">:task_status</span><span class="tok-p">,</span> <span class="tok-o">[</span><span class="tok-s1">&#39;waiting&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;running&#39;</span><span class="tok-o">]</span><span class="tok-p">)</span>

    <span class="tok-n">create_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">primary_key</span> <span class="tok-ss">:id</span>
      <span class="tok-c1"># The status column is using the task_status enum type</span>
      <span class="tok-n">task_status</span> <span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-ss">default</span><span class="tok-p">:</span> <span class="tok-s1">&#39;waiting&#39;</span>

      <span class="tok-no">DateTime</span> <span class="tok-ss">:created_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-no">DateTime</span> <span class="tok-ss">:updated_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Je peux ensuite la lancer (le <code>-m</code> indique à Sequel où se trouve le répertoire qui contient les migrations) &#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ sequel -m migrations postgres://task_engine@localhost/task_engine</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et vérifier que la table a bien été créée&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ psql --user<span class="tok-o">=</span>task_engine --dbname<span class="tok-o">=</span>task_engine --command<span class="tok-o">=</span><span class="tok-s2">&quot;\d tasks&quot;</span>
                                        Table <span class="tok-s2">&quot;public.tasks&quot;</span>
Column    <span class="tok-p">|</span>Type                       <span class="tok-p">|</span>Nullable<span class="tok-p">|</span>Default
----------+---------------------------+--------+---------------------------
id        <span class="tok-p">|</span>integer                    <span class="tok-p">|</span>not null<span class="tok-p">|</span>generated by default as id
status    <span class="tok-p">|</span>task_status                <span class="tok-p">|</span>not null<span class="tok-p">|</span><span class="tok-s1">&#39;waiting&#39;</span>::task_status
created_at<span class="tok-p">|</span>timestamp without <span class="tok-nb">time</span> zone<span class="tok-p">|</span>not null<span class="tok-p">|</span>
updated_at<span class="tok-p">|</span>timestamp without <span class="tok-nb">time</span> zone<span class="tok-p">|</span>not null<span class="tok-p">|</span>

Indexes:
    <span class="tok-s2">&quot;tasks_pkey&quot;</span> PRIMARY KEY, btree <span class="tok-o">(</span>id<span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour pouvoir manipuler les tâches il me reste à déclarer la connexion à la base et le modèle qui représente une tâche.</p>
</div>
<div class="paragraph">
<p>Lors de la configuration de l&#8217;accès à la base de donnée, j&#8217;indiquerai d&#8217;utiliser au maximum une connexion par worker plus une pour le moteur.
Cela permet que chaque worker ait une connexion à lui plutôt que de risquer que les workers ne s&#8217;attendent pour pouvoir faire des requêtes.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-nb">require</span> <span class="tok-s1">&#39;sequel&#39;</span>

<span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>

  <span class="tok-c1"># Database connexion path</span>
  <span class="tok-no">DATABASE_URL</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;postgres://task_engine@localhost/task_engine&#39;</span>
  <span class="tok-c1"># Open the connexions to the database</span>
  <span class="tok-c1"># Use at most one connexion per worker</span>
  <span class="tok-no">DB</span> <span class="tok-o">=</span> <span class="tok-o">::</span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">connect</span><span class="tok-p">(</span><span class="tok-no">DATABASE_URL</span><span class="tok-p">,</span> <span class="tok-ss">max_connexions</span><span class="tok-p">:</span> <span class="tok-no">WORKERS_NUMBER</span><span class="tok-p">,</span> <span class="tok-ss">logger</span><span class="tok-p">:</span> <span class="tok-no">LOGGER</span><span class="tok-p">)</span>

  <span class="tok-c1"># The `created_at` and `updated_at` attributes should be managed by Sequel</span>
  <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span><span class="tok-o">.</span><span class="tok-n">plugin</span> <span class="tok-ss">:timestamps</span><span class="tok-p">,</span> <span class="tok-ss">force</span><span class="tok-p">:</span> <span class="tok-kp">true</span><span class="tok-p">,</span> <span class="tok-ss">update_on_create</span><span class="tok-p">:</span> <span class="tok-kp">true</span>

  <span class="tok-k">class</span> <span class="tok-nc">Task</span> <span class="tok-o">&lt;</span> <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span>
    <span class="tok-no">STATUS_WAITING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span>
    <span class="tok-no">STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
  <span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Je peux alors définir une tâche Rake pour créer 100 tâches à exécuter&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Rakefile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-n">desc</span> <span class="tok-s1">&#39;Create tasks&#39;</span>
<span class="tok-n">task</span> <span class="tok-ss">:create_tasks</span> <span class="tok-k">do</span>
  <span class="tok-n">require_relative</span> <span class="tok-s1">&#39;task_engine&#39;</span>
  <span class="tok-mi">100</span><span class="tok-o">.</span><span class="tok-n">times</span> <span class="tok-k">do</span>
    <span class="tok-c1"># As tasks has no parameters and the default status is `waiting`</span>
    <span class="tok-c1"># we don&#39;t need to pass any parameter</span>
    <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">create</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et la lancer&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ rake create_tasks
<span class="tok-o">(</span><span class="tok-m">0</span>.000223s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.003092s<span class="tok-o">)</span> INSERT INTO <span class="tok-s2">&quot;tasks&quot;</span> <span class="tok-o">(</span><span class="tok-s2">&quot;created_at&quot;</span>, <span class="tok-s2">&quot;updated_at&quot;</span><span class="tok-o">)</span> VALUES <span class="tok-o">(</span><span class="tok-s1">&#39;2020-07-05 22:07:24.194778+0200&#39;</span>, <span class="tok-s1">&#39;2020-07-05 22:07:24.194778+0200&#39;</span><span class="tok-o">)</span> RETURNING *
<span class="tok-o">(</span><span class="tok-m">0</span>.001687s<span class="tok-o">)</span> COMMIT
<span class="tok-o">(</span><span class="tok-m">0</span>.000355s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.000634s<span class="tok-o">)</span> INSERT INTO <span class="tok-s2">&quot;tasks&quot;</span> <span class="tok-o">(</span><span class="tok-s2">&quot;created_at&quot;</span>, <span class="tok-s2">&quot;updated_at&quot;</span><span class="tok-o">)</span> VALUES <span class="tok-o">(</span><span class="tok-s1">&#39;2020-07-05 22:07:24.203529+0200&#39;</span>, <span class="tok-s1">&#39;2020-07-05 22:07:24.203529+0200&#39;</span><span class="tok-o">)</span> RETURNING *
<span class="tok-o">(</span><span class="tok-m">0</span>.000531s<span class="tok-o">)</span> COMMIT
<span class="tok-o">(</span><span class="tok-m">0</span>.000250s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.000543s<span class="tok-o">)</span> INSERT INTO <span class="tok-s2">&quot;tasks&quot;</span> <span class="tok-o">(</span><span class="tok-s2">&quot;created_at&quot;</span>, <span class="tok-s2">&quot;updated_at&quot;</span><span class="tok-o">)</span> VALUES <span class="tok-o">(</span><span class="tok-s1">&#39;2020-07-05 22:07:24.206371+0200&#39;</span>, <span class="tok-s1">&#39;2020-07-05 22:07:24.206371+0200&#39;</span><span class="tok-o">)</span> RETURNING *
<span class="tok-o">(</span><span class="tok-m">0</span>.000468s<span class="tok-o">)</span> COMMIT
<span class="tok-o">(</span><span class="tok-m">0</span>.000171s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.000351s<span class="tok-o">)</span> INSERT INTO <span class="tok-s2">&quot;tasks&quot;</span> <span class="tok-o">(</span><span class="tok-s2">&quot;created_at&quot;</span>, <span class="tok-s2">&quot;updated_at&quot;</span><span class="tok-o">)</span> VALUES <span class="tok-o">(</span><span class="tok-s1">&#39;2020-07-05 22:07:24.209080+0200&#39;</span>, <span class="tok-s1">&#39;2020-07-05 22:07:24.209080+0200&#39;</span><span class="tok-o">)</span> RETURNING *
<span class="tok-o">(</span><span class="tok-m">0</span>.000523s<span class="tok-o">)</span> COMMIT
<span class="tok-o">(</span><span class="tok-m">0</span>.000152s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.000324s<span class="tok-o">)</span> INSERT INTO <span class="tok-s2">&quot;tasks&quot;</span> <span class="tok-o">(</span><span class="tok-s2">&quot;created_at&quot;</span>, <span class="tok-s2">&quot;updated_at&quot;</span><span class="tok-o">)</span> VALUES <span class="tok-o">(</span><span class="tok-s1">&#39;2020-07-05 22:07:24.211112+0200&#39;</span>, <span class="tok-s1">&#39;2020-07-05 22:07:24.211112+0200&#39;</span><span class="tok-o">)</span> RETURNING *</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ne_pas_perdre_de_tâche">Ne pas perdre de tâche</h3>
<div class="paragraph">
<p>Il reste la part du lion qui est de mettre à jour le moteur pour qu&#8217;il s&#8217;appuie sur la base de données.</p>
</div>
<div class="paragraph">
<p>La partie la plus complexe est l&#8217;acquisition de tâches à exécuter.
Pour cela il faut sélectionner la tâche la plus ancienne, et changer son statut.</p>
</div>
<div class="paragraph">
<p>Mais comme plusieurs workers travaillent en parallèle, il faut faire en sorte que la même tâche ne soit pas prise en compte deux fois par deux workers.</p>
</div>
<div class="paragraph">
<p>Une chose importante dans le design des tâches&#160;: il est souhaitable&#8201;—&#160;tant que cela est possible&#160;—&#8201;qu&#8217;une même tâche puisse être exécutée plusieurs fois de suite sans que cela soit gênant.</p>
</div>
<div class="paragraph">
<p>Par exemple si une tâche est chargée d&#8217;envoyer un mail, si on l&#8217;exécute de nouveau il faudrait que le même mail ne soit pas envoyé une deuxième fois.</p>
</div>
<div class="paragraph">
<p>Cela vient du fait qu&#8217;il est très difficile de réunir deux conditions à la fois&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>faire en sorte que le moteur de tâches ne perde pas de tâche, pour faire en sorte que chaque tâche soit exécutée au moins une fois.</p>
</li>
<li>
<p>faire en sorte que le moteur de tâches n&#8217;exécute pas la même tâche deux fois, même en cas d&#8217;erreur ou de problème réseau où on se fait pas forcément si une exécution qu&#8217;on a demandé a vraiment en lieu.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dans les outils de messages, on appelle cela &#8220;<em>at least once</em>&#8221; (au moins une fois), &#8220;<em>at most once</em>&#8221; (au plus une fois) et &#8220;<em>exactly once</em>&#8221;.</p>
</div>
<div class="paragraph">
<p>Le moteur de tâches se contentera de faire en sorte que la même tâche ne soit pas exécutée deux fois.</p>
</div>
<div class="paragraph">
<p>Plutôt que d&#8217;essayer de faire en sorte d&#8217;avoir un système qui garantit du &#8220;<em>exactly once</em>&#8221;, on préfère que le moteur de tâches se concentre sur le fait de ne pas perdre de tâche, et si une même tâche est exécutée une deuxième fois c&#8217;est la tâche elle-même qui est chargée que cela n&#8217;ait pas d&#8217;effet gênant.</p>
</div>
<div class="paragraph">
<p>Cela permet d&#8217;obtenir le même objectif (que le traitement final se comporte comme s&#8217;il avait été exécuté une fois), tout en modifiant les contraintes&#160;: au lieu d&#8217;avoir toutes les contraintes au niveau du moteur de tâches, elles sont en partie au niveau du moteur de tâches et en partie au niveau des tâches en elles-mêmes.</p>
</div>
<div class="paragraph">
<p>L&#8217;autre avantage de cette approche est qu&#8217;en cas de gros problème, il devient possible de réinjecter dans le moteur de tâches des tâches passées et de les laisser les traiter, sans avoir à se préoccuper de celles qui avaient déjà été exécutées.</p>
</div>
</div>
<div class="sect2">
<h3 id="_verrou_et_transaction">Verrou et transaction</h3>
<div class="paragraph">
<p>Revenons à nos moutons&#160;:  sélectionner la tâche la plus ancienne et changer son statut, et empêcher qu&#8217;un autre thread ne fasse pareil.</p>
</div>
<div class="paragraph">
<p>En SQL pour cela on se sert de verrous (ou <em>locks</em>).
Lorsqu&#8217;un thread va sélectionner la tâche T1 à exécuter il va en même temps verrouiller cette tâche dans la base, de sorte que les autres threads qui cherchent aussi la tâche la plus ancienne et qui pourraient vouloir utiliser T1 ne puissent le faire.
Cela signifie que les autres workers seront bloqués en attendant que le verrou sur T1 soit relâché.
Après avoir mis à jour le statut de T1, on la déverrouillera dès que possible pour débloquer les autres threads.
À leur tour ils pourront chercher la tâche la plus ancienne à exécuter, qui sera donc la tâche suivante car le statut de T1 aura changé et elle ne sera donc plus sélectionnable pour eux.</p>
</div>
<div class="paragraph">
<p>Pour cela on va utiliser la commande <code>SELECT … FOR UPDATE</code>, qui verrouille les lignes sélectionnée en vue de pouvoir faire une mise à jour.</p>
</div>
<div class="paragraph">
<p>Le relâchement du verrou se fait à la fin de la transaction en cours, qui doit donc être terminée dès que possible pour limiter la période pendant laquelle les autres workers risquent d&#8217;être en attente.</p>
</div>
<div class="paragraph">
<p>L&#8217;acquisition de la tâche (sélection et mise à jour du statut) doivent de toutes façon se faire dans une transaction séparée de celle de l&#8217;exécution de la tâche&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pour l&#8217;acquisition soit immédiatement visible dans la base&#160;;</p>
</li>
<li>
<p>pour qu&#8217;en cas d&#8217;erreur dans le code de la tâche qui déclencherait un <code>rollback</code>, l&#8217;acquisition ne soit pas automatiquement annulée, ce qui rendrait plus difficile la reprise.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voici donc à quoi ressemble le code&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-c1"># @return [TaskEngine::Task, nil]</span>
<span class="tok-k">def</span> <span class="tok-nf">try_acquire_task</span>
  <span class="tok-c1"># The transaction start here and will end after the end of the block</span>
  <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
    <span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-no">Task</span>
      <span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_WAITING</span><span class="tok-p">)</span>
      <span class="tok-o">.</span><span class="tok-n">order</span><span class="tok-p">(</span><span class="tok-ss">:created_at</span><span class="tok-p">)</span>
      <span class="tok-o">.</span><span class="tok-n">for_update</span>
      <span class="tok-o">.</span><span class="tok-n">first</span>
    <span class="tok-k">unless</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">nil?</span>
      <span class="tok-no">Task</span>
        <span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">)</span>
        <span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span><span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_RUNNING</span><span class="tok-p">)</span>
      <span class="tok-n">task</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La méthode <code>try_acquire_task</code> retournera la tâche à exécuter ou <code>nil</code> si aucune tâche n&#8217;est disponible.</p>
</div>
<div class="paragraph">
<p>Lorsque l&#8217;exécution se termine, pas besoin de poser de verrou car il n&#8217;y a pas de risque qu&#8217;un autre worker veuille terminer la même tâche.
Par contre il est toujours nécessaire d&#8217;isoler le code dans une transaction à part, notamment pour qu&#8217;une erreur dans le moteur de tâches ne risque pas d&#8217;avoir de conséquence sur la tâche qui vient d&#8217;être exécutée.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-c1"># @param [TaskEngine::Task] task</span>
<span class="tok-k">def</span> <span class="tok-nf">end_task</span><span class="tok-p">(</span><span class="tok-n">task</span><span class="tok-p">)</span>
  <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
    <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">delete</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_la_nouvelle_boucle">La nouvelle boucle</h3>
<div class="paragraph">
<p>Reste ensuite à modifier <code>TaskEngine::Worker#exécute</code> pour utiliser ces deux méthodes&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">def</span> <span class="tok-nf">execute</span>
  <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-n">try_acquire_task</span><span class="tok-p">)</span>
    <span class="tok-n">starting_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
    <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> starting task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
    <span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">)</span>
    <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
    <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
    <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> finished task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">, took </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">end_task</span><span class="tok-p">(</span><span class="tok-n">task</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>
  <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is stopping&quot;</span><span class="tok-p">)</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tant qu&#8217;il reste des tâches, chaque worker les traitera les unes après les autres&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ rake
Starting engine
Starting worker <span class="tok-m">0</span>
Starting worker <span class="tok-m">1</span>
Starting worker <span class="tok-m">2</span>
Starting worker <span class="tok-m">3</span>
Starting worker <span class="tok-m">4</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.000731s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.001842s<span class="tok-o">)</span> SELECT <span class="tok-s2">&quot;id&quot;</span> FROM <span class="tok-s2">&quot;tasks&quot;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span><span class="tok-o">)</span> ORDER BY <span class="tok-s2">&quot;created_at&quot;</span> LIMIT <span class="tok-m">1</span> FOR UPDATE
<span class="tok-o">(</span><span class="tok-m">0</span>.000392s<span class="tok-o">)</span> UPDATE <span class="tok-s2">&quot;tasks&quot;</span> SET <span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;id&quot;</span> <span class="tok-o">=</span> <span class="tok-m">701</span><span class="tok-o">)</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.000818s<span class="tok-o">)</span> COMMIT
Worker <span class="tok-m">0</span> starting task <span class="tok-m">701</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.000286s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.000582s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.000642s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.004352s<span class="tok-o">)</span> SELECT <span class="tok-s2">&quot;id&quot;</span> FROM <span class="tok-s2">&quot;tasks&quot;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span><span class="tok-o">)</span> ORDER BY <span class="tok-s2">&quot;created_at&quot;</span> LIMIT <span class="tok-m">1</span> FOR UPDATE
<span class="tok-o">(</span><span class="tok-m">0</span>.001839s<span class="tok-o">)</span> UPDATE <span class="tok-s2">&quot;tasks&quot;</span> SET <span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;id&quot;</span> <span class="tok-o">=</span> <span class="tok-m">702</span><span class="tok-o">)</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.000183s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.001389s<span class="tok-o">)</span> COMMIT
Worker <span class="tok-m">2</span> starting task <span class="tok-m">702</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.008252s<span class="tok-o">)</span> SELECT <span class="tok-s2">&quot;id&quot;</span> FROM <span class="tok-s2">&quot;tasks&quot;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span><span class="tok-o">)</span> ORDER BY <span class="tok-s2">&quot;created_at&quot;</span> LIMIT <span class="tok-m">1</span> FOR UPDATE
<span class="tok-o">(</span><span class="tok-m">0</span>.000682s<span class="tok-o">)</span> UPDATE <span class="tok-s2">&quot;tasks&quot;</span> SET <span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;id&quot;</span> <span class="tok-o">=</span> <span class="tok-m">703</span><span class="tok-o">)</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.000644s<span class="tok-o">)</span> COMMIT
Worker <span class="tok-m">4</span> starting task <span class="tok-m">703</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.008829s<span class="tok-o">)</span> SELECT <span class="tok-s2">&quot;id&quot;</span> FROM <span class="tok-s2">&quot;tasks&quot;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span><span class="tok-o">)</span> ORDER BY <span class="tok-s2">&quot;created_at&quot;</span> LIMIT <span class="tok-m">1</span> FOR UPDATE
<span class="tok-o">(</span><span class="tok-m">0</span>.000422s<span class="tok-o">)</span> UPDATE <span class="tok-s2">&quot;tasks&quot;</span> SET <span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;id&quot;</span> <span class="tok-o">=</span> <span class="tok-m">704</span><span class="tok-o">)</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.000721s<span class="tok-o">)</span> COMMIT
Worker <span class="tok-m">3</span> starting task <span class="tok-m">704</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.005337s<span class="tok-o">)</span> SELECT <span class="tok-s2">&quot;id&quot;</span> FROM <span class="tok-s2">&quot;tasks&quot;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span><span class="tok-o">)</span> ORDER BY <span class="tok-s2">&quot;created_at&quot;</span> LIMIT <span class="tok-m">1</span> FOR UPDATE
<span class="tok-o">(</span><span class="tok-m">0</span>.000946s<span class="tok-o">)</span> UPDATE <span class="tok-s2">&quot;tasks&quot;</span> SET <span class="tok-s2">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;id&quot;</span> <span class="tok-o">=</span> <span class="tok-m">705</span><span class="tok-o">)</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.000791s<span class="tok-o">)</span> COMMIT
Worker <span class="tok-m">1</span> starting task <span class="tok-m">705</span>
Worker <span class="tok-m">0</span> finished task <span class="tok-m">701</span>, took <span class="tok-m">5002</span>.389ms
<span class="tok-o">(</span><span class="tok-m">0</span>.000386s<span class="tok-o">)</span> BEGIN
<span class="tok-o">(</span><span class="tok-m">0</span>.000475s<span class="tok-o">)</span> DELETE FROM <span class="tok-s2">&quot;tasks&quot;</span> WHERE <span class="tok-o">(</span><span class="tok-s2">&quot;id&quot;</span> <span class="tok-o">=</span> <span class="tok-m">701</span><span class="tok-o">)</span>
<span class="tok-o">(</span><span class="tok-m">0</span>.000540s<span class="tok-o">)</span> COMMIT</code></pre>
</div>
</div>
<div class="paragraph">
<p>À cette étape le noyau du système est là&#160;: on peut créer des tâches et quand on le lance le moteur va les exécuter jusqu&#8217;à épuisement.</p>
</div>
<div class="paragraph">
<p>Dans la partie suivante je vais m&#8217;intéresser à l&#8217;arrêt du moteur.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-04">Partie 4 : l&#8217;arrêt</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_pourquoi_lextinction_est_importante">Pourquoi l&#8217;extinction est importante</h3>
<div class="paragraph">
<p>Après l&#8217;avoir lancé, voici ce qui se passe quand on éteint le moteur de tâches en appuyant sur <code>CONTROL</code>+<code>C</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Worker 2 starting task 844
(0.006916s) SELECT * FROM &quot;tasks&quot; WHERE (&quot;status&quot; = &#39;waiting&#39;) ORDER BY &quot;created_at&quot; LIMIT 1 FOR UPDATE
(0.000322s) UPDATE &quot;tasks&quot; SET &quot;status&quot; = &#39;running&#39; WHERE (&quot;id&quot; = 845)
(0.000481s) COMMIT
Worker 1 starting task 845
^Crake aborted!
Interrupt:
/task-engine-ruby/task_engine.rb:35:in `sleep&#39;
/task-engine-ruby/task_engine.rb:35:in `initialize&#39;
/task-engine-ruby/Rakefile:4:in `new&#39;
/task-engine-ruby/Rakefile:4:in `block in &lt;top (required)&gt;&#39;
Tasks: TOP =&gt; default =&gt; start_engine
(See full trace by running task with --trace)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le moteur de tâches s&#8217;arrête immédiatement et toutes les tâches s&#8217;arrêtent net.</p>
</div>
<div class="paragraph">
<p>Si on voulait utiliser ce type de fonctionnement dans un moteur de tâches en production, cela signifie que toutes les tâches doivent être développées de manière à ce qu&#8217;elles puissent être arrêté net n&#8217;importe quand.</p>
</div>
<div class="paragraph">
<p>Si les tâches n&#8217;utilisent que la base de données, cela peut être envisageable car alors la transaction est annulée, et quand on les relance elles recommencent de zéro.</p>
</div>
<div class="paragraph">
<p>Mais dès lors qu&#8217;elles communiquent avec l&#8217;extérieur les choses deviennent plus compliquées.</p>
</div>
<div class="paragraph">
<p>Par exemple si une tâches chargée d&#8217;envoyer un mail puis de mettre à jour la base de donnée pour indiquer que le mail est parti est arrêtée juste après l&#8217;envoi du mail.</p>
</div>
<div class="paragraph">
<p>Au redémarrage du moteur de tâches si la tâche est relancée elle enverrait un autre mail identique.</p>
</div>
<div class="paragraph">
<p>C&#8217;est pour cela qu&#8217;en général, lorsqu&#8217;un moteur de tâches reçoit une commande d&#8217;arrêt, au lieu de stopper les tâches en cours, il ne démarre plus de nouvelles tâches et attend pour s&#8217;éteindre que les tâches déjà lancées se terminent.</p>
</div>
<div class="paragraph">
<p>Cela signifie que dans les conditions normales d&#8217;opérations d&#8217;un arrêt/relance, les tâches peuvent s&#8217;appuyer sur l&#8217;hypothèse qu&#8217;elles ne seront pas stoppées en cours de route.</p>
</div>
<div class="paragraph">
<p>Je parle de conditions normale car un cas exceptionnel est toujours possible, de la même manière que n&#8217;importe quel programme, par exemple une machine virtuelle qui crashe. Cela signifie que le risque existe toujours, même s&#8217;il est faible.</p>
</div>
<div class="paragraph">
<p>Pour une tâche qui envoie un mail, il est peut-être acceptable qu&#8217;en cas de crash le mail soit envoyé deux fois, par contre pour une tâche qui fait un virement entre deux comptes bancaires, il vaut peut-être mieux se prémunir contre le risque que le virement soit effectué deux fois même si le risque de crash est faible.</p>
</div>
</div>
<div class="sect2">
<h3 id="_les_signaux">Les signaux</h3>
<div class="paragraph">
<p>Pour exécuter du code lorsqu&#8217;un programme s&#8217;arrête, il faut généralement indiquer au système qu&#8217;en cas de demande d&#8217;arrêt il doit exécuter un bloc de code ou une méthode spécifique plutôt que d&#8217;utiliser le comportement par défaut qui est de tout stopper d&#8217;un coup.</p>
</div>
<div class="paragraph">
<p>Sur les systèmes d&#8217;exploitations comme Linux ou macOS, la demande d&#8217;arrêt (par exemple lorsque vous appuyez sur <code>CONTROL</code>+<code>C</code>) est communiquée au programme sous forme d&#8217;un <a href="https://fr.wikipedia.org/wiki/Signal_(informatique)">signal</a>.
Un programme peut informer le système d&#8217;exploitation que tel ou tel signal l&#8217;intéresse, et qu&#8217;il prend la responsabilité de répondre au signal, en remplacement du comportement par défaut.</p>
</div>
<div class="paragraph">
<p>Il existe différents signaux identifiés chacun par un nom et un numéro, certains sont normalisés et correspondent aux messages que le système avait besoin d&#8217;envoyer dans les systèmes UNIX classiques et d&#8217;autres sont dépendants du système d&#8217;exploitation.</p>
</div>
<div class="paragraph">
<p>Pour gérer une fin d&#8217;exécution, il faut en principe écouter deux signaux qui font partie de ceux qui sont normalisés&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SIGTERM</code> (pour <em>termination</em>) qui porte le numéro 15 et qui indique que le programme à qui on envoie le signal doit s&#8217;arrêter.</p>
</li>
<li>
<p><code>SIGINT</code> (pour <em>interrupt</em>) qui porte le numéro 2 et qui est envoyé lorsqu&#8217;on appuie sur <code>CONTROL</code>+<code>C</code> dans un terminal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le comportement est souvent le même pour les deux signaux.</p>
</div>
<div class="paragraph">
<p>En Ruby, pour définir un bloc de code à appeler quand un signal est reçu il faut appeler la méthode <code>Signal::trap</code> en lui passant en paramètre le nom ou le numéro du signal&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Signal</span><span class="tok-o">.</span><span class="tok-n">trap</span><span class="tok-p">(</span><span class="tok-s1">&#39;SIGTERM&#39;</span><span class="tok-p">)</span> <span class="tok-k">do</span>
  <span class="tok-c1"># TODO: implement signal handling</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>À noter que le code appelé lors de la réception d&#8217;un signal n&#8217;est pas du code comme les autres car le système d&#8217;exploitation utilise des routines spécifiques pour appelle ce code et il s&#8217;exécute dans un contexte un peu spécial, et ce faisant certaines fonctionnalités qu&#8217;on tient normalement pour acquises sont indisponibles.</p>
</div>
<div class="paragraph">
<p>Cela signifie qu&#8217;il doit respecter certaines règles pour ne pas poser de problème au système d&#8217;exploitation et faite crasher l&#8217;application.
Ainsi en théorie les allocation mémoire ou les entrées/sorties sont interdites.</p>
</div>
<div class="paragraph">
<p>Par exemple si le système d&#8217;exploitation décide d&#8217;arrêter un processus car sa mémoire est devenue insuffisante, si le code gérant l&#8217;arrêt essaie d&#8217;allouer de la mémoire supplémentaire cela ne fonctionnera pas.</p>
</div>
<div class="paragraph">
<p>En pratique il est possible que cela ne pose pas problème, même dans la très grande majorité des cas, mais vous n&#8217;avez aucune garantie.</p>
</div>
<div class="paragraph">
<p>Par exemple si vous essayer d&#8217;utiliser un log dans un code de gestion de signal&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-nb">require</span> <span class="tok-s1">&#39;logger&#39;</span>

<span class="tok-no">LOGGER</span> <span class="tok-o">=</span> <span class="tok-no">Logger</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-no">STDOUT</span><span class="tok-p">)</span>

<span class="tok-no">Signal</span><span class="tok-o">.</span><span class="tok-n">trap</span><span class="tok-p">(</span><span class="tok-s1">&#39;SIGTERM&#39;</span><span class="tok-p">)</span> <span class="tok-k">do</span>
  <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Received a SIGTERM signal&#39;</span><span class="tok-p">)</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ruby vous indiquera que cela ne fonctionnera pas par un &#8220;log writing failed. can't be called from trap context&#8221;, car pour éviter le risque que cet appel fasse crasher le programme, la machine virtuelle Ruby le désactive dans ce contexte.</p>
</div>
<div class="paragraph">
<p>La bonne pratique est donc de limiter au maximum ce que vous mettez dans le bloc de gestion de signal, par exemple d&#8217;uniquement changer la valeur d&#8217;une variable, et de faire en sorte que le vrai traitement se fasse en dehors du bloc.</p>
</div>
</div>
<div class="sect2">
<h3 id="_le_signal_darrêt_dans_le_moteur_de_tâches">Le signal d&#8217;arrêt dans le moteur de tâches</h3>
<div class="paragraph">
<p>Dans le moteur de tâches, chaque worker exécute une boucle où il essaie de trouver une tâche à exécuter puis la lance&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">def</span> <span class="tok-nf">execute</span>
  <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-n">try_acquire_task</span><span class="tok-p">)</span>
    <span class="tok-c1"># …</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour gérer l&#8217;extinction, le bloc de gestion de signal va donc changer la valeur d&#8217;une variable, et à chaque tour de boucle le worker va vérifier s&#8217;il faut s&#8217;arrêter.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">def</span> <span class="tok-nf">execute</span>
  <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-no">RUNNING</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-p">(</span><span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-n">try_acquire_task</span><span class="tok-p">)</span>
    <span class="tok-c1"># …</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui peut se traduire par&#160;:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuNDQuMSAoMjAyMDA2MjkuMDg0NikKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIzMDlwdCIgaGVpZ2h0PSIzMDlwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAzMDkuMTQgMzA4Ljc0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDMwNC43NCkiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IndoaXRlIiBzdHJva2U9InRyYW5zcGFyZW50IiBwb2ludHM9Ii00LDQgLTQsLTMwNC43NCAzMDUuMTQsLTMwNC43NCAzMDUuMTQsNCAtNCw0Ii8+CjwhLS0gbjEgLS0+CjxnIGlkPSJub2RlMSIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjE8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMTE2LjE0IiBjeT0iLTI4Mi43NCIgcng9IjEwOS4zOCIgcnk9IjE4Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjExNi4xNCIgeT0iLTI3OS4wNCIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5BcnLDqnQgZHUgbW90ZXVyIGRlbWFuZMOpID88L3RleHQ+CjwvZz4KPCEtLSBuMiAtLT4KPGcgaWQ9Im5vZGUyIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5uMjwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSIxMTYuMTQiIGN5PSItMTg2Ljg3IiByeD0iNzIuNjYiIHJ5PSIyNi43NCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxMTYuMTQiIHk9Ii0xOTAuNjciIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+UHJvY2hhaW5lIHTDomNoZTwvdGV4dD4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTE2LjE0IiB5PSItMTc1LjY3IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPsOgIGV4w6ljdXRlciA/PC90ZXh0Pgo8L2c+CjwhLS0gbjEmIzQ1OyZndDtuMiAtLT4KPGcgaWQ9ImVkZ2UxIiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uMSYjNDU7Jmd0O24yPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTExNi4xNCwtMjY0LjUyQzExNi4xNCwtMjUzLjIyIDExNi4xNCwtMjM4LjAxIDExNi4xNCwtMjI0LjEyIi8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjExOS42NCwtMjIzLjg0IDExNi4xNCwtMjEzLjg0IDExMi42NCwtMjIzLjg0IDExOS42NCwtMjIzLjg0Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjEyOC4xNCIgeT0iLTIzNS41NCIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5Ob248L3RleHQ+CjwvZz4KPCEtLSBuMyAtLT4KPGcgaWQ9Im5vZGUzIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5uMzwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSI3Mi4xNCIgY3k9Ii0xOCIgcng9IjcyLjI5IiByeT0iMTgiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNzIuMTQiIHk9Ii0xNC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkFycsOqdGVyIGxlIHdvcmtlcjwvdGV4dD4KPC9nPgo8IS0tIG4xJiM0NTsmZ3Q7bjMgLS0+CjxnIGlkPSJlZGdlMiIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+bjEmIzQ1OyZndDtuMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik04NS4yLC0yNjUuNDFDNjYuNjYsLTI1My43NSA0NC42OCwtMjM2LjE3IDM0LjE0LC0yMTMuNzQgNy42OCwtMTU3LjQxIDM3LjUsLTgzLjU4IDU3LjM0LC00NS4wMiIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSI2MC41MywtNDYuNDggNjIuMTMsLTM2LjAxIDU0LjM1LC00My4yIDYwLjUzLC00Ni40OCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIzOC42NCIgeT0iLTEzMC44IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPk91aTwvdGV4dD4KPC9nPgo8IS0tIG4yJiM0NTsmZ3Q7bjMgLS0+CjxnIGlkPSJlZGdlMyIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+bjImIzQ1OyZndDtuMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0xMDEuOTYsLTE2MC4zM0M5NC41MSwtMTQ1Ljc0IDg1Ljk2LC0xMjYuODQgODEuMTQsLTEwOSA3NS42LC04OC40NCA3My40LC02NC40IDcyLjU2LC00Ni4zNSIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSI3Ni4wNiwtNDYuMDkgNzIuMiwtMzYuMjIgNjkuMDYsLTQ2LjM0IDc2LjA2LC00Ni4wOSIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI5OS4xNCIgeT0iLTk0LjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+UGFzIGRlPC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI5OS4xNCIgeT0iLTc5LjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+dMOiY2hlPC90ZXh0Pgo8L2c+CjwhLS0gbjQgLS0+CjxnIGlkPSJub2RlNCIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjQ8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMTk3LjE0IiBjeT0iLTkxIiByeD0iNzEuNDkiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxOTcuMTQiIHk9Ii04Ny4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkV4w6ljdXRlciBsYSB0w6JjaGU8L3RleHQ+CjwvZz4KPCEtLSBuMiYjNDU7Jmd0O240IC0tPgo8ZyBpZD0iZWRnZTQiIGNsYXNzPSJlZGdlIj4KPHRpdGxlPm4yJiM0NTsmZ3Q7bjQ8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMTE5LjE2LC0xNTkuNzdDMTIxLjUxLC0xNDguNzMgMTI1LjY5LC0xMzYuMyAxMzMuMTQsLTEyNyAxMzcuODgsLTEyMS4wOSAxNDMuOSwtMTE2LjAzIDE1MC4zNCwtMTExLjc1Ii8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjE1Mi41MiwtMTE0LjUyIDE1OS4zLC0xMDYuMzggMTQ4LjkzLC0xMDguNTEgMTUyLjUyLC0xMTQuNTIiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTcyLjE0IiB5PSItMTMwLjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+VMOiY2hlIHRyb3V2w6llPC90ZXh0Pgo8L2c+CjwhLS0gbjQmIzQ1OyZndDtuMSAtLT4KPGcgaWQ9ImVkZ2U1IiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uNCYjNDU7Jmd0O24xPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTIwNS40NywtMTA5LjA1QzIwNy43OCwtMTE0LjY0IDIwOS45OCwtMTIwLjk2IDIxMS4xNCwtMTI3IDIxOC41MiwtMTY1LjI4IDIxNy44MSwtMTgwLjA4IDE5OC4xNCwtMjEzLjc0IDE4Ny4zNCwtMjMyLjIzIDE2OS41MywtMjQ3LjkxIDE1My4yNiwtMjU5LjU0Ii8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjE1MS4yMSwtMjU2LjcgMTQ0Ljk0LC0yNjUuMjQgMTU1LjE3LC0yNjIuNDcgMTUxLjIxLC0yNTYuNyIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyNTguNjQiIHk9Ii0xODMuMTciIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+VMOiY2hlIGV4w6ljdXTDqWU8L3RleHQ+CjwvZz4KPCEtLSBuNCYjNDU7Jmd0O24zIC0tPgo8L2c+Cjwvc3ZnPgo=" alt="workflow 4 1">
</div>
</div>
<div class="paragraph">
<p>Ce statut va être stocké dans l&#8217;instance de <code>TaskEngine::Engine</code>, auquel les workers vont accéder&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">Engine</span>
  <span class="tok-no">ENGINE_STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
  <span class="tok-no">ENGINE_STATUS_STOPPING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;stopping&#39;</span>

  <span class="tok-kp">attr_reader</span> <span class="tok-ss">:status</span>

  <span class="tok-k">def</span> <span class="tok-nf">initialize</span>
    <span class="tok-vi">@workers</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
    <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Starting engine&#39;</span><span class="tok-p">)</span>
    <span class="tok-vi">@status</span> <span class="tok-o">=</span> <span class="tok-no">ENGINE_STATUS_RUNNING</span>
    <span class="tok-no">Signal</span><span class="tok-o">.</span><span class="tok-n">trap</span><span class="tok-p">(</span><span class="tok-s1">&#39;SIGTERM&#39;</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">signal_trap</span>
    <span class="tok-k">end</span>
    <span class="tok-no">Signal</span><span class="tok-o">.</span><span class="tok-n">trap</span><span class="tok-p">(</span><span class="tok-s1">&#39;SIGINT&#39;</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">signal_trap</span>
    <span class="tok-k">end</span>
    <span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">upto</span><span class="tok-p">(</span><span class="tok-no">WORKERS_NUMBER</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">worker_index</span><span class="tok-o">|</span>
      <span class="tok-no">Worker</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-nb">self</span><span class="tok-p">,</span> <span class="tok-n">worker_index</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
    <span class="tok-nb">sleep</span>
  <span class="tok-k">end</span>

  <span class="tok-k">def</span> <span class="tok-nf">signal_trap</span>
    <span class="tok-vi">@status</span> <span class="tok-o">=</span> <span class="tok-no">ENGINE_STATUS_STOPPING</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-k">class</span> <span class="tok-nc">Worker</span>
  <span class="tok-c1"># @param [TaskEngine::Engine] engine</span>
  <span class="tok-c1"># @param [Integer] worker_index</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">engine</span><span class="tok-p">,</span> <span class="tok-n">worker_index</span><span class="tok-p">)</span>
    <span class="tok-vi">@engine</span> <span class="tok-o">=</span> <span class="tok-n">engine</span>
    <span class="tok-vi">@worker_index</span> <span class="tok-o">=</span> <span class="tok-n">worker_index</span>
    <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Starting worker </span><span class="tok-si">#{</span><span class="tok-n">worker_index</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
    <span class="tok-vi">@thread</span> <span class="tok-o">=</span> <span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
      <span class="tok-n">execute</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>

  <span class="tok-k">def</span> <span class="tok-nf">execute</span>
    <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">Engine</span><span class="tok-o">::</span><span class="tok-no">ENGINE_STATUS_RUNNING</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span>
        <span class="tok-p">(</span><span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-n">try_acquire_task</span><span class="tok-p">)</span>
      <span class="tok-n">starting_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> starting task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
      <span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">)</span>
      <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
      <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> finished task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">, took </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms&quot;</span><span class="tok-p">)</span>
      <span class="tok-n">end_task</span><span class="tok-p">(</span><span class="tok-n">task</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
    <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is stopping&quot;</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>
<span class="tok-c1"># …</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lorsque le thread du worker n&#8217;a plus rien à faire, il s&#8217;arrête&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Worker 2 starting task 850
^CWorker 0 finished task 846, took 5005.947ms
(0.000379s) BEGIN
(0.000607s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 846)
(0.001182s) COMMIT
Worker 0 is stopping
Worker 3 finished task 847, took 5005.294ms
Worker 1 finished task 848, took 5002.687ms
(0.000278s) BEGIN
(0.000632s) BEGIN
(0.000560s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 848)
(0.000462s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 847)
(0.000455s) COMMIT
Worker 1 is stopping
(0.000555s) COMMIT
Worker 3 is stopping
Worker 4 finished task 849, took 5004.507ms
(0.000166s) BEGIN
(0.000324s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 849)
Worker 2 finished task 850, took 5003.889ms
(0.000172s) BEGIN
(0.000671s) COMMIT
Worker 4 is stopping
(0.000354s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 850)
(0.000449s) COMMIT
Worker 2 is stopping</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sarrêter_vraiment">S&#8217;arrêter vraiment</h3>
<div class="paragraph">
<p>Après avoir appuyé sur sur <code>CONTROL</code>+<code>C</code>, les différents workers s&#8217;arrêtent après avoir terminé l&#8217;exécution de leurs tâches, mais le moteur de tâches lui ne s&#8217;arrête pas.</p>
</div>
<div class="paragraph">
<p>D&#8217;autres appuis sur <code>CONTROL</code>+<code>C</code> ne servent à rien.</p>
</div>
<div class="paragraph">
<p>Le problème c&#8217;est le thread principal qui est celui qui démarre du moteur.</p>
</div>
<div class="paragraph">
<p>Après avoir créé les différents worker, le thread principal se met en attente pour une durée indéfinie et ne s&#8217;arrête donc jamais, et il est de même pour le moteur de tâches.</p>
</div>
<div class="paragraph">
<p>On pourrait vouloir arrêter ce thread dans le code de traitement du signal, mais cela aurait pour effet d&#8217;arrêter immédiatement le programme, sans laisser aux workers la possibilité de terminer leurs traitements.</p>
</div>
<div class="paragraph">
<p>Il faut donc que le thread principal se termine après la fin de l&#8217;exécution de l&#8217;ensemble des tâches en cours, c&#8217;est à dire quand les threads correspondant aux différents workers se sont terminés.</p>
</div>
<div class="paragraph">
<p>Dans l&#8217;API des thread <code>Thread#join</code> permet justement de suspendre l&#8217;activité d&#8217;un thread en attendant qu&#8217;un autre thread se termine.
L&#8217;idée est d&#8217;attendre les threads de tous les workers l&#8217;un après l&#8217;autre.
Si un thread est déjà arrêté lorsqu&#8217;on appelle <code>Thread#join</code> sur lui, la méthode retourne immédiatement.
Cela signifie qu&#8217;il n&#8217;y a pas à se préoccuper de savoir si un worker a déjà terminé ou pas avant de faire l&#8217;appel à <code>join</code>.</p>
</div>
<div class="paragraph">
<p>Lorsqu&#8217;on démarre les worker, il faut donc les stocker les différentes instances pour pouvoir ensuite accéder à leurs threads, et plutôt que d&#8217;appeler <code>Kernel#sleep</code>, le moteur attendra la fin du premier thread.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">Engine</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span>
    <span class="tok-vi">@workers</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
    <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Starting engine&#39;</span><span class="tok-p">)</span>
    <span class="tok-vi">@status</span> <span class="tok-o">=</span> <span class="tok-no">ENGINE_STATUS_RUNNING</span>
    <span class="tok-no">Signal</span><span class="tok-o">.</span><span class="tok-n">trap</span><span class="tok-p">(</span><span class="tok-s1">&#39;SIGTERM&#39;</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-vi">@status</span> <span class="tok-o">=</span> <span class="tok-no">ENGINE_STATUS_STOPPING</span>
    <span class="tok-k">end</span>
    <span class="tok-no">Signal</span><span class="tok-o">.</span><span class="tok-n">trap</span><span class="tok-p">(</span><span class="tok-s1">&#39;SIGINT&#39;</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-vi">@status</span> <span class="tok-o">=</span> <span class="tok-no">ENGINE_STATUS_STOPPING</span>
    <span class="tok-k">end</span>
    <span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">upto</span><span class="tok-p">(</span><span class="tok-no">WORKERS_NUMBER</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">worker_index</span><span class="tok-o">|</span>
      <span class="tok-vi">@workers</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-no">Worker</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-nb">self</span><span class="tok-p">,</span> <span class="tok-n">worker_index</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
    <span class="tok-vi">@workers</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">worker</span><span class="tok-o">|</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Joining worker </span><span class="tok-si">#{</span><span class="tok-n">worker</span><span class="tok-o">.</span><span class="tok-n">worker_index</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
      <span class="tok-n">worker</span><span class="tok-o">.</span><span class="tok-n">thread</span><span class="tok-o">.</span><span class="tok-n">join</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-k">class</span> <span class="tok-nc">Worker</span>
  <span class="tok-kp">attr_reader</span> <span class="tok-ss">:thread</span><span class="tok-p">,</span> <span class="tok-ss">:worker_index</span>

  <span class="tok-c1"># @param [TaskEngine::Engine] engine</span>
  <span class="tok-c1"># @param [Integer] worker_index</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">engine</span><span class="tok-p">,</span> <span class="tok-n">worker_index</span><span class="tok-p">)</span>
    <span class="tok-vi">@engine</span> <span class="tok-o">=</span> <span class="tok-n">engine</span>
    <span class="tok-vi">@worker_index</span> <span class="tok-o">=</span> <span class="tok-n">worker_index</span>
    <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Starting worker </span><span class="tok-si">#{</span><span class="tok-n">worker_index</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
    <span class="tok-vi">@thread</span> <span class="tok-o">=</span> <span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
      <span class="tok-n">execute</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
  <span class="tok-c1"># …</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Starting engine
Starting worker 0
Starting worker 1
Starting worker 2
Starting worker 3
Starting worker 4
Joining worker 0

^CWorker 0 finished task 861, took 5005.397ms
(0.000375s) BEGIN
(0.000547s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 861)
(0.001102s) COMMIT
Worker 0 is stopping
Joining worker 1
Worker 4 finished task 862, took 5002.765ms
Worker 1 finished task 863, took 5001.1179999999995ms
(0.000435s) BEGIN
(0.000862s) BEGIN
(0.000574s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 862)
(0.000673s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 863)
(0.000756s) COMMIT
Worker 4 is stopping
(0.000675s) COMMIT
Worker 1 is stopping
Joining worker 2
Worker 2 finished task 864, took 5004.611ms
(0.000432s) BEGIN
(0.000701s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 864)
(0.000766s) COMMIT
Worker 2 is stopping
Joining worker 3
Worker 3 finished task 865, took 5005.013ms
(0.000240s) BEGIN
(0.000531s) DELETE FROM &quot;tasks&quot; WHERE (&quot;id&quot; = 865)
(0.000592s) COMMIT
Worker 3 is stopping
Joining worker 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Après réception du signal, on voit que le thread de moteur attend successivement les différents worker pour ensuite arriver au bout de la méthode <code>TaskEngine::Engine#initialize</code>, ce qui stoppe le programme.</p>
</div>
<div class="paragraph">
<p>Cela règle le cas où le moteur de tâches s&#8217;arrête bien, je vais maintenant m&#8217;occuper de ce qui se passe après un arrêt d&#8217;urgence.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-05">Partie 5 : le redémarrage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_la_théorie">La théorie</h3>
<div class="paragraph">
<p>Le cas de l&#8217;arrêt dans une situation normale est donc couvert.
Reste celui de l&#8217;arrêt exceptionnel.</p>
</div>
<div class="paragraph">
<p>Cela peut correspondre à une machine virtuelle qui crashe, un bug qui fait planter la machine virtuelle Ruby.
Cela peut aussi être une conséquence d&#8217;un arrêt normal qui ne s&#8217;est pas bien terminé.</p>
</div>
<div class="paragraph">
<p>En effet si une tâche reste bloquée, par exemple parce qu&#8217;un appel réseau n&#8217;a pas de timeout en cas de non réponse, une tâche peut rester bloquée indéfiniment, et donc empêcher le moteur de tâches de s&#8217;arrêter.</p>
</div>
<div class="paragraph">
<p>Pour le stopper, on peut utiliser un autre signal, typiquement <code>SIGKILL</code> (qui lui ne peut pas être intercepté par du code applicatif:&#160;c&#8217;est le système d&#8217;exploitation qui se charge de faire le ménage lui-même).
Ce signal portant le numéro 9, c&#8217;est lui qui est envoyé quand on appelle <code>kill -9</code>.</p>
</div>
<div class="paragraph">
<p>Dans ce cas le programme s&#8217;arrête net et avec lui les tâches en cours d&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>Avec l&#8217;implémentation actuelle du moteur de tâches, ces tâches restent définies comme étant dans l&#8217;état <code>running</code>. Par exemple voici le résultat obtenu en stoppant brutalement le code précédent où le thread principal ne s&#8217;arrêtait pas&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ psql --user=task_engine --dbname=task_engine  --expanded --command=&quot;select * from tasks&quot;

-[ RECORD 1 ]---+-------------------------------
id              | 211
status          | running
created_at      | 2020-08-10 16:52:50.219772
updated_at      | 2020-08-10 16:52:50.219772
-[ RECORD 2 ]---+-------------------------------
id              | 212
status          | waiting
created_at      | 2020-08-10 16:52:50.221219
updated_at      | 2020-08-10 16:52:50.221219
instance        | running</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela signifie qu&#8217;il est difficile de différencier les tâches mal arrêtées de celles qui tournent réellement.</p>
</div>
<div class="paragraph">
<p>Il est possible d&#8217;aller chercher dans les logs pour déterminer les tâches qui ont été lancées et qui n&#8217;ont pas été terminées avant l&#8217;arrêt, mais c&#8217;est une approche artisanale alors que pour la gestion d&#8217;erreur je préfère des solutions les plus fiables possibles.</p>
</div>
<div class="paragraph">
<p>Pour identifier ces tâches, il faut pourvoir déterminer qu&#8217;elles appartiennent à l&#8217;instance de moteur de tâches qui a été arrêté de manière brutale.
Une manière d&#8217;y parvenir est de stocker dans les tâches quelle instance du moteur de tâches est en train de les exécuter en ajoutant un identifiant.</p>
</div>
<div class="paragraph">
<p>Lorsque l&#8217;instance est plantée, on peut alors facilement identifier ces tâches.
Au redémarrage, l&#8217;instance du moteur de tâches peut détecter qu&#8217;il existe des tâches marquée <code>running</code> qui portent son identifiant.</p>
</div>
<div class="paragraph">
<p>Cette approche aide aussi aux investigations pendant l&#8217;exécution d&#8217;une tâche&#160;: si une tâche est lente on peut aller consulter le monitoring de la machine sur laquelle elle est lancée pour voir si on voit quelque chose d&#8217;anormal.</p>
</div>
<div class="paragraph">
<p>Le plus simple, si un moteur de tâches démarre et trouve des tâches en statut <code>running</code> est alors de stopper immédiatement le moteur de tâches en indiquant explicitement quel est le problème.</p>
</div>
<div class="paragraph">
<p>Cette approche retarde la relance de du moteur de tâches, mais elle a deux avantages&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>elle force à traiter le problème (même si c&#8217;est en supprimant les tâches de la base de données, mais au moins une action volontaire a été faite)</p>
</li>
<li>
<p>elle évite les mauvaises surprises dans le cas où deux instances de moteur de tâches sont lancées avec le même identifiant.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Par exemple, il serait aussi possible qu&#8217;au démarrage d&#8217;une instance I1 de moteur de tâches, toutes les tâches marquées comme <code>running</code> soit mise à jour dans un statut spécial, par exemple <code>crashed</code>.
Mais imaginez que suite à une erreur de configuration une autre instance I2 de moteur de tâches utilise le même identifiant.
Lors du démarrage de I1, les tâches qu&#8217;I2 est en train d&#8217;exécuter passeraient en statut <code>crashed</code>.
Cela n&#8217;aurait peut-être aucune conséquence sur l&#8217;exécution de ces tâches, mais cela pourrait porter à confusion les personnes qui consulteraient l&#8217;état des tâches.</p>
</div>
<div class="paragraph">
<p>La solution de s&#8217;arrêter immédiatement évite donc ce risque.</p>
</div>
</div>
<div class="sect2">
<h3 id="_la_pratique">La pratique</h3>
<div class="paragraph">
<p>La mise en œuvre est moins longue que l&#8217;explication.</p>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord il faut ajouter la colonne d' l&#8217;instance à la table <code>tasks</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="title">migrations/02_add_instance_name.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:instance</span><span class="tok-p">,</span> <span class="tok-nb">String</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">true</span><span class="tok-p">,</span> <span class="tok-ss">text</span><span class="tok-p">:</span> <span class="tok-kp">true</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour rappel, pour lancer les migrations, la commande est</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sequel -m migrations postgres://task_engine@localhost/task_engine</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite il faut récupérer le nom de l&#8217;instance dans la tâche Rake de lancement et la passer au moteur. Pour ce faire je vais utiliser une variable d&#8217;environnement&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Rakefile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">TASK_ENGINE_INSTANCE</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;TASK_ENGINE_INSTANCE&#39;</span>

<span class="tok-n">task</span> <span class="tok-ss">:start_engine</span> <span class="tok-k">do</span>
  <span class="tok-k">unless</span> <span class="tok-no">ENV</span><span class="tok-o">.</span><span class="tok-n">key?</span><span class="tok-p">(</span><span class="tok-no">TASK_ENGINE_INSTANCE</span><span class="tok-p">)</span>
    <span class="tok-k">raise</span> <span class="tok-s2">&quot;Missing env variable </span><span class="tok-si">#{</span><span class="tok-no">TASK_ENGINE_INSTANCE</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>
  <span class="tok-k">end</span>
  <span class="tok-n">instance</span> <span class="tok-o">=</span> <span class="tok-no">ENV</span><span class="tok-o">.</span><span class="tok-n">fetch</span><span class="tok-p">(</span><span class="tok-no">TASK_ENGINE_INSTANCE</span><span class="tok-p">)</span>
  <span class="tok-n">require_relative</span> <span class="tok-s1">&#39;task_engine&#39;</span>
  <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">Engine</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Je peux ensuite l&#8217;utiliser lorsqu&#8217;un worker récupère une tâche&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">Engine</span>
  <span class="tok-no">ENGINE_STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
  <span class="tok-no">ENGINE_STATUS_STOPPING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;stopping&#39;</span>

  <span class="tok-kp">attr_reader</span> <span class="tok-ss">:instance</span><span class="tok-p">,</span> <span class="tok-ss">:status</span>

  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span>
    <span class="tok-vi">@instance</span> <span class="tok-o">=</span> <span class="tok-n">instance</span>
    <span class="tok-c1"># …</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-k">class</span> <span class="tok-nc">Worker</span>
  <span class="tok-c1"># @return [TaskEngine::Task, nil]</span>
  <span class="tok-k">def</span> <span class="tok-nf">try_acquire_task</span>
    <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
      <span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_WAITING</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">order</span><span class="tok-p">(</span><span class="tok-ss">:created_at</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">for_update</span><span class="tok-o">.</span><span class="tok-n">first</span>
      <span class="tok-k">unless</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">nil?</span>
        <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
            <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_RUNNING</span><span class="tok-p">,</span>
            <span class="tok-ss">instance</span><span class="tok-p">:</span> <span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">instance</span>
            <span class="tok-p">)</span>
        <span class="tok-n">task</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si je lance le moteur de tâches (en passant le nom de l&#8217;instance en variable d&#8217;environnement) et que je regarde ce qui se passe dans la base de données, on retrouve bien le nom de l&#8217;instance&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ <span class="tok-nv">TASK_ENGINE_INSTANCE</span><span class="tok-o">=</span>instance_01 rake start_engine</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ psql --user=task_engine --dbname=task_engine  --expanded --command=&quot;select * from tasks&quot;

-[ RECORD 1 ]---+-------------------------------
id              | 211
status          | running
created_at      | 2020-08-10 16:52:50.219772
updated_at      | 2020-08-10 16:52:50.219772
instance        | instance_01
-[ RECORD 2 ]---+-------------------------------
id              | 212
status          | running
created_at      | 2020-08-10 16:52:50.221219
updated_at      | 2020-08-10 16:52:50.221219
instance        | instance_01</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et pour terminer, au lancement du moteur de tâches, il faut vérifier si des tâches n&#8217;existent pas déjà avec le même nom d&#8217;instance&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">Engine</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span>
    <span class="tok-k">unless</span> <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span>
        <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">ENGINE_STATUS_RUNNING</span><span class="tok-p">,</span>
        <span class="tok-ss">instance</span><span class="tok-p">:</span> <span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">empty?</span>
      <span class="tok-k">raise</span> <span class="tok-s2">&quot;Found running tasks with same instance name in the database [</span><span class="tok-si">#{</span><span class="tok-n">instance</span><span class="tok-si">}</span><span class="tok-s2">]&quot;</span>
    <span class="tok-k">end</span>
  <span class="tok-c1"># …</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut le tester en stoppant brutalement l&#8217;instance en train de se tourner et en la relançant&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ TASK_ENGINE_INSTANCE=instance_01 rake start_engine
rake aborted!
Found running tasks with same instance name in the database [instance_01]
/task-engine-ruby/task_engine.rb:32:in `initialize&#39;
/task-engine-ruby/Rakefile:11:in `new&#39;
/task-engine-ruby/Rakefile:11:in `block in &lt;top (required)&gt;&#39;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut ensuite affiner les choses, par exemple afficher la liste des tâches qui sont en cours d&#8217;exécution, ou fournir des méthodes pour faciliter la reprise, mais la partie importante est là.</p>
</div>
<div class="paragraph">
<p>Dans la partie suivante je vais m&#8217;intéresser au paramétrage des tâches.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-06">Partie 6 : le paramétrage des tâches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour le moment le moteur de tâches ne sait exécuter qu&#8217;un seul type de tâches et n&#8217;accepte pas de paramètres, c&#8217;était suffisant jusque là mais pour la suite il va devenir nécessaire de le changer.</p>
</div>
<div class="sect2">
<h3 id="_définition_de_lapi_des_tâches">Définition de l&#8217;API des tâches</h3>
<div class="paragraph">
<p>Le type de tâche sera défini par le nom de la classe de la tâche qu&#8217;il faut lancer, c&#8217;est ce que font tous les outils que je connais et je ne vois pas d&#8217;autre approche intéressante.</p>
</div>
<div class="paragraph">
<p>Les paramètres d&#8217;exécution des tâches sont sous forme d&#8217;une <code>Hash</code> qui est à la main des tâches.</p>
</div>
<div class="paragraph">
<p>Il y a plusieurs choix possibles pour le fonctionnement des tâches, par exemple&#160;:</p>
</div>
<div class="sect3">
<h4 id="_solution_1_singletons">Solution 1&#160;: singletons</h4>
<div class="paragraph">
<p>Les tâches peuvent être des singletons qu&#8217;on instancie une seule fois par moteur de tâches et sur lesquelles on appelle une méthode <code>execute</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">MyTask</span>
  <span class="tok-c1"># Instance is a singleton managed by the engine</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">()</span>
  <span class="tok-k">end</span>

  <span class="tok-c1"># @param [Hash] parameters</span>
  <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_solution_2_execute_avec_paramètres">Solution 2&#160;: <code>execute</code> avec paramètres</h4>
<div class="paragraph">
<p>Les tâches sont instanciées à chaque exécution, pour cela on appelle un constructeur sans paramètre puis une méthode <code>execute</code> qui prend en paramètre les paramètres d&#8217;exécution</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">MyTask</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">()</span>
  <span class="tok-k">end</span>

  <span class="tok-c1"># @param [Hash] parameters</span>
  <span class="tok-c1"># @return [Hash, nil]</span>
  <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_solution_3_execute_sans_paramètres">Solution 3&#160;: <code>execute</code> sans paramètres</h4>
<div class="paragraph">
<p>Les tâches sont instanciées à chaque exécution, pour cela on appelle un constructeur qui prend en paramètre les paramètres d&#8217;exécution puis une méthode <code>execute</code> sans paramètre</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">MyTask</span>
  <span class="tok-c1"># @param [Hash] parameters</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>

  <span class="tok-c1"># @return [Hash, nil]</span>
  <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">()</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_solution_4_tout_dans_le_constructeur">Solution 4&#160;: tout dans le constructeur</h4>
<div class="paragraph">
<p>Les tâches sont instanciées à chaque exécution, pour cela on appelle un constructeur qui prend en paramètre les paramètres d&#8217;exécution qui fait tout le traitement, il n&#8217;y a pas de méthode <code>execute</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">MyTask</span>
  <span class="tok-c1"># @param [Hash] parameters</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_le_choix">Le choix</h4>
<div class="paragraph">
<p>La solution 1 a une forme d&#8217;élégance mais elle a deux inconvénients&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>si le code de la tâche est un peu complexe et que des sous-méthodes deviennent nécessaires, le fait de ne pas pouvoir utiliser de membre d&#8217;instance oblige à passer plus de choses en paramètres, ou de créer des classes ou des structures spécifiques</p>
</li>
<li>
<p>elle empêche d&#8217;utiliser certains modules qui ajoutent des membres d&#8217;instances ou à nouveau elle oblige à créer des classes supplémentaires qui de fait vont remplacer la classe de la tâche</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le résultat c&#8217;est que le code va souvent ressembler à&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">class</span> <span class="tok-nc">MyTask</span>
  <span class="tok-k">def</span> <span class="tok-nf">initialize</span>
  <span class="tok-k">end</span>

  <span class="tok-c1"># @param [Hash] parameters</span>
  <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
    <span class="tok-no">MyRealTask</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>

  <span class="tok-k">class</span> <span class="tok-nc">MyRealTask</span>
    <span class="tok-c1"># @param [Hash] parameters</span>
    <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Au final il vaut mieux laisser aux tâches la responsabilité d&#8217;utiliser elles-mêmes des singletons en interne si c&#8217;est nécessaire, et de permettre d&#8217;économiser une indirection dans le cas le plus fréquent.</p>
</div>
<div class="paragraph">
<p>Les autres solutions sont assez ressemblantes, et entre toutes je préfère la solution de &#8220;<code>execute</code> avec paramètres&#8221; qui a le numéro 2.</p>
</div>
<div class="paragraph">
<p>Le fait d&#8217;utiliser une méthode <code>execute</code> séparée du constructeur permet de récupérer des valeurs de retours qui peuvent être utiles pour le monitoring.</p>
</div>
<div class="paragraph">
<p>Et quitte à avoir une méthode <code>execute</code> séparée, autant qu&#8217;elle reçoive les paramètres, c&#8217;est un peu plus logique du point de vue objet, et cela permet de se passer du constructeur dans pas mal de cas.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modification_de_schéma">Modification de schéma</h3>
<div class="paragraph">
<p>Je vais ajouter les deux colonnes qui manquent à la table <code>tasks</code>.
Je vais les définir comme non nullable pour éviter toute fausse manipulation.
Si une tâche n&#8217;a aucun paramètre d&#8217;exécution, on utilisera une <code>Hash</code> vide plutôt d&#8217;un <code>nil</code>, cela évite l&#8217;ambiguïté entre aucun paramètre d&#8217;exécution et une valeur qui manque.</p>
</div>
<div class="paragraph">
<p>Cela signifie que la table doit être vide avant de lancer la migration, sinon elle échouera car la base n&#8217;acceptera pas d&#8217;ajouter des colonnes non nullable sans valeur par défaut.</p>
</div>
<div class="paragraph">
<p>Pour stocker les paramètres d&#8217;exécution en utilisant une colonne de type <a href="https://www.postgresql.org/docs/12/datatype-json.html"><code>jsonb</code></a> qui permet de stocker des données sous forme de JSON.</p>
</div>
<div class="paragraph">
<p>Par rapport à stocker le JSON dans un champ de texte, cela coûte un peu plus cher en temps d&#8217;insertion (car la base de données doit parser et valider le format des données à l&#8217;insertion), par contre cela peut simplifier les investigation car il est possible de <a href="https://www.postgresql.org/docs/current/functions-json.html">d&#8217;accéder au contenu des valeurs</a> depuis des requêtes.</p>
</div>
<div class="listingblock">
<div class="title">migrations/03_add_parameters.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">run</span> <span class="tok-s1">&#39;truncate tasks&#39;</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:task_class</span><span class="tok-p">,</span> <span class="tok-nb">String</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-ss">text</span><span class="tok-p">:</span> <span class="tok-kp">true</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:task_parameters</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JSONB&#39;</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_définition_dune_classe_de_tâche">Définition d&#8217;une classe de tâche</h3>
<div class="paragraph">
<p>Pour avoir une première définition de tâche je vais modifier le code la tâche existante pour utiliser la nouvelle API, et en profiter pour la déplacer dans un fichier séparé.</p>
</div>
<div class="paragraph">
<p>Pour mémoire, cette tâche se contentait d&#8217;attendre 5 secondes&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Puisqu&#8217;on a maintenant des paramètres, je vais rendre la durée d&#8217;attente paramétrable.
Pour cela je vais récupérer la valeur dans la <code>Hash</code> de paramètres&#160;:</p>
</div>
<div class="listingblock">
<div class="title">tasks.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">module</span> <span class="tok-nn">Tasks</span>
    <span class="tok-k">class</span> <span class="tok-nc">WaitingTask</span>
      <span class="tok-no">PARAMETER_WAITING_TIME</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting_time&#39;</span>

      <span class="tok-c1"># @param [Hash] parameters</span>
      <span class="tok-c1"># @return [Hash, nil]</span>
      <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
        <span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-o">[</span><span class="tok-no">PARAMETER_WAITING_TIME</span><span class="tok-o">]</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_création_de_tâches">Création de tâches</h3>
<div class="paragraph">
<p>Il est possible d&#8217;insérer directement des tâches dans la base de données depuis le code métier, mais il est plus pratique de passer par une API Ruby qui isole un peu le stockage, notamment le fait de stocker les paramètres au format JSON.
Je vais donc ajouter une méthode dans le module <code>TaskEngine</code>.</p>
</div>
<div class="paragraph">
<p>Dans une version packagée du code, on pourrait vouloir l&#8217;isoler dans une gem à part pour éviter d&#8217;avoir à embarquer le code du moteur de tâches dans une application qui ne ferait qu&#8217;insérer des tâches.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-c1"># Make json-related methods available</span>
  <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">extension</span> <span class="tok-ss">:pg_json</span>

  <span class="tok-c1"># @param [String] task_class</span>
  <span class="tok-c1"># @param [Hash] task_parameters</span>
  <span class="tok-k">def</span> <span class="tok-nc">self</span><span class="tok-o">.</span><span class="tok-nf">create_task</span><span class="tok-p">(</span><span class="tok-n">task_class</span><span class="tok-p">,</span> <span class="tok-n">task_parameters</span><span class="tok-p">)</span>
    <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span>
        <span class="tok-ss">task_class</span><span class="tok-p">:</span> <span class="tok-n">task_class</span><span class="tok-p">,</span>
        <span class="tok-c1"># Sequel.pg_json_wrap serialize a Hash</span>
        <span class="tok-c1"># into something that can be inserted into a jsonb column</span>
        <span class="tok-ss">task_parameters</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_jsonb_wrap</span><span class="tok-p">(</span><span class="tok-n">task_parameters</span><span class="tok-p">)</span>
    <span class="tok-p">)</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et je peux m&#8217;en servir pour modifier la tâche Rake qui peuple la table&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Rakefile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-n">desc</span> <span class="tok-s1">&#39;Create tasks&#39;</span>
<span class="tok-n">task</span> <span class="tok-ss">:create_tasks</span> <span class="tok-k">do</span>
  <span class="tok-n">require_relative</span> <span class="tok-s1">&#39;task_engine&#39;</span>
  <span class="tok-mi">100</span><span class="tok-o">.</span><span class="tok-n">times</span> <span class="tok-k">do</span>
    <span class="tok-no">TaskEngine</span><span class="tok-o">.</span><span class="tok-n">create_task</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;TaskEngine::Tasks::WaitingTask&#39;</span><span class="tok-p">,</span>
        <span class="tok-p">{</span>
            <span class="tok-ss">waiting_time</span><span class="tok-p">:</span> <span class="tok-mi">5</span>
        <span class="tok-p">})</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et après exécution on peut vérifier que l&#8217;insertion se passe bien&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ psql --user=task_engine --dbname=task_engine  --expanded --command=&quot;select * from tasks&quot;

-[ RECORD 1 ]---+-------------------------------
id              | 211
status          | waiting
created_at      | 2020-08-10 16:52:50.219772
updated_at      | 2020-08-10 16:52:50.219772
instance        |
task_class      | TaskEngine::Tasks::WaitingTask
task_parameters | {&quot;waiting_time&quot;: 5}
-[ RECORD 2 ]---+-------------------------------
id              | 212
status          | waiting
created_at      | 2020-08-10 16:52:50.221219
updated_at      | 2020-08-10 16:52:50.221219
instance        |
task_class      | TaskEngine::Tasks::WaitingTask
task_parameters | {&quot;waiting_time&quot;: 5}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lexécution">L&#8217;exécution</h3>
<div class="paragraph">
<p>Il manque la dernière pièce du puzzle&#160;: utiliser les valeurs pour créer la tâche et l&#8217;exécuter.</p>
</div>
<div class="paragraph">
<p>Pour récupérer une classe à partir d&#8217;une chaîne contenant son nom, Ruby fournit une méthode <code>Module#const_get</code>, il faudra ensuite en instancier un objet de la classe ainsi obtenue, puis appeler <code>execute</code> sur l&#8217;instance en lui passant les paramètres&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Engine</span>
    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">Engine</span><span class="tok-o">::</span><span class="tok-no">ENGINE_STATUS_RUNNING</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span>
          <span class="tok-p">(</span><span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-n">try_acquire_task</span><span class="tok-p">)</span>
        <span class="tok-n">starting_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> starting task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>

        <span class="tok-n">task_class_name</span> <span class="tok-o">=</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">task_class</span>
        <span class="tok-n">task_class</span> <span class="tok-o">=</span> <span class="tok-no">Object</span><span class="tok-o">.</span><span class="tok-n">const_get</span><span class="tok-p">(</span><span class="tok-n">task_class_name</span><span class="tok-p">)</span>
        <span class="tok-n">task_instance</span> <span class="tok-o">=</span> <span class="tok-n">task_class</span><span class="tok-o">.</span><span class="tok-n">new</span>
        <span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">task_parameters</span><span class="tok-p">)</span>

        <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
        <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> finished task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">, took </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms&quot;</span><span class="tok-p">)</span>
        <span class="tok-n">end_task</span><span class="tok-p">(</span><span class="tok-n">task</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is stopping&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui donne&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ TASK_ENGINE_INSTANCE=instance_01 rake start_engine
Starting engine
Starting worker 0
Starting worker 1
Starting worker 2
Starting worker 3
Starting worker 4
Joining worker 0
(0.000937s) BEGIN
(0.001048s) SELECT * FROM &quot;tasks&quot; WHERE (&quot;status&quot; = &#39;waiting&#39;) ORDER BY &quot;created_at&quot; LIMIT 1 FOR UPDATE
(0.000534s) UPDATE &quot;tasks&quot; SET &quot;status&quot; = &#39;running&#39;, &quot;instance&quot; = &#39;my_instance&#39; WHERE (&quot;id&quot; = 1501)
(0.000797s) COMMIT
Worker 0 starting task 1501</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voila&#160;: il est maintenant possible de sélectionner des tâches et de leur passer des paramètres.</p>
</div>
<div class="paragraph">
<p>Pour le moment c&#8217;est assez rustique, par exemple il n&#8217;y a pas encore de gestion d&#8217;erreur, mais la structure est là.</p>
</div>
<div class="paragraph">
<p>Dans la partie suivante je vais faire en sorte que le moteur réagisse quand on ajoute des tâches en cours de route.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-07">Partie 7 : l&#8217;ajout de tâches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour le moment, quand le moteur de tâches est lancé il commence à traiter des tâches, et s&#8217;arrête quand il n&#8217;y en a plus.
Si j&#8217;ajoute des tâches après-coup, il ne se passe rien.
En effet une fois les workers en pause, aucun mécanisme ne les réveille quand d&#8217;autres tâches sont insérées dans la base de données.</p>
</div>
<div class="paragraph">
<p>L&#8217;un des avantage de l&#8217;utilisation de bus de messages comme ActiveMQ ou Kafka pour stocker les tâches d&#8217;une moteur de tâches plutôt qu&#8217;une base de données SQL traditionnelle vient de leur fonctionnalités de notification, où le code du moteur peut écouter des évènements (ici les tâches qui sont ajoutées) envoyés par le bus, pour déclencher le traitement des tâches.</p>
</div>
<div class="paragraph">
<p>Redis fournit également ce type de mécanisme, mais c&#8217;est aussi le cas pour PostgreSQL à travers les fonctions <a href="https://www.postgresql.org/docs/current/sql-listen.html"><code>LISTEN</code></a> et <a href="https://www.postgresql.org/docs/current/sql-notify.html"><code>NOTIFY</code></a>.</p>
</div>
<div class="sect2">
<h3 id="_le_principe_des_notifications">Le principe des notifications</h3>
<div class="paragraph">
<p>Lorsque les workers sont en train de tourner, après avoir terminé une tâche ils vont en chercher une autre, même si cette dernière a été ajoutée après le démarrage du moteur de tâches. Dans ce cas il n&#8217;y a rien de spécial à faire.</p>
</div>
<div class="paragraph">
<p>Par contre, lorsqu&#8217;au moins un des workers s&#8217;est arrêté car il n&#8217;a pas trouvé de tâche disponible, il faut le solliciter pour qu&#8217;il se remette au travail quand une nouvelle tâche est créée.</p>
</div>
<div class="paragraph">
<p>Cela permet que la nouvelle tâche soit traitée au plus vite, plutôt que d&#8217;attendre qu&#8217;un worker qui est déjà en train d&#8217;exécuter une autre tâche ne la termine.</p>
</div>
<div class="paragraph">
<p>Lorsqu&#8217;on insère une nouvelle tâche, il faudra donc envoyer une notification pour réveiller les workers qui pourraient être disponibles.</p>
</div>
<div class="paragraph">
<p>Pour cela j&#8217;utiliserai un thread supplémentaire qui sera chargé d&#8217;écouter les notifications envoyées pour réveiller les workers.</p>
</div>
<div class="paragraph">
<p>En Ruby, la classe <a href="https://ruby-doc.org/core-2.7.0/Queue.html">Queue</a> est destinée à ce type d&#8217;usage où des thread doivent s&#8217;attendre et communiquer entre eux.
Il s&#8217;agit d&#8217;une file (une sorte de liste dont les éléments sortent dans le même ordre que celui où ils sont insérés), à laquelle plusieurs threads peuvent accéder en parallèle.
Le comportement le plus intéressant pour un moteur de tâches est que si du code demande à récupérer un élément de la queue alors qu&#8217;elle est vide, le thread correspondant se mettra en attente jusqu&#8217;à ce qu&#8217;un élément soit disponible.</p>
</div>
<div class="paragraph">
<p>Il serait possible de manipuler directement les thread des workers comme pour l&#8217;arrêt du moteur de tâches, en passant les thread des workers en le statut <code>sleep</code> puis en les réveillant avec <code>Thread#wakeup</code>, mais <code>Queue</code> fournit une API prête à l&#8217;emploi pour cela, et cela évite d&#8217;avoir le genre de bugs pénibles qui apparaît quand on décide de réinventer la roue sur un sujet qui touche au threading.</p>
</div>
<div class="paragraph">
<p>Il faut garder en tête que le fonctionnement final doit être compatible avec le fait d&#8217;avoir plusieurs threads et plusieurs instances de moteur de tâches, et qu&#8217;il faut toujours pouvoir arrêter les différentes instances.</p>
</div>
</div>
<div class="sect2">
<h3 id="_la_nouvelle_boucle_de_traitement_des_workers">La nouvelle boucle de traitement des workers</h3>
<div class="paragraph">
<p>Le fonctionnement actuel des worker est celui-ci&#160;:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuNDQuMSAoMjAyMDA2MjkuMDg0NikKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIzMDlwdCIgaGVpZ2h0PSIzMDlwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAzMDkuMTQgMzA4Ljc0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDMwNC43NCkiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IndoaXRlIiBzdHJva2U9InRyYW5zcGFyZW50IiBwb2ludHM9Ii00LDQgLTQsLTMwNC43NCAzMDUuMTQsLTMwNC43NCAzMDUuMTQsNCAtNCw0Ii8+CjwhLS0gbjEgLS0+CjxnIGlkPSJub2RlMSIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjE8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMTE2LjE0IiBjeT0iLTI4Mi43NCIgcng9IjEwOS4zOCIgcnk9IjE4Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjExNi4xNCIgeT0iLTI3OS4wNCIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5BcnLDqnQgZHUgbW90ZXVyIGRlbWFuZMOpID88L3RleHQ+CjwvZz4KPCEtLSBuMiAtLT4KPGcgaWQ9Im5vZGUyIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5uMjwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSIxMTYuMTQiIGN5PSItMTg2Ljg3IiByeD0iNzIuNjYiIHJ5PSIyNi43NCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxMTYuMTQiIHk9Ii0xOTAuNjciIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+UHJvY2hhaW5lIHTDomNoZTwvdGV4dD4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTE2LjE0IiB5PSItMTc1LjY3IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPsOgIGV4w6ljdXRlciA/PC90ZXh0Pgo8L2c+CjwhLS0gbjEmIzQ1OyZndDtuMiAtLT4KPGcgaWQ9ImVkZ2UxIiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uMSYjNDU7Jmd0O24yPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTExNi4xNCwtMjY0LjUyQzExNi4xNCwtMjUzLjIyIDExNi4xNCwtMjM4LjAxIDExNi4xNCwtMjI0LjEyIi8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjExOS42NCwtMjIzLjg0IDExNi4xNCwtMjEzLjg0IDExMi42NCwtMjIzLjg0IDExOS42NCwtMjIzLjg0Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjEyOC4xNCIgeT0iLTIzNS41NCIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5Ob248L3RleHQ+CjwvZz4KPCEtLSBuMyAtLT4KPGcgaWQ9Im5vZGUzIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5uMzwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSI3Mi4xNCIgY3k9Ii0xOCIgcng9IjcyLjI5IiByeT0iMTgiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNzIuMTQiIHk9Ii0xNC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkFycsOqdGVyIGxlIHdvcmtlcjwvdGV4dD4KPC9nPgo8IS0tIG4xJiM0NTsmZ3Q7bjMgLS0+CjxnIGlkPSJlZGdlMiIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+bjEmIzQ1OyZndDtuMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik04NS4yLC0yNjUuNDFDNjYuNjYsLTI1My43NSA0NC42OCwtMjM2LjE3IDM0LjE0LC0yMTMuNzQgNy42OCwtMTU3LjQxIDM3LjUsLTgzLjU4IDU3LjM0LC00NS4wMiIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSI2MC41MywtNDYuNDggNjIuMTMsLTM2LjAxIDU0LjM1LC00My4yIDYwLjUzLC00Ni40OCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIzOC42NCIgeT0iLTEzMC44IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPk91aTwvdGV4dD4KPC9nPgo8IS0tIG4yJiM0NTsmZ3Q7bjMgLS0+CjxnIGlkPSJlZGdlMyIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+bjImIzQ1OyZndDtuMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0xMDEuOTYsLTE2MC4zM0M5NC41MSwtMTQ1Ljc0IDg1Ljk2LC0xMjYuODQgODEuMTQsLTEwOSA3NS42LC04OC40NCA3My40LC02NC40IDcyLjU2LC00Ni4zNSIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSI3Ni4wNiwtNDYuMDkgNzIuMiwtMzYuMjIgNjkuMDYsLTQ2LjM0IDc2LjA2LC00Ni4wOSIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI5OS4xNCIgeT0iLTk0LjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+UGFzIGRlPC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI5OS4xNCIgeT0iLTc5LjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+dMOiY2hlPC90ZXh0Pgo8L2c+CjwhLS0gbjQgLS0+CjxnIGlkPSJub2RlNCIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjQ8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMTk3LjE0IiBjeT0iLTkxIiByeD0iNzEuNDkiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxOTcuMTQiIHk9Ii04Ny4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkV4w6ljdXRlciBsYSB0w6JjaGU8L3RleHQ+CjwvZz4KPCEtLSBuMiYjNDU7Jmd0O240IC0tPgo8ZyBpZD0iZWRnZTQiIGNsYXNzPSJlZGdlIj4KPHRpdGxlPm4yJiM0NTsmZ3Q7bjQ8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMTE5LjE2LC0xNTkuNzdDMTIxLjUxLC0xNDguNzMgMTI1LjY5LC0xMzYuMyAxMzMuMTQsLTEyNyAxMzcuODgsLTEyMS4wOSAxNDMuOSwtMTE2LjAzIDE1MC4zNCwtMTExLjc1Ii8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjE1Mi41MiwtMTE0LjUyIDE1OS4zLC0xMDYuMzggMTQ4LjkzLC0xMDguNTEgMTUyLjUyLC0xMTQuNTIiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTcyLjE0IiB5PSItMTMwLjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+VMOiY2hlIHRyb3V2w6llPC90ZXh0Pgo8L2c+CjwhLS0gbjQmIzQ1OyZndDtuMSAtLT4KPGcgaWQ9ImVkZ2U1IiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uNCYjNDU7Jmd0O24xPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTIwNS40NywtMTA5LjA1QzIwNy43OCwtMTE0LjY0IDIwOS45OCwtMTIwLjk2IDIxMS4xNCwtMTI3IDIxOC41MiwtMTY1LjI4IDIxNy44MSwtMTgwLjA4IDE5OC4xNCwtMjEzLjc0IDE4Ny4zNCwtMjMyLjIzIDE2OS41MywtMjQ3LjkxIDE1My4yNiwtMjU5LjU0Ii8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjE1MS4yMSwtMjU2LjcgMTQ0Ljk0LC0yNjUuMjQgMTU1LjE3LC0yNjIuNDcgMTUxLjIxLC0yNTYuNyIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyNTguNjQiIHk9Ii0xODMuMTciIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+VMOiY2hlIGV4w6ljdXTDqWU8L3RleHQ+CjwvZz4KPCEtLSBuNCYjNDU7Jmd0O24zIC0tPgo8L2c+Cjwvc3ZnPgo=" alt="workflow 7 1">
</div>
</div>
<div class="paragraph">
<p>La demande d&#8217;arrêt du moteur et l&#8217;absence de tâche à exécuter mènent tous les deux à l&#8217;arrêt du worker.</p>
</div>
<div class="paragraph">
<p>Il faut ajouter une nouvelle boucle dans le schéma&#160;: en l&#8217;absence de tâche, au lieu de s&#8217;arrêter les workers doivent se mettre en pause en attendant une notification.</p>
</div>
<div class="paragraph">
<p>Lorsqu&#8217;on les réveille, ils vérifient que le moteur est toujours en fonctionnement, et dans ce cas se remettent à chercher une tâche.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuNDQuMSAoMjAyMDA2MjkuMDg0NikKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIzOTNwdCIgaGVpZ2h0PSIzNDFwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAzOTIuOTcgMzQxLjQ4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDMzNy40OCkiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IndoaXRlIiBzdHJva2U9InRyYW5zcGFyZW50IiBwb2ludHM9Ii00LDQgLTQsLTMzNy40OCAzODguOTcsLTMzNy40OCAzODguOTcsNCAtNCw0Ii8+CjwhLS0gbjEgLS0+CjxnIGlkPSJub2RlMSIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjE8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMjU3Ljk3IiBjeT0iLTMxNS40OCIgcng9IjEwOS4zOCIgcnk9IjE4Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjI1Ny45NyIgeT0iLTMxMS43OCIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5BcnLDqnQgZHUgbW90ZXVyIGRlbWFuZMOpID88L3RleHQ+CjwvZz4KPCEtLSBuMiAtLT4KPGcgaWQ9Im5vZGUyIiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5uMjwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSIxNzYuOTciIGN5PSItMjE5LjYxIiByeD0iNzIuNjYiIHJ5PSIyNi43NCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxNzYuOTciIHk9Ii0yMjMuNDEiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+UHJvY2hhaW5lIHTDomNoZTwvdGV4dD4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTc2Ljk3IiB5PSItMjA4LjQxIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPsOgIGV4w6ljdXRlciA/PC90ZXh0Pgo8L2c+CjwhLS0gbjEmIzQ1OyZndDtuMiAtLT4KPGcgaWQ9ImVkZ2UxIiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uMSYjNDU7Jmd0O24yPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTI0My4xMSwtMjk3LjI2QzIzMi41NSwtMjg1LjAzIDIxOC4wNCwtMjY4LjIxIDIwNS4zMSwtMjUzLjQ1Ii8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjIwNy42MywtMjUwLjc4IDE5OC40NSwtMjQ1LjUgMjAyLjMzLC0yNTUuMzYgMjA3LjYzLC0yNTAuNzgiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMjM5Ljk3IiB5PSItMjY4LjI4IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPk5vbjwvdGV4dD4KPC9nPgo8IS0tIG4zIC0tPgo8ZyBpZD0ibm9kZTUiIGNsYXNzPSJub2RlIj4KPHRpdGxlPm4zPC90aXRsZT4KPGVsbGlwc2UgZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgY3g9IjI2Ni45NyIgY3k9Ii0xOCIgcng9IjcyLjI5IiByeT0iMTgiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMjY2Ljk3IiB5PSItMTQuMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5BcnLDqnRlciBsZSB3b3JrZXI8L3RleHQ+CjwvZz4KPCEtLSBuMSYjNDU7Jmd0O24zIC0tPgo8ZyBpZD0iZWRnZTYiIGNsYXNzPSJlZGdlIj4KPHRpdGxlPm4xJiM0NTsmZ3Q7bjM8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMjk5LjQ2LC0yOTguNzJDMzIyLjAyLC0yODcuNzcgMzQ3LjkyLC0yNzAuNzMgMzYwLjk3LC0yNDYuNDggMzgzLjM5LC0yMDQuODEgMzM5LjA4LC04NC40MSAzMzEuOTcsLTczIDMyNC4yMiwtNjAuNTggMzEyLjY0LC00OS42NCAzMDEuMzksLTQwLjkxIi8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjMwMy40NCwtMzguMDcgMjkzLjMxLC0zNC45NSAyOTkuMjksLTQzLjcgMzAzLjQ0LC0zOC4wNyIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIzNzQuNDciIHk9Ii0xNTYuMDQiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+T3VpPC90ZXh0Pgo8L2c+CjwhLS0gbjQgLS0+CjxnIGlkPSJub2RlMyIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjQ8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMTMzLjk3IiBjeT0iLTk5Ljg3IiByeD0iNzEuNDkiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxMzMuOTciIHk9Ii05Ni4xNyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5FeMOpY3V0ZXIgbGEgdMOiY2hlPC90ZXh0Pgo8L2c+CjwhLS0gbjImIzQ1OyZndDtuNCAtLT4KPGcgaWQ9ImVkZ2U0IiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uMiYjNDU7Jmd0O240PC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTE0Ny45NSwtMTk0LjU3QzE0Mi42OCwtMTg4LjY3IDEzNy45MywtMTgxLjk2IDEzNC45NywtMTc0Ljc0IDEyOS4wMSwtMTYwLjE3IDEyOC41MywtMTQyLjYgMTI5LjY1LC0xMjguMjQiLz4KPHBvbHlnb24gZmlsbD0iYmxhY2siIHN0cm9rZT0iYmxhY2siIHBvaW50cz0iMTMzLjE2LC0xMjguMzIgMTMwLjc1LC0xMTggMTI2LjIsLTEyNy41NyAxMzMuMTYsLTEyOC4zMiIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxNzMuOTciIHk9Ii0xNTYuMDQiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+VMOiY2hlIHRyb3V2w6llPC90ZXh0Pgo8L2c+CjwhLS0gbjUgLS0+CjxnIGlkPSJub2RlNCIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjU8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMjc3Ljk3IiBjeT0iLTk5Ljg3IiByeD0iNDUuMDEiIHJ5PSIyNi43NCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyNzcuOTciIHk9Ii0xMDMuNjciIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+V29ya2VyPC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyNzcuOTciIHk9Ii04OC42NyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5lbiBwYXVzZTwvdGV4dD4KPC9nPgo8IS0tIG4yJiM0NTsmZ3Q7bjUgLS0+CjxnIGlkPSJlZGdlMiIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+bjImIzQ1OyZndDtuNTwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0xOTcuNjcsLTE5My42N0MyMDIuNzIsLTE4Ny41MSAyMDguMDcsLTE4MC45MiAyMTIuOTcsLTE3NC43NCAyMjMuNDEsLTE2MS41OCAyMjUuMDMsLTE1Ny40OSAyMzUuOTcsLTE0NC43NCAyMzkuODQsLTE0MC4yMyAyNDQuMDQsLTEzNS41OCAyNDguMjQsLTEzMS4wNiIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSIyNTAuOTIsLTEzMy4zMiAyNTUuMjUsLTEyMy42NSAyNDUuODQsLTEyOC41MSAyNTAuOTIsLTEzMy4zMiIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyNTMuOTciIHk9Ii0xNjMuNTQiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+UGFzIGRlPC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyNTMuOTciIHk9Ii0xNDguNTQiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+dMOiY2hlPC90ZXh0Pgo8L2c+CjwhLS0gbjQmIzQ1OyZndDtuMSAtLT4KPGcgaWQ9ImVkZ2U1IiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uNCYjNDU7Jmd0O24xPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTEwMy4yMSwtMTE2LjM1QzU1LjM5LC0xNDIuNDcgLTI3LjU5LC0xOTcuMjQgOS45NywtMjQ2LjQ4IDI5LjQ0LC0yNzIgMTA1LjI5LC0yOTAuMzEgMTY4LjA0LC0zMDEuNDUiLz4KPHBvbHlnb24gZmlsbD0iYmxhY2siIHN0cm9rZT0iYmxhY2siIHBvaW50cz0iMTY3LjUzLC0zMDQuOTIgMTc3Ljk5LC0zMDMuMTggMTY4LjczLC0yOTguMDIgMTY3LjUzLC0zMDQuOTIiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNTIuNDciIHk9Ii0yMTUuOTEiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+VMOiY2hlIGV4w6ljdXTDqWU8L3RleHQ+CjwvZz4KPCEtLSBuNCYjNDU7Jmd0O24zIC0tPgo8IS0tIG41JiM0NTsmZ3Q7bjEgLS0+CjxnIGlkPSJlZGdlMyIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+bjUmIzQ1OyZndDtuMTwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0yNzUuOTgsLTEyNi44NkMyNzQuODYsLTE0MS4wMiAyNzMuNDEsLTE1OC44NSAyNzEuOTcsLTE3NC43NCAyNjguNDMsLTIxMy43NSAyNjMuODIsLTI1OC44NCAyNjAuODgsLTI4Ny4wMSIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSIyNTcuMzYsLTI4Ni45NyAyNTkuOCwtMjk3LjI4IDI2NC4zMiwtMjg3LjcgMjU3LjM2LC0yODYuOTciLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMzEzLjk3IiB5PSItMjE1LjkxIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPldvcmtlciByw6l2ZWlsbMOpPC90ZXh0Pgo8L2c+CjwvZz4KPC9zdmc+Cg==" alt="workflow 7 2">
</div>
</div>
<div class="paragraph">
<p>On pourrait vouloir directement passer de la pause au fait de chercher des tâches à exécuter&#160;:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuNDQuMSAoMjAyMDA2MjkuMDg0NikKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSI0MTJwdCIgaGVpZ2h0PSIzNDFwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCA0MTIuNDAgMzQxLjQ4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDMzNy40OCkiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IndoaXRlIiBzdHJva2U9InRyYW5zcGFyZW50IiBwb2ludHM9Ii00LDQgLTQsLTMzNy40OCA0MDguNCwtMzM3LjQ4IDQwOC40LDQgLTQsNCIvPgo8IS0tIG4xIC0tPgo8ZyBpZD0ibm9kZTEiIGNsYXNzPSJub2RlIj4KPHRpdGxlPm4xPC90aXRsZT4KPGVsbGlwc2UgZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgY3g9IjI3Ni4yNSIgY3k9Ii0zMTUuNDgiIHJ4PSIxMDkuMzgiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyNzYuMjUiIHk9Ii0zMTEuNzgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+QXJyw6p0IGR1IG1vdGV1ciBkZW1hbmTDqSA/PC90ZXh0Pgo8L2c+CjwhLS0gbjIgLS0+CjxnIGlkPSJub2RlMiIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjI8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMTIxLjI1IiBjeT0iLTIxOS42MSIgcng9IjcyLjY2IiByeT0iMjYuNzQiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTIxLjI1IiB5PSItMjIzLjQxIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPlByb2NoYWluZSB0w6JjaGU8L3RleHQ+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjEyMS4yNSIgeT0iLTIwOC40MSIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj7DoCBleMOpY3V0ZXIgPzwvdGV4dD4KPC9nPgo8IS0tIG4xJiM0NTsmZ3Q7bjIgLS0+CjxnIGlkPSJlZGdlMSIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+bjEmIzQ1OyZndDtuMjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0yNDguOSwtMjk3LjkxQzIyNi4xOCwtMjg0LjE1IDE5My4zOCwtMjY0LjI5IDE2Ni43MiwtMjQ4LjE0Ii8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjE2OC4zLC0yNDUuMDEgMTU3LjkzLC0yNDIuODIgMTY0LjY4LC0yNTEgMTY4LjMsLTI0NS4wMSIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyMjguMjUiIHk9Ii0yNjguMjgiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+Tm9uPC90ZXh0Pgo8L2c+CjwhLS0gbjMgLS0+CjxnIGlkPSJub2RlNSIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjM8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMzMyLjI1IiBjeT0iLTE4IiByeD0iNzIuMjkiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIzMzIuMjUiIHk9Ii0xNC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkFycsOqdGVyIGxlIHdvcmtlcjwvdGV4dD4KPC9nPgo8IS0tIG4xJiM0NTsmZ3Q7bjMgLS0+CjxnIGlkPSJlZGdlNiIgY2xhc3M9ImVkZ2UiPgo8dGl0bGU+bjEmIzQ1OyZndDtuMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0zMTAuNjYsLTI5OC4yN0MzMzAuNTcsLTI4Ni44NSAzNTMuODgsLTI2OS40OSAzNjUuMjUsLTI0Ni40OCAzOTguMzEsLTE3OS42MyAzNjUuNTIsLTg5LjE3IDM0NS40MSwtNDUuMTgiLz4KPHBvbHlnb24gZmlsbD0iYmxhY2siIHN0cm9rZT0iYmxhY2siIHBvaW50cz0iMzQ4LjUyLC00My41OSAzNDEuMDksLTM2LjAzIDM0Mi4xOSwtNDYuNTcgMzQ4LjUyLC00My41OSIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIzODkuNzUiIHk9Ii0xNTYuMDQiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+T3VpPC90ZXh0Pgo8L2c+CjwhLS0gbjQgLS0+CjxnIGlkPSJub2RlMyIgY2xhc3M9Im5vZGUiPgo8dGl0bGU+bjQ8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iMjc2LjI1IiBjeT0iLTk5Ljg3IiByeD0iNzEuNDkiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIyNzYuMjUiIHk9Ii05Ni4xNyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5FeMOpY3V0ZXIgbGEgdMOiY2hlPC90ZXh0Pgo8L2c+CjwhLS0gbjImIzQ1OyZndDtuNCAtLT4KPGcgaWQ9ImVkZ2U0IiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uMiYjNDU7Jmd0O240PC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTE0NC40NywtMTkzLjg4QzE1MC4wNywtMTg3LjcyIDE1NS45NiwtMTgxLjA2IDE2MS4yNSwtMTc0Ljc0IDE3Mi4wNCwtMTYxLjg1IDE3MS4yLC0xNTUuMzIgMTg0LjI1LC0xNDQuNzQgMTk2Ljg5LC0xMzQuNTEgMjEyLjMsLTEyNS45NyAyMjYuODgsLTExOS4yMyIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSIyMjguNTcsLTEyMi4zMSAyMzYuMjksLTExNS4wNiAyMjUuNzMsLTExNS45IDIyOC41NywtMTIyLjMxIi8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjIyMy4yNSIgeT0iLTE1Ni4wNCIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5Uw6JjaGUgdHJvdXbDqWU8L3RleHQ+CjwvZz4KPCEtLSBuNSAtLT4KPGcgaWQ9Im5vZGU0IiBjbGFzcz0ibm9kZSI+Cjx0aXRsZT5uNTwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSI0NS4yNSIgY3k9Ii05OS44NyIgcng9IjQ1LjAxIiByeT0iMjYuNzQiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNDUuMjUiIHk9Ii0xMDMuNjciIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+V29ya2VyPC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI0NS4yNSIgeT0iLTg4LjY3IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPmVuIHBhdXNlPC90ZXh0Pgo8L2c+CjwhLS0gbjImIzQ1OyZndDtuNSAtLT4KPGcgaWQ9ImVkZ2UyIiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uMiYjNDU7Jmd0O241PC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTU4LjQ5LC0yMDUuODZDNDIuMDEsLTE5OS4zNiAyNi4xMSwtMTg5LjU0IDE2LjI1LC0xNzQuNzQgNy43NCwtMTYxLjk1IDEyLjE1LC0xNDYuMjggMTkuODQsLTEzMi42NiIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSIyMi44OSwtMTM0LjM5IDI1LjI3LC0xMjQuMDcgMTYuOTcsLTEzMC42NiAyMi44OSwtMTM0LjM5Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjM0LjI1IiB5PSItMTYzLjU0IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPlBhcyBkZTwvdGV4dD4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMzQuMjUiIHk9Ii0xNDguNTQiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+dMOiY2hlPC90ZXh0Pgo8L2c+CjwhLS0gbjQmIzQ1OyZndDtuMSAtLT4KPGcgaWQ9ImVkZ2U1IiBjbGFzcz0iZWRnZSI+Cjx0aXRsZT5uNCYjNDU7Jmd0O24xPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTI3Ni4yNSwtMTE4LjA3QzI3Ni4yNSwtMTU1LjEgMjc2LjI1LC0yNDIuNTkgMjc2LjI1LC0yODcuMjQiLz4KPHBvbHlnb24gZmlsbD0iYmxhY2siIHN0cm9rZT0iYmxhY2siIHBvaW50cz0iMjcyLjc1LC0yODcuMzYgMjc2LjI1LC0yOTcuMzYgMjc5Ljc1LC0yODcuMzYgMjcyLjc1LC0yODcuMzYiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMzE4Ljc1IiB5PSItMjE1LjkxIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPlTDomNoZSBleMOpY3V0w6llPC90ZXh0Pgo8L2c+CjwhLS0gbjQmIzQ1OyZndDtuMyAtLT4KPCEtLSBuNSYjNDU7Jmd0O24yIC0tPgo8ZyBpZD0iZWRnZTMiIGNsYXNzPSJlZGdlIj4KPHRpdGxlPm41JiM0NTsmZ3Q7bjI8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNNTIuNjYsLTEyNi40N0M1Ny42NywtMTQxLjM0IDY1LjIxLC0xNTkuOTggNzUuMjUsLTE3NC43NCA3OC4yMSwtMTc5LjA4IDgxLjY1LC0xODMuMzIgODUuMjksLTE4Ny4zNCIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSI4My4wMiwtMTkwLjAzIDkyLjQ5LC0xOTQuOCA4OC4wNiwtMTg1LjE3IDgzLjAyLC0xOTAuMDMiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTE4LjI1IiB5PSItMTU2LjA0IiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPldvcmtlciByw6l2ZWlsbMOpPC90ZXh0Pgo8L2c+CjwvZz4KPC9zdmc+Cg==" alt="workflow 7 3">
</div>
</div>
<div class="paragraph">
<p>Mais dans ce cas, si le worker ne trouve pas de tâche à exécuter après avoir réveillé il ne peut pas s&#8217;arrêter mais seulement se remettre en sommeil, à moins d&#8217;ajouter du code spécifique pour cela.</p>
</div>
<div class="paragraph">
<p>La proposition précédente est donc un peu plus générique.</p>
</div>
<div class="paragraph">
<p>Pour implémenter le workflow, on peut utiliser une double boucle&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la boucle extérieur vérifie l&#8217;extinction du moteur, et est déclenchée au réveil</p>
</li>
<li>
<p>la boucle intérieur vérifier l&#8217;extinction et cherche la prochaine tâche, et est exécutée à chaque tâche</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>
    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-k">while</span> <span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-no">Engine</span><span class="tok-o">::</span><span class="tok-no">ENGINE_STATUS_RUNNING</span>
        <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-no">Engine</span><span class="tok-o">::</span><span class="tok-no">ENGINE_STATUS_RUNNING</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-p">(</span><span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-n">try_acquire_task</span><span class="tok-p">)</span>
          <span class="tok-c1"># Execute the task</span>
        <span class="tok-k">end</span>
        <span class="tok-c1"># Wait until the notification awakes the worker</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is sleeping&quot;</span><span class="tok-p">)</span>
        <span class="tok-c1"># We don&#39;t care about the message we got from the queue</span>
        <span class="tok-c1"># since we just want to be awaken</span>
        <span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">pop</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is awaken&quot;</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is stopping&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour recevoir la notification, je dois créer un nouveau thread car l&#8217;écoute bloque l&#8217;exécution du thread qui attend d&#8217;être notifié.</p>
</div>
<div class="paragraph">
<p>Je vais créer ce thread dans le constructeur de l'<code>Engine</code>.</p>
</div>
<div class="paragraph">
<p>À la réception d&#8217;un message, il utilise la <code>Queue</code> pour réveiller un worker si l&#8217;un d&#8217;eux est disponible.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Engine</span>
    <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span>
    <span class="tok-c1"># …</span>
    <span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
      <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">listen</span><span class="tok-p">(</span><span class="tok-no">NOTIFICATION_CHANNEL</span><span class="tok-p">,</span> <span class="tok-kp">loop</span><span class="tok-p">:</span> <span class="tok-kp">true</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">_channel</span><span class="tok-p">,</span> <span class="tok-n">_pid</span><span class="tok-p">,</span> <span class="tok-n">task_class</span><span class="tok-o">|</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Received notification for a task [</span><span class="tok-si">#{</span><span class="tok-n">task_class</span><span class="tok-si">}</span><span class="tok-s2">]&quot;</span><span class="tok-p">)</span>
        <span class="tok-k">unless</span> <span class="tok-vi">@queue</span><span class="tok-o">.</span><span class="tok-n">num_waiting</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Notifying worker&#39;</span><span class="tok-p">)</span>
          <span class="tok-vi">@queue</span><span class="tok-o">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">task_class</span><span class="tok-p">)</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
    <span class="tok-c1"># …</span>
  <span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le nom de la classe de la tâche est envoyé dans la notification pour être logué, mais ne sert pas dans le reste du code, en tous cas pour le moment.</p>
</div>
<div class="paragraph">
<p>Il faut penser à ajouter une connexion à la configuration de la base de donnée plus haut dans le fichier&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-c1"># Use at most one connexion per worker + the connexion for notifications</span>
  <span class="tok-no">DB</span> <span class="tok-o">=</span> <span class="tok-o">::</span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">connect</span><span class="tok-p">(</span><span class="tok-no">DATABASE_URL</span><span class="tok-p">,</span> <span class="tok-ss">max_connections</span><span class="tok-p">:</span> <span class="tok-no">WORKERS_NUMBER</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-ss">logger</span><span class="tok-p">:</span> <span class="tok-no">LOGGER</span><span class="tok-p">)</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_envoyer_une_notification_ou_le_contenu_dune_tâche">Envoyer une notification ou le contenu d&#8217;une tâche</h3>
<div class="paragraph">
<p>Dans le modèle que je décris, le moteur de tâches reçoit des notification l&#8217;informant qu&#8217;une tâche devient disponible et il doit ensuite acquérir la tâche dans la base de données, et en passant récupérer les paramètres d&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>Cela vient du fait que dans le système de notification de PostgreSQL les notifications sont envoyées à toutes les instances qui sont à l&#8217;écoute.</p>
</div>
<div class="paragraph">
<p>D&#8217;autres système de messages (par exemple ActiveMQ) permettent que chaque message ne soit reçu que par une instance au plus.
Dans ce cas l&#8217;acquisition de la tâche et la récupération des paramètres sont concentrés en une seule action&#160;: un moteur de tâches qui reçoit un message sait qu&#8217;il est le seul dans ce cas et peut donc directement exécuter la tâche.</p>
</div>
<div class="paragraph">
<p>Pour reprendre le vocabulaire de la partie 3, les systèmes de message comme ActiveMQ peuvent fournir plus ou moins du &#8220;<em>exactly once</em>&#8221;.
Comme indiqué dans la partie 3, ce type de mécanisme est très difficile à mettre en œuvre de manière fiable, et en cas de crash du bus de message il y a des chances (même si elles sont faibles) que vous receviez le même message deux fois, il faut donc être préparé à cette éventualité.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pourquoi_ne_pas_utiliser_une_id_pour_récupérer_la_prochaine_tâche">Pourquoi ne pas utiliser une <code>id</code> pour récupérer la prochaine tâche&#160;?</h3>
<div class="paragraph">
<p>Lors de la création d&#8217;une tâche, le code connaît la tâche à créer et ses paramètres.</p>
</div>
<div class="paragraph">
<p>On pourrait vouloir utiliser ces informations pour simplifier l&#8217;acquisition de tâches{nsbp}: quand réveille un worker, au lieu de chercher la prochaine tâche à exécuter avec la requête existante, il pourrais plutôt chercher la tâche par son <code>id</code> une requête qui cherche si la tâche avec un certain <code>id</code> est toujours disponible, ce qui devrait rendre la requête plus rapide.</p>
</div>
<div class="paragraph">
<p>Malheureusement cette solution n&#8217;est pas adaptée au fait d&#8217;avoir plusieurs {mdts} qui s&#8217;exécutent simultanément.</p>
</div>
<div class="paragraph">
<p>Par exemple si du code créé deux tâches T1 et T2, et que deux instances du moteur de tâches disposent de workers en sommeil.
En utilisant la requête par défaut, le premier worker à se réveiller va récupérer T1, et le deuxième worker T2.
Si les deux workers cherchent T1 par son <code>id</code>, le premier worker va la trouver mais pas le deuxième.</p>
</div>
<div class="paragraph">
<p>Il lui faudra alors utiliser la requête par défaut pour déterminer si une autre tâche est disponible.
En échange d&#8217;une requête plus rapide, on aura donc exécuté une requête inutile.</p>
</div>
<div class="paragraph">
<p>Utiliser la requête générique évite donc cela, tout en gardant le code un peu plus simple.</p>
</div>
</div>
<div class="sect2">
<h3 id="_la_partie_notification">La partie notification</h3>
<div class="paragraph">
<p>Pour déclencher la notification, j&#8217;ajoute l&#8217;appel à la méthode <code>notify</code> lors de la création d&#8217;une tâche&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-c1"># @param [String] task_class</span>
  <span class="tok-c1"># @param [Hash] task_parameters</span>
  <span class="tok-k">def</span> <span class="tok-nc">self</span><span class="tok-o">.</span><span class="tok-nf">create_task</span><span class="tok-p">(</span><span class="tok-n">task_class</span><span class="tok-p">,</span> <span class="tok-n">task_parameters</span><span class="tok-p">)</span>
    <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span>
        <span class="tok-ss">task_class</span><span class="tok-p">:</span> <span class="tok-n">task_class</span><span class="tok-p">,</span>
        <span class="tok-ss">task_parameters</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span><span class="tok-n">task_parameters</span><span class="tok-p">)</span>
    <span class="tok-p">)</span>
    <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">notify</span><span class="tok-p">(</span><span class="tok-no">NOTIFICATION_CHANNEL</span><span class="tok-p">,</span> <span class="tok-ss">payload</span><span class="tok-p">:</span> <span class="tok-n">task_class</span><span class="tok-p">)</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut tester le fonctionnement en lançant le moteur de tâches dans une console, et en lançant la création de tâche dans une autre&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ TASK_ENGINE_INSTANCE=instance_01 rake start_engine

Worker 2 is sleeping
Worker 3 is sleeping
Worker 0 is sleeping
Worker 1 is sleeping
Worker 4 is sleeping
Received notification for a task [TaskEngine::Tasks::WaitingTask]
Notifying worker
Worker 2 is awaken
Received notification for a task [TaskEngine::Tasks::WaitingTask]
Notifying worker
Worker 3 is awaken
Received notification for a task [TaskEngine::Tasks::WaitingTask]
Worker 2 starting task 1601</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_notifications_et_transations">Notifications et transations</h3>
<div class="paragraph">
<p>Une des avantages d&#8217;utiliser le même outil pour stocker les données et gérer les messages et que les mêmes transactions s&#8217;appliquent aux deux.</p>
</div>
<div class="paragraph">
<p>Ainsi dans le code de <code>TaskEngine.create_task</code>, l&#8217;insertion de la tâche et l&#8217;envoi de la notification se font dans la même transaction que le code appelant.</p>
</div>
<div class="paragraph">
<p>Cela signifie que qu&#8217;en cas de <code>rollback</code> la tâche n&#8217;est pas crée et la notification envoyée.</p>
</div>
<div class="paragraph">
<p>Par exemple si une tâche a besoin d&#8217;un objet métier créé juste avant, si la tâche est créée puis que la création de l&#8217;objet est rollbackée, la tâche ne pourra pas le trouver.</p>
</div>
<div class="paragraph">
<p>Si vos traitements ont un risque significatif de <code>rollbak</code>, cela peut être assez pratique car cela évite d&#8217;avoir à prendre en compte cette situation dans le code de la tâche.</p>
</div>
<div class="paragraph">
<p>En effet un <code>rollback</code> de transaction ne signifie pas forcément qu&#8217;une erreur s&#8217;est produite, mais peut être le signe d&#8217;une tentative de modification concurrente dans la base de données, et dans ce cas arriver régulièrement.</p>
</div>
<div class="paragraph">
<p>Si on ne souhaite pas ce comportement, la création de tâche peut être isolée dans une transaction séparée dans le code applicatif, mais le comportement par défaut fournit une garantie qui peut être bien pratique.</p>
</div>
<div class="paragraph">
<p>Maintenant que le moteur sait traiter les ajouts de tâche, je vais m&#8217;intéresser au monitoring pour pouvoir commencer à suivre ce qui se passe.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-08">Partie 8 : le monitoring unitaire</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour le moment quand une tâche a été exécutée elle est effacée et on n&#8217;en garde aucune trace, à part dans les logs.</p>
</div>
<div class="paragraph">
<p>Parser les logs est faisable, mais extraire certaines lignes parmi une myriades d&#8217;autres est toujours risqué et je préfère donc les stocker dans un endroit spécifique.</p>
</div>
<div class="paragraph">
<p>Comme expliqué dans la troisième partie, je vais les stocker dans PostgreSQL comme les données des tâches à exécuter.</p>
</div>
<div class="paragraph">
<p>Cela me permettra de faire des liens entre les informations de monitoring et les tâches.</p>
</div>
<div class="sect2">
<h3 id="_les_informations_de_monitoring">Les informations de monitoring</h3>
<div class="paragraph">
<p>Pour l&#8217;instant lors de l&#8217;exécution d&#8217;une tâche, trois informations sont disponibles&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l&#8217;heure de début d&#8217;exécution</p>
</li>
<li>
<p>l&#8217;heure de fin d&#8217;exécution</p>
</li>
<li>
<p>le résultat de l&#8217;exécution des tâches</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dans les trois, la première est présente dès le début de l&#8217;exécution de la tâche, et elle peut donc être définie comme non-nullable. Les autres seront renseignées à la fin de la tâche. Le résultat de l&#8217;exécution de tâches sera stocké dans une colonne de type <code>jsonb</code>, pour les même raisons que les paramètres des tâches.</p>
</div>
<div class="paragraph">
<p>Il faut aussi ajouter un nouveau statut <code>stopped</code> aux tâches qui indique qu&#8217;elles ont été exécutées, puisqu&#8217;elles ne seront plus supprimées.</p>
</div>
<div class="listingblock">
<div class="title">migrations/04_create_task_executions.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">add_enum_value</span><span class="tok-p">(</span><span class="tok-ss">:task_status</span><span class="tok-p">,</span> <span class="tok-s1">&#39;stopped&#39;</span><span class="tok-p">)</span>

    <span class="tok-n">create_table</span><span class="tok-p">(</span><span class="tok-ss">:task_executions</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">primary_key</span> <span class="tok-ss">:id</span>
      <span class="tok-n">foreign_key</span> <span class="tok-ss">:task_id</span><span class="tok-p">,</span> <span class="tok-ss">:tasks</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-no">DateTime</span> <span class="tok-ss">:started_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-no">DateTime</span> <span class="tok-ss">:stopped_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">true</span>
      <span class="tok-n">column</span> <span class="tok-ss">:result</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JSONB&#39;</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">true</span>

      <span class="tok-no">DateTime</span> <span class="tok-ss">:created_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-no">DateTime</span> <span class="tok-ss">:updated_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite j&#8217;ajoute la déclaration du modèle, en modifiant la définition de <code>Task</code> pour ajouter le nouveau statut la relation entre les deux&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Task</span> <span class="tok-o">&lt;</span> <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span>
    <span class="tok-no">STATUS_WAITING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span>
    <span class="tok-no">STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
    <span class="tok-no">STATUS_STOPPED</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;stopped&#39;</span>
    <span class="tok-n">one_to_many</span> <span class="tok-ss">:task_executions</span>
  <span class="tok-k">end</span>
  <span class="tok-k">class</span> <span class="tok-nc">TaskExecution</span> <span class="tok-o">&lt;</span> <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span>
    <span class="tok-n">many_to_one</span> <span class="tok-ss">:task</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lajout_des_informations">L&#8217;ajout des informations</h3>
<div class="paragraph">
<p>Reste à ajouter l&#8217;insertion et la mise à jour des informations d&#8217;exécution&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>
    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-k">while</span> <span class="tok-c1"># …</span>
        <span class="tok-n">starting_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> starting task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>

        <span class="tok-n">task_execution</span> <span class="tok-o">=</span> <span class="tok-kp">nil</span>
        <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
          <span class="tok-n">task_execution</span> <span class="tok-o">=</span> <span class="tok-no">TaskExecution</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span>
              <span class="tok-ss">task</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-p">,</span>
              <span class="tok-ss">started_at</span><span class="tok-p">:</span> <span class="tok-n">starting_time</span>
          <span class="tok-p">)</span>
        <span class="tok-k">end</span>

        <span class="tok-n">task_class_name</span> <span class="tok-o">=</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">task_class</span>
        <span class="tok-n">task_class</span> <span class="tok-o">=</span> <span class="tok-no">Object</span><span class="tok-o">.</span><span class="tok-n">const_get</span><span class="tok-p">(</span><span class="tok-n">task_class_name</span><span class="tok-p">)</span>
        <span class="tok-n">task_instance</span> <span class="tok-o">=</span> <span class="tok-n">task_class</span><span class="tok-o">.</span><span class="tok-n">new</span>
        <span class="tok-n">task_result</span> <span class="tok-o">=</span> <span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">task_parameters</span><span class="tok-p">)</span>

        <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
        <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> finished task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">, took </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms&quot;</span><span class="tok-p">)</span>

        <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
          <span class="tok-n">task_execution</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
              <span class="tok-ss">stopped_at</span><span class="tok-p">:</span> <span class="tok-n">stopping_time</span><span class="tok-p">,</span>
              <span class="tok-ss">result</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span><span class="tok-n">task_result</span><span class="tok-p">),</span>
              <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">TaskExecution</span><span class="tok-o">::</span><span class="tok-no">STATUS_SUCCESS</span>
          <span class="tok-p">)</span>
          <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
              <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_STOPPED</span>
          <span class="tok-p">)</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
      <span class="tok-c1"># …</span>
    <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_le_test">Le test</h3>
<div class="paragraph">
<p>On peut ensuite tester le résultat&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ TASK_ENGINE_INSTANCE=instance_01 rake start_engine

Starting engine
Starting worker 0
Joining worker 0
(0.000138s) BEGIN
(0.000793s) SELECT * FROM &quot;tasks&quot; WHERE (&quot;status&quot; = &#39;waiting&#39;) ORDER BY &quot;created_at&quot; LIMIT 1 FOR UPDATE
(0.001295s) UPDATE &quot;tasks&quot; SET &quot;status&quot; = &#39;running&#39;, &quot;instance&quot; = &#39;engine_1&#39; WHERE (&quot;id&quot; = 201)
(0.000911s) COMMIT
Worker 0 starting task 201
(0.000130s) BEGIN
(0.000946s) INSERT INTO &quot;task_executions&quot; (&quot;task_id&quot;, &quot;started_at&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (201, &#39;2020-08-10 16:52:54.054783+0200&#39;, &#39;2020-08-10 16:52:54.055373+0200&#39;, &#39;2020-08-10 16:52:54.055373+0200&#39;) RETURNING *
(0.000474s) COMMIT
Worker 0 finished task 201, took 5007.844ms
(0.000365s) BEGIN
(0.000829s) UPDATE &quot;task_executions&quot; SET &quot;stopped_at&quot; = &#39;2020-08-10 16:52:59.062627+0200&#39;, &quot;result&quot; = &#39;null&#39;::jsonb, &quot;updated_at&quot; = &#39;2020-08-10 16:52:59.063566+0200&#39; WHERE (&quot;id&quot; = 6)
(0.000355s) BEGIN
(0.000551s) UPDATE &quot;tasks&quot; SET &quot;status&quot; = &#39;stopped&#39; WHERE (&quot;id&quot; = 201)
(0.001536s) COMMIT</code></pre>
</div>
</div>
<div class="paragraph">
<p>La table <code>task_executions</code> contient bien les informations attendues&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ psql --user=task_engine --dbname=task_engine  --expanded --command=&quot;select * from task_executions&quot;

-[ RECORD 1 ]--------------------------
id         | 6
task_id    | 201
started_at | 2020-08-10 16:52:54.054783
stopped_at | 2020-08-10 16:52:59.062627
result     | null
created_at | 2020-08-10 16:52:54.055373
updated_at | 2020-08-10 16:52:59.063566
-[ RECORD 2 ]--------------------------
id         | 7
task_id    | 202
started_at | 2020-08-10 16:52:54.080271
stopped_at | 2020-08-10 16:52:59.091997
result     | null
created_at | 2020-08-10 16:52:54.080519
updated_at | 2020-08-10 16:52:59.09332</code></pre>
</div>
</div>
<div class="paragraph">
<p>La structure fonctionne donc et les données sont bien là, même si pour le moment on ne sait suivre que les tâches qui se terminent bien car la gestion d&#8217;erreur n&#8217;a pas encore été implémentée.</p>
</div>
<div class="paragraph">
<p>Et justement le dernier élément qui manque pour mettre en place cette gestion d&#8217;erreur est la capacité à planifier des tâches, qui sera traitée dans la partie suivante.</p>
</div>
</div>
<div class="sect2">
<h3 id="_et_un_index">Et un index</h3>
<div class="paragraph">
<p>Avant de terminer, il faut s&#8217;intéresser un peu à la performance.</p>
</div>
<div class="paragraph">
<p>Avec le temps la table <code>tasks</code> devrait contenir de plus en plus d&#8217;occurrences de tâches terminées (avec l&#8217;hypothèse que le nombre de tâches à exécuter devrait rester raisonnable).</p>
</div>
<div class="paragraph">
<p>Cela risque de ralentir et fur et à mesure la sélection des tâches à exécuter, car la requête a besoin pour le moment de parcourir tous les enregistrements de la table.</p>
</div>
<div class="paragraph">
<p>Pour éviter cela, je vais ajouter un index à la table <code>tasks</code>.</p>
</div>
<div class="paragraph">
<p>La requête est la suivante&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-k">SELECT</span> <span class="tok-o">*</span> <span class="tok-k">FROM</span> <span class="tok-ss">&quot;tasks&quot;</span> <span class="tok-k">WHERE</span> <span class="tok-p">(</span><span class="tok-ss">&quot;status&quot;</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span><span class="tok-p">)</span> <span class="tok-k">ORDER</span> <span class="tok-k">BY</span> <span class="tok-ss">&quot;created_at&quot;</span> <span class="tok-k">LIMIT</span> <span class="tok-mi">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Je pourrais simplement créer un index sur <code>statut</code>, ce qui ferait que la requête n&#8217;aurait qu&#8217;à parcourir les enregistrements qui ont le bon statut.</p>
</div>
<div class="paragraph">
<p>Mais pour que la recherche soit encore plus rapide, il est possible de créer un index sur les colonnes <code>statut</code> et <code>created_at</code>, de cette manière la recherche utilisera seulement l&#8217;index.</p>
</div>
<div class="paragraph">
<p>J&#8217;ajoute pour cela une nouvelle migration&#160;:</p>
</div>
<div class="listingblock">
<div class="title">migrations/05_create_task_index.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_index</span> <span class="tok-o">[</span><span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:created_at</span><span class="tok-o">]</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Après exécution de la migration, l&#8217;exécution de la requête utilise bien l&#8217;index pour faire la recherche&#160;:</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_explain_select_from_tasks_where_status_waiting_order_by_created_at_limit_1">explain SELECT * FROM "tasks" WHERE ("status" = 'waiting') ORDER BY "created_at" LIMIT 1;</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>Limit  (cost=0.14..0.30 rows=1 width=120)
  -&gt;  Index Scan using tasks_status_created_at_index on tasks  (cost=0.14..16.20 rows=100 width=120)
        Index Cond: (status = 'waiting'::task_status)</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-09">Partie 9 : la planification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jusqu&#8217;à présent il est seulement possible de créer des tâches à exécution immédiate.</p>
</div>
<div class="paragraph">
<p>Les tâches dont l&#8217;exécution n&#8217;est pas immédiate correspondent à deux cas&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les tâches dont on veut programmer des exécutions régulières, par exemple toutes les quelques minutes ou toutes les nuits à 03h12&#160;;</p>
</li>
<li>
<p>les tâches qu&#8217;on veut exécuter une seule fois mais dans le futur à une heure déterminée, elles sont peu utilisées directement par les applications, mais permette de faire de réessais plus tard en cas d&#8217;erreur.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_les_tâches_à_exécution_régulière">Les tâches à exécution régulière</h3>
<div class="paragraph">
<p>Les tâches à exécution régulière correspondent à ce qu&#8217;il est possible de faire avec l&#8217;utilitaire <a href="https://fr.wikipedia.org/wiki/Cron">cron</a> dans les système Unix et Linux.</p>
</div>
<div class="paragraph">
<p>Cela peut par exemple servir pour programmer des traitement d&#8217;archivage ou des rappels toutes les nuits.</p>
</div>
<div class="paragraph">
<p>La solution la plus simple est d&#8217;utiliser l&#8217;outil cron directement.
Même s&#8217;il est un peu passé de mode, il est fiable et bien documenté.</p>
</div>
<div class="paragraph">
<p>Lors d&#8217;un déploiement il est facile de mettre à jour la liste des tâches programmées si le fichier contenant la configuration cron fait partie du code.</p>
</div>
<div class="paragraph">
<p>Ses deux inconvénients majeurs pour cet usage sont&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l&#8217;impossibilité de modifier la configuration cron facilement, par exemple à travers une interface graphique</p>
</li>
<li>
<p>le fait que les commandes cron doivent être lancées sur une seule machine (sinon les tâches seront créés autant de fois qu&#8217;il y a de machines), ce qui peut poser des contraintes de disponibilité.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si vous n&#8217;êtes pas dans une de ces situations, cron peut donc parfaitement faire l&#8217;affaire.</p>
</div>
<div class="paragraph">
<p>Pour créer les tâches depuis cron, il y a deux manières de faire :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Lancer une commande Ruby qui va faire l&#8217;insertion en utilisant la méthode <code>TaskEngine.create_task</code>.</p>
</li>
<li>
<p>Faire directement l&#8217;insertion en base de donnée en utilisant du SQL et <a href="https://www.postgresql.org/docs/current/app-psql.html">psql</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La première a l&#8217;avantage de la simplicité de mise en œuvre, par contre elle a l&#8217;inconvénient de lancer une machine virtuelle Ruby pour exécuter deux commandes SQL très simple (l&#8217;insertion de la tâche et la notification).</p>
</div>
<div class="paragraph">
<p>L&#8217;inconvénient principal de la seconde manière est que le format des données dans la base devient une API.
En effet s&#8217;il change il faudra modifier le code Ruby mais peut-être aussi les scripts qui accèdent directement à la base.</p>
</div>
<div class="paragraph">
<p>Si c&#8217;est une approche qui est plutôt à éviter lorsqu&#8217;il s&#8217;agit d&#8217;une API exposée à d&#8217;autres systèmes, elle peut être acceptable ici vu que la programmation des tâches fait partie du même ensemble applicatif.</p>
</div>
<div class="paragraph">
<p>Je ne vais détailler l&#8217;utilisation de cron, il y a déjà bien assez de documentation à ce sujet, et je vais donc passer aux tâches à exécution unique.</p>
</div>
</div>
<div class="sect2">
<h3 id="_les_tâches_à_exécution_unique">Les tâches à exécution unique</h3>
<div class="paragraph">
<p>Ces tâches ressemblent beaucoup aux tâches existantes, sauf qu&#8217;elles doivent s&#8217;exécuter dans le futur plutôt qu&#8217;immédiatement.</p>
</div>
<div class="paragraph">
<p>Jusqu&#8217;à présent, une tâche dans l&#8217;état <code>waiting</code> était forcément prête à être exécutée.</p>
</div>
<div class="paragraph">
<p>Je vais devoir changer ce comportement pour prendre en compte qu&#8217;une tâche puisse être en attente mais pas encore prête à être exécutée tout de suite.</p>
</div>
<div class="paragraph">
<p>Pour cela, je vais ajouter un nouveau champ <code>scheduled_at</code> qui contiendra l&#8217;heure à partir de laquelle la tâche peut être exécutée, avec pour valeur par défaut l&#8217;heure actuelle pour que la tâche puisse se lancer immédiatement.</p>
</div>
<div class="paragraph">
<p>L&#8217;implémentation va au final toucher peu de code.</p>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord la migration qui ajoute le champ et qui recrée un nouvel index sur les colonnes <code>statut</code> et <code>scheduled_at</code> pour accélerer la requête de sélection de la prochaine tâche à exécute tout en supprimant l&#8217;index existant.</p>
</div>
<div class="listingblock">
<div class="title">migrations/06_add_scheduled_at.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:scheduled_at</span><span class="tok-p">,</span> <span class="tok-no">DateTime</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-ss">default</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">lit</span><span class="tok-p">(</span><span class="tok-s1">&#39;LOCALTIMESTAMP&#39;</span><span class="tok-p">)</span>
      <span class="tok-n">drop_index</span> <span class="tok-o">[</span><span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:created_at</span><span class="tok-o">]</span>
      <span class="tok-n">add_index</span> <span class="tok-o">[</span><span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:scheduled_at</span><span class="tok-o">]</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Je préfère la base de donnée se charge de donner la valeur par défaut de la colonne (qui correspond à l&#8217;heure en cours) car cela évite d&#8217;avoir à dépendre du fait que les différents clients soient bien à l&#8217;heure.
Comme la base de données est unique, cela garantit la cohérence des valeurs.</p>
</div>
<div class="paragraph">
<p>Ensuite l&#8217;ajout du paramètre permettant de spécifier la valeur lors de la création d&#8217;une tâche&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-c1"># @param [String] task_class</span>
  <span class="tok-c1"># @param [Hash] task_parameters</span>
  <span class="tok-c1"># @param [DateTime, nil] scheduled_at nil means an immediate execution</span>
  <span class="tok-k">def</span> <span class="tok-nc">self</span><span class="tok-o">.</span><span class="tok-nf">create_task</span><span class="tok-p">(</span><span class="tok-n">task_class</span><span class="tok-p">,</span> <span class="tok-n">task_parameters</span><span class="tok-p">,</span> <span class="tok-n">scheduled_at</span> <span class="tok-o">=</span> <span class="tok-kp">nil</span><span class="tok-p">)</span>
    <span class="tok-n">creation_params</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-ss">task_class</span><span class="tok-p">:</span> <span class="tok-n">task_class</span><span class="tok-p">,</span>
        <span class="tok-ss">task_parameters</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span><span class="tok-n">task_parameters</span><span class="tok-p">)</span>
    <span class="tok-p">}</span>
    <span class="tok-c1"># Don&#39;t send a null value to the DB so the DB use the default value</span>
    <span class="tok-k">unless</span> <span class="tok-n">scheduled_at</span><span class="tok-o">.</span><span class="tok-n">nil?</span>
      <span class="tok-n">creation_params</span><span class="tok-o">[</span><span class="tok-ss">:scheduled_at</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">scheduled_at</span>
    <span class="tok-k">end</span>
    <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">creation_params</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">scheduled_at</span><span class="tok-o">.</span><span class="tok-n">nil?</span>
      <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">notify</span><span class="tok-p">(</span><span class="tok-no">NOTIFICATION_CHANNEL</span><span class="tok-p">,</span> <span class="tok-ss">payload</span><span class="tok-p">:</span> <span class="tok-n">task_class</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si le paramètre <code>scheduled_at</code> est spécifié, et que la tâche est programmée pour s&#8217;exécutée plus tard, il n&#8217;est pas nécessaire d&#8217;envoyer de notification car les notifications servent à réveiller des workers pour une exécution immédiate.</p>
</div>
<div class="paragraph">
<p>Le dernier élément à modifier est la requête qui cherche la prochaine tâche à exécuter, qui doit maintenant faire un tri sur <code>scheduled_at</code> plutôt que <code>created_at</code>, et qui doit également ignorer les tâches dont la valeur de <code>scheduled_at</code> est dans le futur.</p>
</div>
<div class="paragraph">
<p>Comme pour la valeur par défaut, je vais laisser la base définir l&#8217;heure actuelle.
<code>Sequel.lit</code> indique à Sequel d&#8217;utiliser la valeur telle-quelle sans l&#8217;interpréter, elle est utile comme lorsqu&#8217;ici on utilise des fonctions SQL.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>
    <span class="tok-c1"># @return [TaskEngine::Task, nil]</span>
    <span class="tok-k">def</span> <span class="tok-nf">try_acquire_task</span>
      <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
        <span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-no">Task</span><span class="tok-o">.</span>
            <span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_WAITING</span><span class="tok-p">)</span><span class="tok-o">.</span>
            <span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">lit</span><span class="tok-p">(</span><span class="tok-s1">&#39;scheduled_at &lt; LOCALTIMESTAMP&#39;</span><span class="tok-p">))</span><span class="tok-o">.</span>
            <span class="tok-n">order</span><span class="tok-p">(</span><span class="tok-ss">:scheduled_at</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">for_update</span><span class="tok-o">.</span><span class="tok-n">first</span>
        <span class="tok-k">unless</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">nil?</span>
          <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
              <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_RUNNING</span><span class="tok-p">,</span>
              <span class="tok-ss">instance</span><span class="tok-p">:</span> <span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">instance</span>
          <span class="tok-p">)</span>
          <span class="tok-n">task</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut vérifier que si on créé des tâches dans le futur, elles ne sont pas immédiatement exécutées.</p>
</div>
<div class="paragraph">
<p>Je vais créer une tâche qui doit s&#8217;exécuter 30 secondes dans le futur.
Pour cela j&#8217;ajoute la fraction <code>30 / 86400</code> (c&#8217;est-à-dire le nombre standard de secondes dans un jour) à l&#8217;heure actuelle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ bundle exec irb
require_relative &#39;task_engine&#39;
TaskEngine.create_task(
    &#39;TaskEngine::Tasks::WaitingTask&#39;,
    {
        waiting_time: 5
    },
    DateTime.now + Rational(30, 86400))
exit

$ TASK_ENGINE_INSTANCE=instance_01 rake start_engine</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord comme prévu il ne se passe rien, car la date est dans le futur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_allo_la_tâche">Allo la tâche ?</h3>
<div class="paragraph">
<p>Mais au bout de 30 secondes il ne se passe rien non plus.
Le problème c&#8217;est qu&#8217;en l&#8217;absence de notification aucun worker ne vérifie si la tâche est disponible pour être exécutée.</p>
</div>
<div class="paragraph">
<p>Si une autre tâche était créée en exécution immédiate après que les 30 secondes se soient passées, cela réveillerait un worker, et la tâche programmée serait traitée, mais tant qu&#8217;aucune tâche immédiate n&#8217;est créée, la tâche programmée restera à attendre.</p>
</div>
<div class="paragraph">
<p>Si de nouvelles tâches à exécution immédiates sont crées régulièrement, cette attente peut ne pas être un problème, mais peut-être que ça n&#8217;est pas le cas, ou que même si c&#8217;est le cas en principe, on peut préférer garantir que la tâche ne va pas attendre trop longtemps, en tous cas si des workers sont disponibles.</p>
</div>
<div class="paragraph">
<p>La manière idéale de faire serait faire en sorte de réveiller un worker dès qu&#8217;une tâche devient exécutable, mais il n&#8217;y a pas d&#8217;approche facile pour le faire avec les outils que j&#8217;ai choisis.</p>
</div>
<div class="paragraph">
<p>Une approche possible serait d&#8217;envoyer une notification lors de chaque création de ces tâches, et que les instances de moteur de tâches programment un réveil de worker pour chaque moment où au moins une des tâches doit s&#8217;exécuter.</p>
</div>
<div class="paragraph">
<p>Mais elle a cependant deux inconvénients.</p>
</div>
<div class="paragraph">
<p>Le premier est est que cela augmenterait la consommation mémoire des instances du moteur de tâches, avec un risque de dépassement mémoire si trop de tâches sont crées.</p>
</div>
<div class="paragraph">
<p>Le second est que le fonctionnement se mettrait à dépendre du fait que les instances de moteur de tâches ne soient pas redémarrées, car alors les informations de réveil seraient perdus.</p>
</div>
<div class="paragraph">
<p>Je vais plutôt partir du principe que si une tâche est programmée pour s&#8217;exécuter dans le futur, ce n&#8217;est pas grave si elle a quelques secondes de retard.
Cela me permet de choisir une approche moins fine mais qui n&#8217;a pas les deux inconvénients cités plus hauts.</p>
</div>
<div class="paragraph">
<p>Ma solution sera de programmer à intervalle régulier des &#8220;réveils&#8221; qui reproduiront le même mécanisme que la réception d&#8217;une notification en poussant un élément dans la <code>Queue</code> où attendent les workers disponibles.
Cela signifie envoyer un message pour réveiller un éventuel worker disponible, qui ira voir si une tâche est prête à être exécutée.</p>
</div>
<div class="paragraph">
<p>Pour cela je vais créer un nouveau <code>Thread</code> qui sera dédié à cet usage&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Engine</span>
    <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span>
      <span class="tok-c1"># …</span>

      <span class="tok-c1"># Scheduled wake-ups</span>
      <span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
        <span class="tok-k">while</span> <span class="tok-kp">true</span> <span class="tok-k">do</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Scheduled wake-up&#39;</span><span class="tok-p">)</span>
          <span class="tok-vi">@queue</span><span class="tok-o">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-s1">&#39;Scheduled wake-up&#39;</span><span class="tok-p">)</span>
          <span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">)</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
      <span class="tok-c1"># …</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le temps entre deux réveil, ici fixé à 10 seconde, correspond au temps maximum d&#8217;attente pour une tâche programmée, si des workers sont disponibles.</p>
</div>
<div class="paragraph">
<p>En effet si les workers sont déjà tous occupées à traiter un arriéré de tâches, il peut s&#8217;écouler un certain temps avant qu&#8217;une tâche programmée qui vient de devenir exécutable soit effectivement lancée.</p>
</div>
<div class="paragraph">
<p>Maintenant qu&#8217;il est possible de créer des tâches qui s&#8217;exécuteront plus tard, je vais pouvoir m&#8217;en servir pour mettre en place la gestion d&#8217;erreur.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-10">Partie 10 : la gestion d&#8217;erreurs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Parfois les choses se passent mal, et le code plante.
Cela se produit même plus que parfois quand il s&#8217;agit de faire des appels réseaux, c&#8217;est-à-dire typiquement le genre de choses que fait un moteur de tâches.</p>
</div>
<div class="paragraph">
<p>Il faut donc que le moteur de tâches puisse prendre en compte cette possibilité.</p>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord il faut que, autant que possible, une erreur dans une tâche n&#8217;ait pas de conséquence sur le moteur de tâches.
Cela vaut bien entendu pour les erreurs applicatives, on ne peut pas grande chose face un crash de la machine virtuelle pour cause de mémoire insuffisante.</p>
</div>
<div class="paragraph">
<p>Ensuite il faut pouvoir monitorer ce qui s&#8217;est passé, en stockant les messages d&#8217;erreurs et les heures d&#8217;exécutions pour pouvoir aider à comprendre.</p>
</div>
<div class="paragraph">
<p>En finalement il faut pouvoir relancer les tâches, en effet l&#8217;expérience prouve que de relancer les tâches automatiquement un peu plus tard est souvent la bonne solution car beaucoup de problèmes sont temporaires.</p>
</div>
<div class="sect2">
<h3 id="_une_tâche_qui_plante">Une tâche qui plante</h3>
<div class="paragraph">
<p>La première chose à faire est d&#8217;avoir une tâche qui plante pour pouvoir tester ce qui va suivre.</p>
</div>
<div class="paragraph">
<p>Jusqu&#8217;ici le seul type de tâche qui existait était la <code>WaitingTask</code>, je vais donc ajouter une <code>FailingTask</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="title">tasks.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">module</span> <span class="tok-nn">Tasks</span>
    <span class="tok-k">class</span> <span class="tok-nc">FailingTask</span>
      <span class="tok-c1"># @param [Hash] parameters</span>
      <span class="tok-c1"># @return [Hash, nil]</span>
      <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
        <span class="tok-mi">1</span> <span class="tok-o">/</span> <span class="tok-mi">0</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme il n&#8217;y aucune gestion d&#8217;erreur pour le moment, la division par zéro fait planter l&#8217;instance du moteur de tâches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>#&lt;Thread:0x00007fa2531e5a30 /task_engine.rb:123 run&gt; terminated with exception (report_on_exception is true):
Traceback (most recent call last):
	3: from /task_engine.rb:124:in `block in initialize&#39;
	2: from /task_engine.rb:144:in `execute&#39;
	1: from /tasks.rb:18:in `execute&#39;
/tasks.rb:18:in `/&#39;: divided by 0 (ZeroDivisionError)
^CI, [2020-09-18T21:16:54.385296 #53807]  INFO -- : Worker 2 is awaken
I, [2020-09-18T21:16:54.385604 #53807]  INFO -- : Worker 2 is stopping
I, [2020-09-18T21:16:54.385467 #53807]  INFO -- : Worker 4 is awaken
I, [2020-09-18T21:16:54.385714 #53807]  INFO -- : Worker 4 is stopping
I, [2020-09-18T21:16:54.385403 #53807]  INFO -- : Worker 0 is awaken
I, [2020-09-18T21:16:54.385818 #53807]  INFO -- : Worker 0 is stopping
I, [2020-09-18T21:16:54.385541 #53807]  INFO -- : Worker 3 is awaken
I, [2020-09-18T21:16:54.386093 #53807]  INFO -- : Worker 3 is stopping
I, [2020-09-18T21:16:54.385996 #53807]  INFO -- : Joining worker 1
rake aborted!
ZeroDivisionError: divided by 0
/tasks.rb:18:in `/&#39;
/tasks.rb:18:in `execute&#39;
/task_engine.rb:144:in `execute&#39;
/task_engine.rb:124:in `block in initialize&#39;
Tasks: TOP =&gt; start_engine</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour mettre en place la gestion d&#8217;erreur je vais commencer par enrichir le modèle de données&#160;: dans la table <code>task_executions</code> je vais ajouter un <code>status</code> pour déclarer que l&#8217;exécution a eu une erreur, et une <code>error</code> pour pouvoir enregistrer les informations sur l&#8217;erreur.</p>
</div>
<div class="listingblock">
<div class="title">migrations/07_add_errors_to_task_execution.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">extension</span> <span class="tok-ss">:pg_enum</span>
    <span class="tok-n">create_enum</span><span class="tok-p">(</span><span class="tok-ss">:task_execution_status</span><span class="tok-p">,</span> <span class="tok-o">[</span><span class="tok-s1">&#39;running&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;success&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;failure&#39;</span><span class="tok-o">]</span><span class="tok-p">)</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:task_executions</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:task_execution_status</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:error</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JSONB&#39;</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">true</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le <code>status</code> <code>running</code> va correspondre aux tâches en cours d&#8217;exécution.
Jusque là il était possible de déterminer qu&#8217;une exécution n&#8217;était pas terminée en regardant si colonne <code>stopped_at</code> était vide.
Mais comme je préfère que la colonne <code>status</code> ne soit pas nullable pour éviter les oublis, j&#8217;ai besoin d&#8217;un <code>status</code> pendant l&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>La première chose est d&#8217;ensuite de déclarer les <code>status</code> comme des constantes dans la classe <code>TaskExecution</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">TaskExecution</span> <span class="tok-o">&lt;</span> <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span>
    <span class="tok-no">STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
    <span class="tok-no">STATUS_SUCCESS</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;success&#39;</span>
    <span class="tok-no">STATUS_FAILURE</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;failure&#39;</span>
    <span class="tok-n">many_to_one</span> <span class="tok-ss">:task</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et je peux maintenant ajouter le début de la gestion d&#8217;erreur&#160;: quand l&#8217;exécution d&#8217;une tâche renvoie une exception, elle sera déclarée en erreur et l&#8217;erreur sera enregistrée sous la forme du message d&#8217;erreur, de la classe de l&#8217;exception, et de la pile d&#8217;appel.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>
    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-c1"># …</span>
      <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-no">Engine</span><span class="tok-o">::</span><span class="tok-no">ENGINE_STATUS_RUNNING</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-p">(</span><span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-n">try_acquire_task</span><span class="tok-p">)</span>
        <span class="tok-n">starting_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> starting task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>

        <span class="tok-n">task_execution</span> <span class="tok-o">=</span> <span class="tok-kp">nil</span>
        <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
          <span class="tok-n">task_execution</span> <span class="tok-o">=</span> <span class="tok-no">TaskExecution</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span>
              <span class="tok-ss">task</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-p">,</span>
              <span class="tok-ss">started_at</span><span class="tok-p">:</span> <span class="tok-n">starting_time</span><span class="tok-p">,</span>
              <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">TaskExecution</span><span class="tok-o">::</span><span class="tok-no">STATUS_RUNNING</span>
          <span class="tok-p">)</span>
        <span class="tok-k">end</span>

        <span class="tok-n">task_class_name</span> <span class="tok-o">=</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">task_class</span>
        <span class="tok-k">begin</span>
          <span class="tok-n">task_class</span> <span class="tok-o">=</span> <span class="tok-no">Object</span><span class="tok-o">.</span><span class="tok-n">const_get</span><span class="tok-p">(</span><span class="tok-n">task_class_name</span><span class="tok-p">)</span>
          <span class="tok-n">task_instance</span> <span class="tok-o">=</span> <span class="tok-n">task_class</span><span class="tok-o">.</span><span class="tok-n">new</span>
          <span class="tok-n">task_result</span> <span class="tok-o">=</span> <span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">task_parameters</span><span class="tok-p">)</span>

          <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
          <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> finished successfully task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> in </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms, result is </span><span class="tok-si">#{</span><span class="tok-n">result</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
          <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
            <span class="tok-n">task_execution</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                <span class="tok-ss">stopped_at</span><span class="tok-p">:</span> <span class="tok-n">stopping_time</span><span class="tok-p">,</span>
                <span class="tok-ss">result</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span><span class="tok-n">task_result</span><span class="tok-p">),</span>
                <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">TaskExecution</span><span class="tok-o">::</span><span class="tok-no">STATUS_SUCCESS</span>
            <span class="tok-p">)</span>
              <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                  <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_STOPPED</span>
            <span class="tok-p">)</span>
          <span class="tok-k">end</span>
        <span class="tok-k">rescue</span> <span class="tok-no">Exception</span> <span class="tok-o">=&gt;</span> <span class="tok-n">e</span>
          <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
          <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> failed task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> in </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms, error is </span><span class="tok-si">#{</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">inspect</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
          <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
            <span class="tok-n">task_execution</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                <span class="tok-ss">stopped_at</span><span class="tok-p">:</span> <span class="tok-n">stopping_time</span><span class="tok-p">,</span>
                <span class="tok-ss">error</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span>
                    <span class="tok-p">{</span>
                        <span class="tok-ss">exception</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">class</span><span class="tok-p">,</span>
                        <span class="tok-ss">message</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">message</span><span class="tok-p">,</span>
                        <span class="tok-ss">backtrace</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">backtrace</span>
                    <span class="tok-p">}),</span>
                <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">TaskExecution</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILURE</span>
            <span class="tok-p">)</span>
            <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_STOPPED</span>
            <span class="tok-p">)</span>
          <span class="tok-k">end</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
      <span class="tok-c1"># …</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voici le résultat quand je rééessaie d&#8217;exécuter une <code>FailingTask</code>{nsbp}:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Worker 0 starting task 1
(0.000353s) BEGIN
(0.003452s) INSERT INTO &quot;task_executions&quot; (&quot;task_id&quot;, &quot;started_at&quot;, &quot;status&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (1, &#39;2020-09-18 21:53:03.890717+0200&#39;, &#39;running&#39;, &#39;2020-09-18 21:53:03.893951+0200&#39;, &#39;2020-09-18 21:53:03.893951+0200&#39;) RETURNING *
(0.000827s) COMMIT
Worker 0 failed task 1 in 9.501ms, error is #&lt;ZeroDivisionError: divided by 0&gt;
(0.000334s) BEGIN
(0.001450s) UPDATE &quot;task_executions&quot; SET &quot;stopped_at&quot; = &#39;2020-09-19 11:27:17.430026+0200&#39;, &quot;updated_at&quot; = &#39;2020-09-19 11:27:17.431071+0200&#39;, &quot;status&quot; = &#39;failure&#39;, &quot;error&quot; = &#39;{&quot;exception&quot;:&quot;ZeroDivisionError&quot;,&quot;message&quot;:&quot;divided by 0&quot;,&quot;backtrace&quot;:[&quot;/tasks.rb:18:in `/&#39;&#39;&quot;,&quot;/tasks.rb:18:in `execute&#39;&#39;&quot;,&quot;/task_engine.rb:149:in `execute&#39;&#39;&quot;,&quot;/task_engine.rb:127:in `block in initialize&#39;&#39;&quot;]}&#39;::jsonb WHERE (&quot;id&quot; = 1)
(0.000737s) UPDATE &quot;tasks&quot; SET &quot;status&quot; = &#39;stopped&#39; WHERE (&quot;id&quot; = 1)
(0.000681s) COMMIT</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_réessayer">Réessayer</h3>
<div class="paragraph">
<p>Comme décrit plus haut, il est souvent bénéfique de relancer une tâche qui a échoué pour les cas où la source de l&#8217;erreur était transitoire.</p>
</div>
<div class="paragraph">
<p>Cela signifie que les tâches doivent être prévues pour cela, par exemple si une tâche échoue à la fin de son exécution alors qu&#8217;elle a déjà effectués certains traitements des traitements, le fait de la relancer ne doit pas avoir d&#8217;effet secondaires.</p>
</div>
<div class="paragraph">
<p>Parfois cela est facile à faire, par exemple si toute la tâche s&#8217;exécute dans une seule transaction, mais si la tâche interagit avec des systèmes extérieurs cela peut être plus compliqué.</p>
</div>
<div class="paragraph">
<p>Pour un moteur de tâches, une manière de résoudre ce problème est de rendre le réessai configurable, je vais commencer par implémenter des réessais systématiques, puis j&#8217;ajouterai la configurabilité.</p>
</div>
<div class="paragraph">
<p>Quand on veut réessayer une tâche dans l&#8217;espoir que le problème qui l&#8217;empêchait de fonctionner ne se produira plus, il faut que le réessai ne soit pas immédiat.
En général on commence par réessayer un peu plus tard, puis encore un peu plus tard mais en attendant un peu plus, et ainsi de suite en augmentant à chaque fois la durée de l&#8217;attente.</p>
</div>
<div class="paragraph">
<p>Il s&#8217;agit de trouver un équilibre entre une attente plus longue, qui augmente les chances que le problème ait été résolu, et une attente trop longue qui deviendrait pénalisante.</p>
</div>
<div class="paragraph">
<p>Une approche souvent employée est d&#8217;utiliser des puissance de deux&#160;: le premier réessai se faut au bout de 2<sup>0</sup> = 1 minute, le second au bout de 2<sup>1</sup> = 2 minutes, puis 4, 8, 16…</p>
</div>
<div class="paragraph">
<p>Il faut aussi savoir abandonner, car au bout d&#8217;un moment réessayer ne sert plus à rien. Pour cela je vais définir un nombre maximum de réessais au bout duquel la tâche ne sera pas relancée.
Le choix de la valeur est un peu arbitraire et dépend de l&#8217;environnement dans lequel on se trouve.
Je vais choisir 10, ainsi la dernière tentative exécution se produira <code>1 + 2 + 4 + 8 + 16 + 32 + 64 + 128 + 256 + 512 = 1023</code> minutes après l&#8217;exécution initiale, soit un peu plus de 17 heures.</p>
</div>
<div class="paragraph">
<p>Si besoin, il serait possible de la rendre paramétrable, en utilisant par exemple le contexte que je vais ajouter juste en dessous.</p>
</div>
<div class="paragraph">
<p>Une tâche a besoin de savoir à quel numéro de réessai elle correspond, pour calculer l&#8217;heure du prochain rééssai et pour déterminer qu&#8217;il est temps de s&#8217;arrêter quand elle a atteint le nombre maximum.</p>
</div>
<div class="paragraph">
<p>Pour stocker cette information je pourrais utiliser les paramètres de la tâche, mais je préfère les réserver aux paramètres applicatifs.</p>
</div>
<div class="paragraph">
<p>Je vais donc ajouter une nouvelle colonne à la table <code>tasks</code>.
Plutôt que d&#8217;ajouter une colonne spécifique qui ne contiendrait que cette unique valeur, je vais créer une colonne de contexte au format <code>jsonb</code>.
L&#8217;idée est de pouvoir ensuite l&#8217;utiliser pour ajouter d&#8217;autre métadonnées si le moteur de tâches est étendu.</p>
</div>
<div class="paragraph">
<p>Je vais aussi avoir besoin d&#8217;un nouveau statut <code>failed</code> pour les tâches qui indiquer qu&#8217;elles ont épuisé leurs réessais.</p>
</div>
<div class="paragraph">
<p>Quand une tâche aura été relancée, il faudra donc distinguer le statut de la tâche des status de ses exécutions successives.
Une tâche en status <code>waiting</code> avec des exécutions en <code>failed</code> aura donc déjà été lancée et sera donc en train d&#8217;attendre une nouvelle tentative.</p>
</div>
<div class="listingblock">
<div class="title">migrations/08_add_task_context_and_task_failure</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">extension</span> <span class="tok-ss">:pg_enum</span>
    <span class="tok-n">add_enum_value</span><span class="tok-p">(</span><span class="tok-ss">:task_status</span><span class="tok-p">,</span> <span class="tok-s1">&#39;failed&#39;</span><span class="tok-p">)</span>

    <span class="tok-n">extension</span> <span class="tok-ss">:pg_json</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:context</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JSONB&#39;</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-ss">default</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">({})</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Je déclare le nouveau statut{nsbp}:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Task</span> <span class="tok-o">&lt;</span> <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span>
      <span class="tok-no">STATUS_WAITING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span>
      <span class="tok-no">STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
      <span class="tok-no">STATUS_STOPPED</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;stopped&#39;</span>
      <span class="tok-no">STATUS_FAILED</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;failed&#39;</span>
      <span class="tok-n">one_to_many</span> <span class="tok-ss">:task_executions</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Puis vient l&#8217;implémentation des réessais.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>

    <span class="tok-no">MAX_RETRIES_NUMBER</span> <span class="tok-o">=</span> <span class="tok-mi">10</span>

    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-c1"># …</span>
      <span class="tok-k">rescue</span> <span class="tok-no">Exception</span> <span class="tok-o">=&gt;</span> <span class="tok-n">e</span>
        <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
        <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> failed task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> in </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms, error is </span><span class="tok-si">#{</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">inspect</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
        <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
          <span class="tok-n">task_execution</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
              <span class="tok-ss">stopped_at</span><span class="tok-p">:</span> <span class="tok-n">stopping_time</span><span class="tok-p">,</span>
              <span class="tok-ss">error</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span>
                  <span class="tok-p">{</span>
                      <span class="tok-ss">exception</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">class</span><span class="tok-p">,</span>
                      <span class="tok-ss">message</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">message</span><span class="tok-p">,</span>
                      <span class="tok-ss">backtrace</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">backtrace</span>
                  <span class="tok-p">}),</span>
              <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">TaskExecution</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILURE</span>
          <span class="tok-p">)</span>
        <span class="tok-k">end</span>
        <span class="tok-n">current_retry_number</span> <span class="tok-o">=</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">[</span><span class="tok-s1">&#39;retry_number&#39;</span><span class="tok-o">]</span> <span class="tok-o">||</span> <span class="tok-mi">0</span>
        <span class="tok-k">if</span> <span class="tok-n">current_retry_number</span> <span class="tok-o">&lt;</span> <span class="tok-no">MAX_RETRIES_NUMBER</span>
          <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">[</span><span class="tok-s1">&#39;retry_number&#39;</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">current_retry_number</span> <span class="tok-o">+</span> <span class="tok-mi">1</span>
          <span class="tok-c1"># 2^current_retry_number numbers of minutes / number of minutes in a day</span>
          <span class="tok-n">retry_scheduled_at</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span> <span class="tok-o">+</span> <span class="tok-no">Rational</span><span class="tok-p">(</span><span class="tok-mi">2</span> <span class="tok-o">**</span> <span class="tok-n">current_retry_number</span><span class="tok-p">,</span> <span class="tok-mi">1440</span><span class="tok-p">)</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> will be retried at </span><span class="tok-si">#{</span><span class="tok-n">retry_scheduled_at</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
          <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
            <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_WAITING</span><span class="tok-p">,</span>
                <span class="tok-ss">context</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">,</span>
                <span class="tok-ss">scheduled_at</span><span class="tok-p">:</span> <span class="tok-n">retry_scheduled_at</span>
            <span class="tok-p">)</span>
          <span class="tok-k">end</span>
        <span class="tok-k">else</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> retries exhausted&quot;</span><span class="tok-p">)</span>
          <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
            <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILED</span>
            <span class="tok-p">)</span>
          <span class="tok-k">end</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui donne&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Worker 0 starting task 2
(0.000135s) BEGIN
(0.001220s) INSERT INTO &quot;task_executions&quot; (&quot;task_id&quot;, &quot;started_at&quot;, &quot;status&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (2, &#39;2020-09-19 17:41:07.166732+0200&#39;, &#39;running&#39;, &#39;2020-09-19 17:41:07.167594+0200&#39;, &#39;2020-09-19 17:41:07.167594+0200&#39;) RETURNING *
(0.000648s) COMMIT
Worker 0 failed task 2 in 3.49ms, error is #&lt;ZeroDivisionError: divided by 0&gt;
(0.000141s) BEGIN
(0.000911s) UPDATE &quot;task_executions&quot; SET &quot;stopped_at&quot; = &#39;2020-09-19 17:41:07.170222+0200&#39;, &quot;updated_at&quot; = &#39;2020-09-19 17:41:07.170743+0200&#39;, &quot;status&quot; = &#39;failure&#39;, &quot;error&quot; = &#39;{&quot;exception&quot;:&quot;ZeroDivisionError&quot;,&quot;message&quot;:&quot;divided by 0&quot;,&quot;backtrace&quot;:[&quot;/tasks.rb:18:in `/&#39;&#39;&quot;,&quot;/tasks.rb:18:in `execute&#39;&#39;&quot;,&quot;/task_engine.rb:156:in `execute&#39;&#39;&quot;,&quot;/task_engine.rb:131:in `block in initialize&#39;&#39;&quot;]}&#39;::jsonb WHERE (&quot;id&quot; = 2)
(0.000560s) COMMIT
Worker 0 task 2 will be retried at 2020-09-19T17:42:07+02:00
(0.000142s) BEGIN
(0.000636s) UPDATE &quot;tasks&quot; SET &quot;updated_at&quot; = &#39;2020-09-19 17:41:07.173521+0200&#39;, &quot;scheduled_at&quot; = &#39;2020-09-19 17:42:07.172737+0200&#39; WHERE (&quot;id&quot; = 2)
(0.000685s) COMMIT</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_réessayer_mais_pas_tout_le_temps">Réessayer mais pas tout le temps</h3>
<div class="paragraph">
<p>Comme je le disais plus haut, parfois il n&#8217;est pas nécessaire de réessayer une tâche qui a échoué, et parfois il serait néfaste de le faire&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Certains types de tâches ne sont pas compatibles du tout avec le réessai.</p>
</li>
<li>
<p>Lors de l&#8217;exécution, certaines situations ne doivent pas donner lieu à des réessai, il faut donc pouvoir spécifier que quand cela arrive, il ne faut plus faire de ressais.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour les types de tâches qui ne doivent jamais être réessayer, cette information est liée au type de la tâche, et l&#8217;idéal est de pouvoir le spécifier au niveau de la classe qui implémente la classe, plutôt que lorsqu&#8217;on créé la tâche.</p>
</div>
<div class="paragraph">
<p>Pour cela je vais utiliser une approche inspirée de Java, en utilisant un module sans méthode.
Ce module servira à marquer que ce type de tâche n&#8217;est jamais à relancer.</p>
</div>
<div class="paragraph">
<p>Utiliser un module plutôt qu&#8217;une classe évite d&#8217;ajouter une contrainte sur les classes qui implémentent les tâches en les empêchant d&#8217;hériter d&#8217;une autre classe.</p>
</div>
<div class="paragraph">
<p>Voici le module&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-c1"># …</span>

  <span class="tok-c1"># Used to tag tasks classes that should not be retried</span>
  <span class="tok-k">module</span> <span class="tok-nn">NoRetryTask</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voici une tâche qui va échouer et qui utilise ce module&#160;:</p>
</div>
<div class="listingblock">
<div class="title">tasks.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">module</span> <span class="tok-nn">Tasks</span>
    <span class="tok-k">class</span> <span class="tok-nc">FailingNotRetryTask</span>
      <span class="tok-kp">include</span> <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">NoRetryTask</span>

      <span class="tok-c1"># @param [Hash] parameters</span>
      <span class="tok-c1"># @return [Hash, nil]</span>
      <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
        <span class="tok-mi">1</span> <span class="tok-o">/</span> <span class="tok-mi">0</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lors d&#8217;une exécution en erreur, je vais vérifier si la tâche en question inclus ce module&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>
    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-c1"># …</span>
      <span class="tok-k">rescue</span> <span class="tok-no">Exception</span> <span class="tok-o">=&gt;</span> <span class="tok-n">e</span>
        <span class="tok-c1"># …</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">nil?</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-p">(</span><span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">is_a?</span><span class="tok-p">(</span><span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">NoRetryTask</span><span class="tok-p">))</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> should not be retried&quot;</span><span class="tok-p">)</span>
          <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
            <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILED</span>
            <span class="tok-p">)</span>
          <span class="tok-k">end</span>
        <span class="tok-k">else</span>
          <span class="tok-n">current_retry_number</span> <span class="tok-o">=</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">[</span><span class="tok-s1">&#39;retry_number&#39;</span><span class="tok-o">]</span> <span class="tok-o">||</span> <span class="tok-mi">0</span>
          <span class="tok-c1"># …</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui donne, en lançant une <code>TaskEngine::Tasks::FailingNotRetryTask</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Worker 2 starting task 3
(0.000189s) BEGIN
(0.001801s) INSERT INTO &quot;task_executions&quot; (&quot;task_id&quot;, &quot;started_at&quot;, &quot;status&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (3, &#39;2020-09-19 17:59:19.561146+0200&#39;, &#39;running&#39;, &#39;2020-09-19 17:59:19.562535+0200&#39;, &#39;2020-09-19 17:59:19.562535+0200&#39;) RETURNING *
(0.000665s) COMMIT
Worker 2 failed task 3 in 4.8260000000000005ms, error is #&lt;ZeroDivisionError: divided by 0&gt;
(0.000219s) BEGIN
(0.001036s) UPDATE &quot;task_executions&quot; SET &quot;stopped_at&quot; = &#39;2020-09-19 17:59:19.565972+0200&#39;, &quot;updated_at&quot; = &#39;2020-09-19 17:59:19.566692+0200&#39;, &quot;status&quot; = &#39;failure&#39;, &quot;error&quot; = &#39;{&quot;exception&quot;:&quot;ZeroDivisionError&quot;,&quot;message&quot;:&quot;divided by 0&quot;,&quot;backtrace&quot;:[&quot;/tasks.rb:28:in `/&#39;&#39;&quot;,&quot;/tasks.rb:28:in `execute&#39;&#39;&quot;,&quot;/task_engine.rb:161:in `execute&#39;&#39;&quot;,&quot;/task_engine.rb:135:in `block in initialize&#39;&#39;&quot;]}&#39;::jsonb WHERE (&quot;id&quot; = 3)
(0.000653s) COMMIT
Worker 2 task 3 should not be retried
(0.000154s) BEGIN
(0.000879s) UPDATE &quot;tasks&quot; SET &quot;status&quot; = &#39;failed&#39;, &quot;updated_at&quot; = &#39;2020-09-19 17:59:19.569792+0200&#39; WHERE (&quot;id&quot; = 3)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Quand une tâche qui en principe devrait être réessayée ne devrait pas l&#8217;être dans certain cas, je vais m&#8217;appuyer sur l&#8217;exception qui est remontée en cas d&#8217;erreur.
Comme pour les tâche, je vais utiliser un module pour permettre de marquer les classes d&#8217;exception dans ce cas.</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-c1"># …</span>

  <span class="tok-c1"># Used to tag exception classes that should not trigger a retry when they happen</span>
  <span class="tok-k">module</span> <span class="tok-nn">NoRetryExceptionModule</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voici une tâche qui va échouer en utilisant une exception de ce type&#160;:</p>
</div>
<div class="listingblock">
<div class="title">tasks.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">module</span> <span class="tok-nn">Tasks</span>
    <span class="tok-k">class</span> <span class="tok-nc">FailingNotRetryExceptionTask</span>
      <span class="tok-k">class</span> <span class="tok-nc">FailingNotRetryTaskException</span> <span class="tok-o">&lt;</span> <span class="tok-no">Exception</span>
        <span class="tok-kp">include</span> <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">NoRetryException</span>
      <span class="tok-k">end</span>

      <span class="tok-c1"># @param [Hash] parameters</span>
      <span class="tok-c1"># @return [Hash, nil]</span>
      <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
        <span class="tok-k">raise</span> <span class="tok-no">FailingNotRetryTaskException</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-s1">&#39;Oh no&#39;</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La gestion de ce cas ressemble beaucoup au précédent&#160;:</p>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>
    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-c1"># …</span>
      <span class="tok-k">rescue</span> <span class="tok-no">Exception</span> <span class="tok-o">=&gt;</span> <span class="tok-n">e</span>
        <span class="tok-c1"># …</span>
        <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">nil?</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-p">(</span><span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">is_a?</span><span class="tok-p">(</span><span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">NoRetryTask</span><span class="tok-p">))</span>
          <span class="tok-c1"># …</span>
        <span class="tok-k">elsif</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">is_a?</span><span class="tok-p">(</span><span class="tok-no">NoRetryException</span><span class="tok-p">)</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> raised a </span><span class="tok-si">#{</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">class</span><span class="tok-si">}</span><span class="tok-s2"> so it should not be retried&quot;</span><span class="tok-p">)</span>
          <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
            <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILED</span>
            <span class="tok-p">)</span>
          <span class="tok-k">end</span>
        <span class="tok-k">else</span>
          <span class="tok-n">current_retry_number</span> <span class="tok-o">=</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">[</span><span class="tok-s1">&#39;retry_number&#39;</span><span class="tok-o">]</span> <span class="tok-o">||</span> <span class="tok-mi">0</span>
          <span class="tok-c1"># …</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui donne, en lançant une <code>TaskEngine::Tasks::FailingNotRetryExceptionTask</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Worker 0 starting task 6
(0.000201s) BEGIN
(0.001445s) INSERT INTO &quot;task_executions&quot; (&quot;task_id&quot;, &quot;started_at&quot;, &quot;status&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (6, &#39;2020-09-19 18:22:36.700020+0200&#39;, &#39;running&#39;, &#39;2020-09-19 18:22:36.701062+0200&#39;, &#39;2020-09-19 18:22:36.701062+0200&#39;) RETURNING *
(0.000640s) COMMIT
Worker 0 failed task 6 in 4.019ms, error is #&lt;TaskEngine::Tasks::FailingNotRetryExceptionTask::FailingNotRetryTaskException: Oh no&gt;
(0.000173s) BEGIN
(0.000946s) UPDATE &quot;task_executions&quot; SET &quot;stopped_at&quot; = &#39;2020-09-19 18:22:36.704039+0200&#39;, &quot;updated_at&quot; = &#39;2020-09-19 18:22:36.704737+0200&#39;, &quot;status&quot; = &#39;failure&#39;, &quot;error&quot; = &#39;{&quot;exception&quot;:&quot;TaskEngine::Tasks::FailingNotRetryExceptionTask::FailingNotRetryTaskException&quot;,&quot;message&quot;:&quot;Oh no&quot;,&quot;backtrace&quot;:[&quot;/tasks.rb:40:in `execute&#39;&#39;&quot;,&quot;/task_engine.rb:165:in `execute&#39;&#39;&quot;,&quot;/task_engine.rb:139:in `block in initialize&#39;&#39;&quot;]}&#39;::jsonb WHERE (&quot;id&quot; = 6)
(0.000556s) COMMIT
Worker 0 task 6 raised a TaskEngine::Tasks::FailingNotRetryExceptionTask::FailingNotRetryTaskException so it should not be retried
(0.000151s) BEGIN
(0.000703s) UPDATE &quot;tasks&quot; SET &quot;status&quot; = &#39;failed&#39;, &quot;updated_at&quot; = &#39;2020-09-19 18:22:36.707380+0200&#39; WHERE (&quot;id&quot; = 6)
I</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui boucle la gestion des cas d&#8217;erreurs{nsbp}: les erreurs sont enregistrées, les tâches sont par défaut relancées, mais il est possible de gérer de manière fine les situation où cela n&#8217;est pas souhaitable.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-11">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Et voila c&#8217;est terminé, le moteur de tâches est fonctionnel, ou du moins il a toute les fonctionnalités de base qu&#8217;on attend à trouver dans ce genre d&#8217;outils.</p>
</div>
<div class="paragraph">
<p>Par rapport à un moteur de tâches plus complet il manque encore de nombreuses choses comme&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://blog.octo.com/present-et-avenir-du-monitoring-de-flux/">Du monitoring de bout en bout</a>, en utilisant par exemple des identifiant de corrélation transmis d&#8217;une tâche à l&#8217;autre et qui pourrait utiliser le contexte des tâches.</p>
</li>
<li>
<p>Une gestion de la priorité, par exemple en ajoutant une colonne permettant de définir un niveau de priorité pour que certaines tâches ou certains types de tâches s&#8217;exécutent avant d&#8217;autres.</p>
</li>
<li>
<p>La capacité d&#8217;enrichir le moteur à l&#8217;aide de hooks pour avoir notamment des pré-traitement et des post-traitements.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Mais ces ajouts ne changeraient pas la structure du code, et leur implémentation n&#8217;aiderait probablement à mieux comprendre ou mieux utiliser un moteur de tâches, elles sont donc en dehors du périmètre que j&#8217;ai choisi de traiter.</p>
</div>
<div class="paragraph">
<p>J&#8217;espère que la lecture aura permis de démystifier les moteur de tâches, et qu&#8217;elle en aura fait un outil &#8220;comme les autres&#8221; dont vous n&#8217;hésiterez pas à vous servir.</p>
</div>
<div class="paragraph">
<p>Si vous avez des remarques, des critiques ou des questions, <a href="https://archiloque.net">contactez-moi</a>&#160;!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MDT-12">Annexe : le code source</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Voici le code source complet de l&#8217;outil. Il est également disponible en ligne <a href="https://github.com/archiloque/task_engine">ici</a>.</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-n">source</span> <span class="tok-s1">&#39;https://rubygems.org&#39;</span>

<span class="tok-n">gem</span> <span class="tok-s1">&#39;rake&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;~&gt; 13.0&#39;</span>
<span class="tok-n">gem</span> <span class="tok-s1">&#39;sequel&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;~&gt; 5.34&#39;</span>
<span class="tok-n">gem</span> <span class="tok-s1">&#39;pg&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;~&gt; 1.2.3&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">task_engine.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-nb">require</span> <span class="tok-s1">&#39;date&#39;</span>
<span class="tok-nb">require</span> <span class="tok-s1">&#39;logger&#39;</span>
<span class="tok-nb">require</span> <span class="tok-s1">&#39;sequel&#39;</span>

<span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>

  <span class="tok-no">LOGGER</span> <span class="tok-o">=</span> <span class="tok-no">Logger</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-no">STDOUT</span><span class="tok-p">)</span>
  <span class="tok-no">NOTIFICATION_CHANNEL</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;task-engine&#39;</span>
  <span class="tok-no">WORKERS_NUMBER</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
  <span class="tok-c1"># Database connexion path</span>
  <span class="tok-no">DATABASE_URL</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;postgres://task_engine@localhost/task_engine&#39;</span>
  <span class="tok-c1"># Open the connexions to the database</span>
  <span class="tok-c1"># Use at most</span>
  <span class="tok-c1"># - one connexion per worker</span>
  <span class="tok-c1"># - one connexion for notifications</span>
  <span class="tok-c1"># - one connexion for the heartbeat</span>
  <span class="tok-no">DB</span> <span class="tok-o">=</span> <span class="tok-o">::</span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">connect</span><span class="tok-p">(</span><span class="tok-no">DATABASE_URL</span><span class="tok-p">,</span> <span class="tok-ss">max_connections</span><span class="tok-p">:</span> <span class="tok-no">WORKERS_NUMBER</span> <span class="tok-o">+</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-ss">logger</span><span class="tok-p">:</span> <span class="tok-no">LOGGER</span><span class="tok-p">)</span>
  <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">extension</span> <span class="tok-ss">:pg_json</span>

  <span class="tok-c1"># The `created_at` and `updated_at` attributes should be managed by Sequel</span>
  <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span><span class="tok-o">.</span><span class="tok-n">plugin</span> <span class="tok-ss">:timestamps</span><span class="tok-p">,</span> <span class="tok-ss">force</span><span class="tok-p">:</span> <span class="tok-kp">true</span><span class="tok-p">,</span> <span class="tok-ss">update_on_create</span><span class="tok-p">:</span> <span class="tok-kp">true</span>

  <span class="tok-c1"># Used to tag tasks classes that should not be retried</span>
  <span class="tok-k">module</span> <span class="tok-nn">NoRetryTask</span>
  <span class="tok-k">end</span>

  <span class="tok-c1"># Used to tag exception classes that should not trigger a retry when they happen</span>
  <span class="tok-k">module</span> <span class="tok-nn">NoRetryException</span>
  <span class="tok-k">end</span>

  <span class="tok-k">class</span> <span class="tok-nc">Task</span> <span class="tok-o">&lt;</span> <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span>
    <span class="tok-no">STATUS_WAITING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting&#39;</span>
    <span class="tok-no">STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
    <span class="tok-no">STATUS_STOPPED</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;stopped&#39;</span>
    <span class="tok-no">STATUS_FAILED</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;failed&#39;</span>
    <span class="tok-n">one_to_many</span> <span class="tok-ss">:task_executions</span>
  <span class="tok-k">end</span>

  <span class="tok-k">class</span> <span class="tok-nc">TaskExecution</span> <span class="tok-o">&lt;</span> <span class="tok-no">Sequel</span><span class="tok-o">::</span><span class="tok-no">Model</span>
    <span class="tok-no">STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
    <span class="tok-no">STATUS_SUCCESS</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;success&#39;</span>
    <span class="tok-no">STATUS_FAILURE</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;failure&#39;</span>
    <span class="tok-n">many_to_one</span> <span class="tok-ss">:task</span>
  <span class="tok-k">end</span>

  <span class="tok-no">MILLISECONDS_IN_A_DAY</span> <span class="tok-o">=</span> <span class="tok-mi">24</span> <span class="tok-o">*</span> <span class="tok-mi">60</span> <span class="tok-o">*</span> <span class="tok-mi">60</span> <span class="tok-o">*</span> <span class="tok-mi">1000</span>

  <span class="tok-c1"># @param [String] task_class</span>
  <span class="tok-c1"># @param [Hash] task_parameters</span>
  <span class="tok-c1"># @param [DateTime, nil] scheduled_at nil means an immediate execution</span>
  <span class="tok-c1"># @param [Hash] task_context</span>
  <span class="tok-k">def</span> <span class="tok-nc">self</span><span class="tok-o">.</span><span class="tok-nf">create_task</span><span class="tok-p">(</span><span class="tok-n">task_class</span><span class="tok-p">,</span> <span class="tok-n">task_parameters</span><span class="tok-p">,</span> <span class="tok-n">scheduled_at</span> <span class="tok-o">=</span> <span class="tok-kp">nil</span><span class="tok-p">)</span>
    <span class="tok-n">creation_params</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-ss">task_class</span><span class="tok-p">:</span> <span class="tok-n">task_class</span><span class="tok-p">,</span>
        <span class="tok-ss">task_parameters</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span><span class="tok-n">task_parameters</span><span class="tok-p">)</span>
    <span class="tok-p">}</span>
    <span class="tok-c1"># Don&#39;t send a null value to the DB so the DB use the default value</span>
    <span class="tok-k">unless</span> <span class="tok-n">scheduled_at</span><span class="tok-o">.</span><span class="tok-n">nil?</span>
      <span class="tok-n">creation_params</span><span class="tok-o">[</span><span class="tok-ss">:scheduled_at</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">scheduled_at</span>
    <span class="tok-k">end</span>
    <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">creation_params</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">scheduled_at</span><span class="tok-o">.</span><span class="tok-n">nil?</span>
      <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">notify</span><span class="tok-p">(</span><span class="tok-no">NOTIFICATION_CHANNEL</span><span class="tok-p">,</span> <span class="tok-ss">payload</span><span class="tok-p">:</span> <span class="tok-n">task_class</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>

  <span class="tok-k">class</span> <span class="tok-nc">Engine</span>
    <span class="tok-no">ENGINE_STATUS_RUNNING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;running&#39;</span>
    <span class="tok-no">ENGINE_STATUS_STOPPING</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;stopping&#39;</span>

    <span class="tok-kp">attr_reader</span> <span class="tok-ss">:instance</span><span class="tok-p">,</span> <span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:queue</span>

    <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span>
      <span class="tok-k">unless</span> <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span>
          <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">ENGINE_STATUS_RUNNING</span><span class="tok-p">,</span>
          <span class="tok-ss">instance</span><span class="tok-p">:</span> <span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">empty?</span>
        <span class="tok-k">raise</span> <span class="tok-s2">&quot;Found running tasks with same instance name in the database [</span><span class="tok-si">#{</span><span class="tok-n">instance</span><span class="tok-si">}</span><span class="tok-s2">]&quot;</span>
      <span class="tok-k">end</span>
      <span class="tok-vi">@instance</span> <span class="tok-o">=</span> <span class="tok-n">instance</span>
      <span class="tok-vi">@queue</span> <span class="tok-o">=</span> <span class="tok-no">Queue</span><span class="tok-o">.</span><span class="tok-n">new</span>
      <span class="tok-vi">@workers</span> <span class="tok-o">=</span> <span class="tok-o">[]</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Starting engine&#39;</span><span class="tok-p">)</span>
      <span class="tok-vi">@status</span> <span class="tok-o">=</span> <span class="tok-no">ENGINE_STATUS_RUNNING</span>

      <span class="tok-no">Signal</span><span class="tok-o">.</span><span class="tok-n">trap</span><span class="tok-p">(</span><span class="tok-s1">&#39;SIGTERM&#39;</span><span class="tok-p">)</span> <span class="tok-k">do</span>
        <span class="tok-n">signal_trap</span>
      <span class="tok-k">end</span>
      <span class="tok-no">Signal</span><span class="tok-o">.</span><span class="tok-n">trap</span><span class="tok-p">(</span><span class="tok-s1">&#39;SIGINT&#39;</span><span class="tok-p">)</span> <span class="tok-k">do</span>
        <span class="tok-n">signal_trap</span>
      <span class="tok-k">end</span>

      <span class="tok-c1"># Notifications</span>
      <span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
        <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">listen</span><span class="tok-p">(</span><span class="tok-no">NOTIFICATION_CHANNEL</span><span class="tok-p">,</span> <span class="tok-kp">loop</span><span class="tok-p">:</span> <span class="tok-kp">true</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">_channel</span><span class="tok-p">,</span> <span class="tok-n">_pid</span><span class="tok-p">,</span> <span class="tok-n">task_class</span><span class="tok-o">|</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Received notification for a task [</span><span class="tok-si">#{</span><span class="tok-n">task_class</span><span class="tok-si">}</span><span class="tok-s2">]&quot;</span><span class="tok-p">)</span>
          <span class="tok-k">unless</span> <span class="tok-vi">@queue</span><span class="tok-o">.</span><span class="tok-n">num_waiting</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>
            <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Notifying worker&#39;</span><span class="tok-p">)</span>
            <span class="tok-vi">@queue</span><span class="tok-o">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">task_class</span><span class="tok-p">)</span>
          <span class="tok-k">end</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>

      <span class="tok-c1"># Scheduled wake-ups</span>
      <span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
        <span class="tok-k">while</span> <span class="tok-kp">true</span> <span class="tok-k">do</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s1">&#39;Scheduled wake-up&#39;</span><span class="tok-p">)</span>
          <span class="tok-vi">@queue</span><span class="tok-o">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-s1">&#39;Scheduled wake-up&#39;</span><span class="tok-p">)</span>
          <span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">)</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>

      <span class="tok-mi">0</span><span class="tok-o">.</span><span class="tok-n">upto</span><span class="tok-p">(</span><span class="tok-no">WORKERS_NUMBER</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">worker_index</span><span class="tok-o">|</span>
        <span class="tok-vi">@workers</span> <span class="tok-o">&lt;&lt;</span> <span class="tok-no">Worker</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-nb">self</span><span class="tok-p">,</span> <span class="tok-n">worker_index</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
      <span class="tok-vi">@workers</span><span class="tok-o">.</span><span class="tok-n">each</span> <span class="tok-k">do</span> <span class="tok-o">|</span><span class="tok-n">worker</span><span class="tok-o">|</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Joining worker </span><span class="tok-si">#{</span><span class="tok-n">worker</span><span class="tok-o">.</span><span class="tok-n">worker_index</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
        <span class="tok-n">worker</span><span class="tok-o">.</span><span class="tok-n">thread</span><span class="tok-o">.</span><span class="tok-n">join</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>

    <span class="tok-k">def</span> <span class="tok-nf">signal_trap</span>
      <span class="tok-vi">@status</span> <span class="tok-o">=</span> <span class="tok-no">ENGINE_STATUS_STOPPING</span>
      <span class="tok-vi">@queue</span><span class="tok-o">.</span><span class="tok-n">close</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>

  <span class="tok-k">class</span> <span class="tok-nc">Worker</span>
    <span class="tok-no">MAX_RETRIES_NUMBER</span> <span class="tok-o">=</span> <span class="tok-mi">10</span>

    <span class="tok-kp">attr_reader</span> <span class="tok-ss">:thread</span><span class="tok-p">,</span> <span class="tok-ss">:worker_index</span>

    <span class="tok-c1"># @param [TaskEngine::Engine] engine</span>
    <span class="tok-c1"># @param [Integer] worker_index</span>
    <span class="tok-k">def</span> <span class="tok-nf">initialize</span><span class="tok-p">(</span><span class="tok-n">engine</span><span class="tok-p">,</span> <span class="tok-n">worker_index</span><span class="tok-p">)</span>
      <span class="tok-vi">@engine</span> <span class="tok-o">=</span> <span class="tok-n">engine</span>
      <span class="tok-vi">@worker_index</span> <span class="tok-o">=</span> <span class="tok-n">worker_index</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Starting worker </span><span class="tok-si">#{</span><span class="tok-n">worker_index</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
      <span class="tok-vi">@thread</span> <span class="tok-o">=</span> <span class="tok-no">Thread</span><span class="tok-o">.</span><span class="tok-n">new</span> <span class="tok-k">do</span>
        <span class="tok-n">execute</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>

    <span class="tok-kp">private</span>

    <span class="tok-k">def</span> <span class="tok-nf">execute</span>
      <span class="tok-k">while</span> <span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-no">Engine</span><span class="tok-o">::</span><span class="tok-no">ENGINE_STATUS_RUNNING</span>
        <span class="tok-k">while</span> <span class="tok-p">(</span><span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">status</span> <span class="tok-o">==</span> <span class="tok-no">Engine</span><span class="tok-o">::</span><span class="tok-no">ENGINE_STATUS_RUNNING</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-p">(</span><span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-n">try_acquire_task</span><span class="tok-p">)</span>
          <span class="tok-n">starting_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
          <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> starting task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>

          <span class="tok-n">task_execution</span> <span class="tok-o">=</span> <span class="tok-kp">nil</span>
          <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
            <span class="tok-n">task_execution</span> <span class="tok-o">=</span> <span class="tok-no">TaskExecution</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span>
                <span class="tok-ss">task</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-p">,</span>
                <span class="tok-ss">started_at</span><span class="tok-p">:</span> <span class="tok-n">starting_time</span><span class="tok-p">,</span>
                <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">TaskExecution</span><span class="tok-o">::</span><span class="tok-no">STATUS_RUNNING</span>
            <span class="tok-p">)</span>
          <span class="tok-k">end</span>

          <span class="tok-n">task_class_name</span> <span class="tok-o">=</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">task_class</span>
          <span class="tok-n">task_instance</span> <span class="tok-o">=</span> <span class="tok-kp">nil</span>
          <span class="tok-k">begin</span>
            <span class="tok-n">task_class</span> <span class="tok-o">=</span> <span class="tok-no">Object</span><span class="tok-o">.</span><span class="tok-n">const_get</span><span class="tok-p">(</span><span class="tok-n">task_class_name</span><span class="tok-p">)</span>
            <span class="tok-n">task_instance</span> <span class="tok-o">=</span> <span class="tok-n">task_class</span><span class="tok-o">.</span><span class="tok-n">new</span>
            <span class="tok-n">task_result</span> <span class="tok-o">=</span> <span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">task_parameters</span><span class="tok-p">)</span>

            <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
            <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
            <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> finished successfully task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> in </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms, result is </span><span class="tok-si">#{</span><span class="tok-n">result</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
            <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
              <span class="tok-n">task_execution</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                  <span class="tok-ss">stopped_at</span><span class="tok-p">:</span> <span class="tok-n">stopping_time</span><span class="tok-p">,</span>
                  <span class="tok-ss">result</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span><span class="tok-n">task_result</span><span class="tok-p">),</span>
                  <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">TaskExecution</span><span class="tok-o">::</span><span class="tok-no">STATUS_SUCCESS</span>
              <span class="tok-p">)</span>
              <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                  <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_STOPPED</span>
              <span class="tok-p">)</span>
            <span class="tok-k">end</span>
          <span class="tok-k">rescue</span> <span class="tok-no">Exception</span> <span class="tok-o">=&gt;</span> <span class="tok-n">e</span>
            <span class="tok-n">stopping_time</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span>
            <span class="tok-n">elapsed_time</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">stopping_time</span> <span class="tok-o">-</span> <span class="tok-n">starting_time</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">to_f</span> <span class="tok-o">*</span> <span class="tok-no">MILLISECONDS_IN_A_DAY</span>
            <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> failed task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> in </span><span class="tok-si">#{</span><span class="tok-n">elapsed_time</span><span class="tok-si">}</span><span class="tok-s2">ms, error is </span><span class="tok-si">#{</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">inspect</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
            <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
              <span class="tok-n">task_execution</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                  <span class="tok-ss">stopped_at</span><span class="tok-p">:</span> <span class="tok-n">stopping_time</span><span class="tok-p">,</span>
                  <span class="tok-ss">error</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">(</span>
                      <span class="tok-p">{</span>
                          <span class="tok-ss">exception</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">class</span><span class="tok-p">,</span>
                          <span class="tok-ss">message</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">message</span><span class="tok-p">,</span>
                          <span class="tok-ss">backtrace</span><span class="tok-p">:</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">backtrace</span>
                      <span class="tok-p">}),</span>
                  <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">TaskExecution</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILURE</span>
              <span class="tok-p">)</span>
            <span class="tok-k">end</span>
            <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">nil?</span><span class="tok-p">)</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-p">(</span><span class="tok-n">task_instance</span><span class="tok-o">.</span><span class="tok-n">is_a?</span><span class="tok-p">(</span><span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">NoRetryTask</span><span class="tok-p">))</span>
              <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> should not be retried&quot;</span><span class="tok-p">)</span>
              <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
                <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                    <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILED</span>
                <span class="tok-p">)</span>
              <span class="tok-k">end</span>
            <span class="tok-k">elsif</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">is_a?</span><span class="tok-p">(</span><span class="tok-no">NoRetryException</span><span class="tok-p">)</span>
              <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> raised a </span><span class="tok-si">#{</span><span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">class</span><span class="tok-si">}</span><span class="tok-s2"> so it should not be retried&quot;</span><span class="tok-p">)</span>
              <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
                <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                    <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILED</span>
                <span class="tok-p">)</span>
              <span class="tok-k">end</span>
            <span class="tok-k">else</span>
              <span class="tok-n">current_retry_number</span> <span class="tok-o">=</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">[</span><span class="tok-s1">&#39;retry_number&#39;</span><span class="tok-o">]</span> <span class="tok-o">||</span> <span class="tok-mi">0</span>
              <span class="tok-k">if</span> <span class="tok-n">current_retry_number</span> <span class="tok-o">&lt;</span> <span class="tok-no">MAX_RETRIES_NUMBER</span>
                <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">[</span><span class="tok-s1">&#39;retry_number&#39;</span><span class="tok-o">]</span> <span class="tok-o">=</span> <span class="tok-n">current_retry_number</span> <span class="tok-o">+</span> <span class="tok-mi">1</span>
                <span class="tok-c1"># 2^current_retry_number numbers of minutes / number of minutes in a day</span>
                <span class="tok-n">retry_scheduled_at</span> <span class="tok-o">=</span> <span class="tok-no">DateTime</span><span class="tok-o">.</span><span class="tok-n">now</span> <span class="tok-o">+</span> <span class="tok-no">Rational</span><span class="tok-p">(</span><span class="tok-mi">2</span> <span class="tok-o">**</span> <span class="tok-n">current_retry_number</span><span class="tok-p">,</span> <span class="tok-mi">1440</span><span class="tok-p">)</span>
                <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> will be retried at </span><span class="tok-si">#{</span><span class="tok-n">retry_scheduled_at</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-p">)</span>
                <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
                  <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                      <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_WAITING</span><span class="tok-p">,</span>
                      <span class="tok-ss">context</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">,</span>
                      <span class="tok-ss">scheduled_at</span><span class="tok-p">:</span> <span class="tok-n">retry_scheduled_at</span>
                  <span class="tok-p">)</span>
                <span class="tok-k">end</span>
              <span class="tok-k">else</span>
                <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> task </span><span class="tok-si">#{</span><span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-si">}</span><span class="tok-s2"> retries exhausted&quot;</span><span class="tok-p">)</span>
                <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
                  <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
                      <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_FAILED</span>
                  <span class="tok-p">)</span>
                <span class="tok-k">end</span>
              <span class="tok-k">end</span>
            <span class="tok-k">end</span>
          <span class="tok-k">end</span>
        <span class="tok-k">end</span>
        <span class="tok-c1"># Wait until the notification awakes the worker</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is sleeping&quot;</span><span class="tok-p">)</span>
        <span class="tok-c1"># We don&#39;t care about the message we got from the queue</span>
        <span class="tok-c1"># since we just want to be awaken</span>
        <span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">pop</span>
        <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is awaken&quot;</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
      <span class="tok-no">LOGGER</span><span class="tok-o">.</span><span class="tok-n">info</span><span class="tok-p">(</span><span class="tok-s2">&quot;Worker </span><span class="tok-si">#{</span><span class="tok-vi">@worker_index</span><span class="tok-si">}</span><span class="tok-s2"> is stopping&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">end</span>

    <span class="tok-c1"># @return [TaskEngine::Task, nil]</span>
    <span class="tok-k">def</span> <span class="tok-nf">try_acquire_task</span>
      <span class="tok-no">DB</span><span class="tok-o">.</span><span class="tok-n">transaction</span> <span class="tok-k">do</span>
        <span class="tok-n">task</span> <span class="tok-o">=</span> <span class="tok-no">Task</span><span class="tok-o">.</span>
            <span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_WAITING</span><span class="tok-p">)</span><span class="tok-o">.</span>
            <span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">lit</span><span class="tok-p">(</span><span class="tok-s1">&#39;scheduled_at &lt; LOCALTIMESTAMP&#39;</span><span class="tok-p">))</span><span class="tok-o">.</span>
            <span class="tok-n">order</span><span class="tok-p">(</span><span class="tok-ss">:scheduled_at</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">for_update</span><span class="tok-o">.</span><span class="tok-n">first</span>
        <span class="tok-k">unless</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">nil?</span>
          <span class="tok-no">Task</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-p">:</span> <span class="tok-n">task</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span>
              <span class="tok-ss">status</span><span class="tok-p">:</span> <span class="tok-no">Task</span><span class="tok-o">::</span><span class="tok-no">STATUS_RUNNING</span><span class="tok-p">,</span>
              <span class="tok-ss">instance</span><span class="tok-p">:</span> <span class="tok-vi">@engine</span><span class="tok-o">.</span><span class="tok-n">instance</span>
          <span class="tok-p">)</span>
          <span class="tok-n">task</span>
        <span class="tok-k">end</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Rakefile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-n">desc</span> <span class="tok-s1">&#39;Start the engine&#39;</span>

<span class="tok-no">TASK_ENGINE_INSTANCE</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;TASK_ENGINE_INSTANCE&#39;</span>

<span class="tok-n">task</span> <span class="tok-ss">:start_engine</span> <span class="tok-k">do</span>
  <span class="tok-k">unless</span> <span class="tok-no">ENV</span><span class="tok-o">.</span><span class="tok-n">key?</span><span class="tok-p">(</span><span class="tok-no">TASK_ENGINE_INSTANCE</span><span class="tok-p">)</span>
    <span class="tok-k">raise</span> <span class="tok-s2">&quot;Missing env variable </span><span class="tok-si">#{</span><span class="tok-no">TASK_ENGINE_INSTANCE</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>
  <span class="tok-k">end</span>
  <span class="tok-n">instance</span> <span class="tok-o">=</span> <span class="tok-no">ENV</span><span class="tok-o">.</span><span class="tok-n">fetch</span><span class="tok-p">(</span><span class="tok-no">TASK_ENGINE_INSTANCE</span><span class="tok-p">)</span>
  <span class="tok-n">require_relative</span> <span class="tok-s1">&#39;task_engine&#39;</span>
  <span class="tok-n">require_relative</span> <span class="tok-s1">&#39;tasks&#39;</span>
  <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">Engine</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span>
<span class="tok-k">end</span>

<span class="tok-n">desc</span> <span class="tok-s1">&#39;Create tasks&#39;</span>
<span class="tok-n">task</span> <span class="tok-ss">:create_tasks</span> <span class="tok-k">do</span>
  <span class="tok-n">require_relative</span> <span class="tok-s1">&#39;task_engine&#39;</span>
  <span class="tok-mi">100</span><span class="tok-o">.</span><span class="tok-n">times</span> <span class="tok-k">do</span>
    <span class="tok-no">TaskEngine</span><span class="tok-o">.</span><span class="tok-n">create_task</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;TaskEngine::Tasks::WaitingTask&#39;</span><span class="tok-p">,</span>
        <span class="tok-p">{</span>
            <span class="tok-ss">waiting_time</span><span class="tok-p">:</span> <span class="tok-mi">5</span>
        <span class="tok-p">})</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span>

<span class="tok-n">task</span> <span class="tok-ss">default</span><span class="tok-p">:</span> <span class="tok-ss">:start_engine</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">tasks.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-k">module</span> <span class="tok-nn">TaskEngine</span>
  <span class="tok-k">module</span> <span class="tok-nn">Tasks</span>
    <span class="tok-k">class</span> <span class="tok-nc">WaitingTask</span>
      <span class="tok-no">PARAMETER_WAITING_TIME</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;waiting_time&#39;</span>

      <span class="tok-c1"># @param [Hash] parameters</span>
      <span class="tok-c1"># @return [Hash, nil]</span>
      <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
        <span class="tok-nb">sleep</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-o">[</span><span class="tok-no">PARAMETER_WAITING_TIME</span><span class="tok-o">]</span><span class="tok-p">)</span>
        <span class="tok-kp">nil</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>

    <span class="tok-k">class</span> <span class="tok-nc">FailingTask</span>
      <span class="tok-c1"># @param [Hash] parameters</span>
      <span class="tok-c1"># @return [Hash, nil]</span>
      <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
        <span class="tok-mi">1</span> <span class="tok-o">/</span> <span class="tok-mi">0</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>

    <span class="tok-k">class</span> <span class="tok-nc">FailingNotRetryTask</span>
      <span class="tok-kp">include</span> <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">NoRetryTask</span>

      <span class="tok-c1"># @param [Hash] parameters</span>
      <span class="tok-c1"># @return [Hash, nil]</span>
      <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
        <span class="tok-mi">1</span> <span class="tok-o">/</span> <span class="tok-mi">0</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>

    <span class="tok-k">class</span> <span class="tok-nc">FailingNotRetryExceptionTask</span>
      <span class="tok-k">class</span> <span class="tok-nc">FailingNotRetryTaskException</span> <span class="tok-o">&lt;</span> <span class="tok-no">Exception</span>
        <span class="tok-kp">include</span> <span class="tok-no">TaskEngine</span><span class="tok-o">::</span><span class="tok-no">NoRetryException</span>
      <span class="tok-k">end</span>

      <span class="tok-c1"># @param [Hash] parameters</span>
      <span class="tok-c1"># @return [Hash, nil]</span>
      <span class="tok-k">def</span> <span class="tok-nf">execute</span><span class="tok-p">(</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
        <span class="tok-k">raise</span> <span class="tok-no">FailingNotRetryTaskException</span><span class="tok-o">.</span><span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-s1">&#39;Oh no&#39;</span><span class="tok-p">)</span>
      <span class="tok-k">end</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">migrations/01_create_tasks.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-c1"># Load enum-related methods</span>
    <span class="tok-n">extension</span> <span class="tok-ss">:pg_enum</span>

    <span class="tok-c1"># Declare the enum with the list of allowed values</span>
    <span class="tok-n">create_enum</span><span class="tok-p">(</span><span class="tok-ss">:task_status</span><span class="tok-p">,</span> <span class="tok-o">[</span><span class="tok-s1">&#39;waiting&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;running&#39;</span><span class="tok-o">]</span><span class="tok-p">)</span>

    <span class="tok-n">create_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">primary_key</span> <span class="tok-ss">:id</span>
      <span class="tok-c1"># The status column is using the task_status enum type</span>
      <span class="tok-n">task_status</span> <span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-ss">default</span><span class="tok-p">:</span> <span class="tok-s1">&#39;waiting&#39;</span>

      <span class="tok-no">DateTime</span> <span class="tok-ss">:created_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-no">DateTime</span> <span class="tok-ss">:updated_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">migrations/02_add_instance_name.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:instance</span><span class="tok-p">,</span> <span class="tok-nb">String</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">true</span><span class="tok-p">,</span> <span class="tok-ss">text</span><span class="tok-p">:</span> <span class="tok-kp">true</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">migrations/03_add_parameters.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:task_class</span><span class="tok-p">,</span> <span class="tok-nb">String</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-ss">text</span><span class="tok-p">:</span> <span class="tok-kp">true</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:task_parameters</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JSONB&#39;</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">migrations/04_create_task_executions.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">add_enum_value</span><span class="tok-p">(</span><span class="tok-ss">:task_status</span><span class="tok-p">,</span> <span class="tok-s1">&#39;stopped&#39;</span><span class="tok-p">)</span>

    <span class="tok-n">create_table</span><span class="tok-p">(</span><span class="tok-ss">:task_executions</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">primary_key</span> <span class="tok-ss">:id</span>
      <span class="tok-n">foreign_key</span> <span class="tok-ss">:task_id</span><span class="tok-p">,</span> <span class="tok-ss">:tasks</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-no">DateTime</span> <span class="tok-ss">:started_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-no">DateTime</span> <span class="tok-ss">:stopped_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">true</span>
      <span class="tok-n">column</span> <span class="tok-ss">:result</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JSONB&#39;</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">true</span>

      <span class="tok-no">DateTime</span> <span class="tok-ss">:created_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-no">DateTime</span> <span class="tok-ss">:updated_at</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">migrations/05_add_scheduled_at.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_index</span> <span class="tok-o">[</span><span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:created_at</span><span class="tok-o">]</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">migrations/06_add_scheduled_at.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:scheduled_at</span><span class="tok-p">,</span> <span class="tok-no">DateTime</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-ss">default</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">lit</span><span class="tok-p">(</span><span class="tok-s1">&#39;LOCALTIMESTAMP&#39;</span><span class="tok-p">)</span>
      <span class="tok-n">drop_index</span> <span class="tok-o">[</span><span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:created_at</span><span class="tok-o">]</span>
      <span class="tok-n">add_index</span> <span class="tok-o">[</span><span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:scheduled_at</span><span class="tok-o">]</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">migrations/07_add_errors_to_task_execution.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">extension</span> <span class="tok-ss">:pg_enum</span>
    <span class="tok-n">create_enum</span><span class="tok-p">(</span><span class="tok-ss">:task_execution_status</span><span class="tok-p">,</span> <span class="tok-o">[</span><span class="tok-s1">&#39;running&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;success&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;failure&#39;</span><span class="tok-o">]</span><span class="tok-p">)</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:task_executions</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:status</span><span class="tok-p">,</span> <span class="tok-ss">:task_execution_status</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:error</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JSONB&#39;</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">true</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">migrations/08_add_task_context_and_task_failure.rb</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><span></span><span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">migration</span> <span class="tok-k">do</span>
  <span class="tok-n">change</span> <span class="tok-k">do</span>
    <span class="tok-n">extension</span> <span class="tok-ss">:pg_enum</span>
    <span class="tok-n">add_enum_value</span><span class="tok-p">(</span><span class="tok-ss">:task_status</span><span class="tok-p">,</span> <span class="tok-s1">&#39;failed&#39;</span><span class="tok-p">)</span>

    <span class="tok-n">extension</span> <span class="tok-ss">:pg_json</span>
    <span class="tok-n">alter_table</span><span class="tok-p">(</span><span class="tok-ss">:tasks</span><span class="tok-p">)</span> <span class="tok-k">do</span>
      <span class="tok-n">add_column</span> <span class="tok-ss">:context</span><span class="tok-p">,</span> <span class="tok-s1">&#39;JSONB&#39;</span><span class="tok-p">,</span> <span class="tok-ss">null</span><span class="tok-p">:</span> <span class="tok-kp">false</span><span class="tok-p">,</span> <span class="tok-ss">default</span><span class="tok-p">:</span> <span class="tok-no">Sequel</span><span class="tok-o">.</span><span class="tok-n">pg_json_wrap</span><span class="tok-p">({})</span>
    <span class="tok-k">end</span>
  <span class="tok-k">end</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-10-10 21:26:52 +0200
</div>
</div>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments  { background: #f0f0f0; }
pre.pygments .tok-c { color: #60a0b0; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #007020; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #60a0b0; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #007020 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #60a0b0; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #007020; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #007020 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #902000 } /* Keyword.Type */
pre.pygments .tok-m { color: #40a070 } /* Literal.Number */
pre.pygments .tok-s { color: #4070a0 } /* Literal.String */
pre.pygments .tok-na { color: #4070a0 } /* Name.Attribute */
pre.pygments .tok-nb { color: #007020 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0e84b5; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #60add5 } /* Name.Constant */
pre.pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
pre.pygments .tok-ni { color: #d55537; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #007020 } /* Name.Exception */
pre.pygments .tok-nf { color: #06287e } /* Name.Function */
pre.pygments .tok-nl { color: #002070; font-weight: bold } /* Name.Label */
pre.pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #062873; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #bb60d5 } /* Name.Variable */
pre.pygments .tok-ow { color: #007020; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #40a070 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #40a070 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #40a070 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #40a070 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #40a070 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #4070a0 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #4070a0 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #4070a0 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #4070a0 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #4070a0 } /* Literal.String.Double */
pre.pygments .tok-se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #4070a0 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #c65d09 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #235388 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #4070a0 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #517918 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #06287e } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #bb60d5 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #bb60d5 } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #bb60d5 } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #bb60d5 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #40a070 } /* Literal.Number.Integer.Long */
</style>
</body>
</html>