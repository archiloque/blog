<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Julien Kirch">
<title>Écrire un ORM en Ruby</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Écrire un ORM en Ruby</h1>
<div class="details">
<span id="author" class="author">Julien Kirch</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#ORM-1">Partie 1&#160;: structure</a>
<ul class="sectlevel2">
<li><a href="#_un_exemple_mono_base">Un exemple mono-base</a></li>
<li><a href="#_génération_de_code_à_froid_plutôt_quà_chaud">Génération de code à froid plutôt qu&#8217;à chaud</a></li>
<li><a href="#_le_début">Le début</a></li>
<li><a href="#_comme_exempleun_jeu_de_construction">Comme exemple&#160;:un jeu de construction</a></li>
<li><a href="#_un_dsl_pour_configurer_les_modèles">Un DSL pour configurer les modèles</a></li>
<li><a href="#_un_template_pour_générer_le_fichier">Un template pour générer le fichier</a></li>
</ul>
</li>
<li><a href="#ORM-2">Partie 2&#160;: récupération des champs, insertion et sélection</a>
<ul class="sectlevel2">
<li><a href="#_des_modèles_avec_des_champs">Des modèles avec des champs</a></li>
<li><a href="#_linsertion">L&#8217;insertion</a></li>
<li><a href="#_la_récupération">La récupération</a></li>
<li><a href="#_et_la_suppression">Et la suppression</a></li>
</ul>
</li>
<li><a href="#ORM-3">Partie 3&#160;: filtrage et ordre</a>
<ul class="sectlevel2">
<li><a href="#_lapproche_builder">L&#8217;approche &#8220;builder&#8221;</a></li>
<li><a href="#_la_classe_queryparameters">La classe <code>QueryParameters</code></a></li>
<li><a href="#_les_méthodes_du_modèle">Les méthodes du modèle</a></li>
<li><a href="#_la_requête">La requête</a></li>
<li><a href="#_limiter_les_résultats">Limiter les résultats</a></li>
</ul>
</li>
<li><a href="#ORM-4">Partie 4&#160;: relations</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="ORM-1">Partie 1&#160;: structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les ORMs sont probablement les outils les plus complexes auxquels ont a affaire directement quand on commence à développer.</p>
</div>
<div class="paragraph">
<p>De ce fait, on peut avoir du mal à imaginer comment ils peuvent bien fonctionner, et peuvent donner l&#8217;impression d&#8217;être presque magiques.</p>
</div>
<div class="paragraph">
<p>Impression souvent renforcé quand on lit le code de ces outils, souvent assez dense et utilisant des constructions différentes de celles du code applicatif.</p>
</div>
<div class="paragraph">
<p>Cette situation peut avoir deux conséquences&#160;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les personnes ne se sentent pas à l&#8217;aise quand elles utilisent des ORMs&#160;</p>
</li>
<li>
<p>les personnes ont un avis négatif des ORMs basé essentiellement sur leur ressenti au moment de leur première rencontre avec ce type d&#8217;outil (qu&#8217;on ait un avis négatif sur les ORMs basés sur des éléments objectifs ne me pose pas de problèmes).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour lutter contre cela, je vous propose une série d&#8217;articles décrivant pas à pas comment écrire un ORM SQL minimal en Ruby, par minimal j&#8217;entends un ORM capable de faire de l&#8217;insertion, du requêtage simple et gérer des relations entre objets.</p>
</div>
<div class="paragraph">
<p>Mon objectif est qu&#8217;après avoir lu ces articles, vous ayez le sentiment de comprendre comment ils fonctionnent, et que de ce fait ils ne vous fassent plus peur.</p>
</div>
<div class="sect2">
<h3 id="_un_exemple_mono_base">Un exemple mono-base</h3>
<div class="paragraph">
<p>La plupart des ORMs SQL sont compatibles avec de nombreuses de base de données.
Cette compatibilité s&#8217;implémente généralement en permettant que toutes les méthodes de l&#8217;ORM soient surchargeables en fonction des spécificités de chaque base.</p>
</div>
<div class="paragraph">
<p>Par exemple pour une classe de génération de requète <code>QueryBuilder</code>, on aura ainsi un <code>SQLiteQueryBuilder</code>, un <code>PostgreSQLQueryBuilder</code>&#160;…</p>
</div>
<div class="paragraph">
<p>La difficulté est de parvenir à structurer le code pour pouvoir prendre en compte les spécificités de chaque base sans que cela tourne au plat de spaghetti, sachant que suivant les bases ces particularité ne sont pas toutes au mêmes endroits.</p>
</div>
<div class="paragraph">
<p>Mais cela ne porte pas à conséquence sur le fonctionnement général de l&#8217;outil.
Mon exemple sera donc mono-base et ciblera SQLite car elle fournit tout ce dont j&#8217;ai besoin et qu&#8217;elle est facile à installer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_génération_de_code_à_froid_plutôt_quà_chaud">Génération de code à froid plutôt qu&#8217;à chaud</h3>
<div class="paragraph">
<p>Contrairement à des ORMs comme <a href="https://guides.rubyonrails.org/active_record_basics.html">Active Record</a> ou <a href="http://sequel.jeremyevans.net">Sequel</a>, l&#8217;ORM que je vais implémenter utilisera de la génération de code à froid&#8201;—&#160; c&#8217;est-à-dire sous forme de fichiers&#160;—&#8201; plutôt qu&#8217;à chaud sous forme de code généré à l&#8217;exécution.</p>
</div>
<div class="paragraph">
<p>Générer du code dans des fichiers permet d&#8217;examiner les comportements sans avoir à débuguer, et permet un meilleur support de la part des outils.</p>
</div>
<div class="paragraph">
<p>Mon avis est que ce type d&#8217;approche est préférable à la génération de code à chaud sauf très bonne raison.</p>
</div>
<div class="paragraph">
<p>Quand j&#8217;utilise Active Record et que j&#8217;ai besoin de poser des breakpoints et d&#8217;examiner les objets en mémoire pour connaître les méthodes disponibles sur un modèle ça me rend triste.</p>
</div>
<div class="paragraph">
<p>En Ruby, générer du code à l&#8217;exécution est facile, ce qui est bien, mais je pense que la communauté a tendance à parfois trop l&#8217;utiliser, surtout que par ailleurs le rechargement de code à chaud fonctionne très bien.</p>
</div>
<div class="paragraph">
<p>Pour la génération, je vais utiliser <a href="https://ruby-doc.org/stdlib-2.7.1/libdoc/erb/rdoc/ERB.html">erb</a>.
Si elle est souvent utilisée pour générer du HTML, la syntaxe erb n&#8217;est pas du tout spécifique au HTML (comme peut l&#8217;être <a href="http://slim-lang.com">Slim</a>) et peut donc servir à générer du Ruby.</p>
</div>
</div>
<div class="sect2">
<h3 id="_le_début">Le début</h3>
<div class="paragraph">
<p>Le code (framework et code d&#8217;exemple) sera dans un projet unique, et ne sera pas packagé sous forme d&#8217;une gem.</p>
</div>
<div class="paragraph">
<p>Le faire ajouterait pas mal de code et un peu de complexité sans que cela apporte quelque chose.</p>
</div>
<div class="sect3">
<h4 id="_les_dépendances">Les dépendances</h4>
<div class="paragraph">
<p>Tout d&#8217;abord il faut fixer la version de Ruby, je vais prendre la dernière disponible au moment d&#8217;écrire l&#8217;article.</p>
</div>
<div class="listingblock">
<div class="title">ruby-version</div>
<div class="content">
<pre class="rouge highlight"><code>2.7.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite pour les bibliothèques, en plus de la gem permettant d&#8217;utiliser SQLite je vais me servir de Rake pour définir la tâche de génération de code.</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code>source "https://rubygems.org"

gem "rake", "~&gt; 12.0"
gem "sqlite3", "~&gt; 1.4"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comme_exempleun_jeu_de_construction">Comme exemple&#160;:un jeu de construction</h3>
<div class="paragraph">
<p>Dans la suite, je vais prendre comme exemple un jeu de construction.</p>
</div>
<div class="paragraph">
<p>Ce jeu de construction est composé des différents types de briques (<code>Brick</code>), qui sont chacun d&#8217;une certaine couleur (<code>Color</code>).
Des modèles à construire (<code>Kit</code>) sont constitués d&#8217;un ensemble de types de briques chacun présent un certain nombre de briques (tant de briques d&#8217;une sorte, tant de briques d&#8217;une autre sorte), la relation modèle - type de brique étant modélisé par un <code>KitBrick</code>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./schema.svg" alt="schema"></span></p>
</div>
<div class="paragraph">
<p>Voici la structure SQL&#160; correspondante avec la syntaxe SQLite&#160;:</p>
</div>
<div class="listingblock">
<div class="title">structure.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="c1">-- Table color</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="s1">'color'</span> <span class="p">(</span>
  <span class="s1">'id'</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

  <span class="s1">'name'</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="n">idx_color_unique</span>
  <span class="k">ON</span> <span class="n">color</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>

<span class="c1">-- Table brick</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="s1">'brick'</span> <span class="p">(</span>
  <span class="s1">'id'</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

  <span class="s1">'name'</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="s1">'description'</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="s1">'color_id'</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

  <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="s1">'color_id'</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="s1">'color'</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- Table kit</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="s1">'kit'</span> <span class="p">(</span>
  <span class="s1">'id'</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

  <span class="s1">'name'</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="s1">'description'</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="c1">-- Table kit_brick</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="s1">'kit_brick'</span> <span class="p">(</span>
  <span class="s1">'id'</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

  <span class="s1">'kit_id'</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="s1">'brick_id'</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="s1">'quantity'</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

  <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="s1">'kit_id'</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="s1">'kit'</span><span class="p">(</span><span class="s1">'id'</span><span class="p">),</span>
  <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="s1">'brick_id'</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="s1">'brick'</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="s1">'idx_kit_brick_uniqu'</span>
  <span class="k">ON</span> <span class="s1">'kit_brick'</span><span class="p">(</span><span class="s1">'kit_id'</span><span class="p">,</span> <span class="s1">'brick_id'</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour créer une base avec la bonne structure, vous pouvez lancer la commande&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>sqlite3 orm-ruby.sqlite &lt; structure.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et ensuite explorer la base ainsi&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>sqlite3 orm-ruby.sqlite
SQLite version 3.24.0 2018-06-04 14:10:15
sqlite&gt; <span class="k">select </span>count<span class="o">(</span><span class="k">*</span><span class="o">)</span> from color<span class="p">;</span>
0
sqlite&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Certains ORMs comme Rails et Sequel fournissent des outils pour gérer les modifications de schéma de a base.
J&#8217;ai fais le choix ici de ne pas implémenter cette fonctionnalité car&#8201;—&#160;même si elle peut partager du code avec le reste de l&#8217;ORM &#160;—&#8201;elle est largement séparée et n&#8217;influe donc pas sur le noyau de l&#8217;outil.</p>
</div>
<div class="paragraph">
<p>Dans le monde Java, <a href="https://hibernate.org/orm/">l&#8217;ORM hibernate</a> qui est très utilisé ne fournit ainsi pas d&#8217;outil de migration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_un_dsl_pour_configurer_les_modèles">Un DSL pour configurer les modèles</h3>
<div class="paragraph">
<p>Pour générer les classes de modèle, je vais utiliser un fichier de configuration qui sera lu par un script.
Au début le fichier de configuration contiendra seulement les noms des modèles et les noms des tables correspondantes.</p>
</div>
<div class="paragraph">
<p>La syntaxe s&#8217;inspire des DSL de configuration qu&#8217;on trouve dans Rails&#160;:</p>
</div>
<div class="listingblock">
<div class="title">schema.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">define_model</span> <span class="s1">'Color'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'color'</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'Brick'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'brick'</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'Kit'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'kit'</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'KitBrick'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'kit_brick'</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La capacité d&#8217;utiliser des noms de table par défaut en les déduisant des noms des classes demanderait un peu plus de code sans changer le fonctionnement d&#8217;ensemble, du coup je ne vais pas l&#8217;intégrer.</p>
</div>
<div class="paragraph">
<p>Pour générer les modèles je dois commencer par lire le contenu de fichier.</p>
</div>
<div class="paragraph">
<p>Pour cela je commencer par créer la classe <code>ModelDefinition</code> qui contiendra les contenus des modèles tels que définis dans le fichier en étant passé dans chacun des blocs <code>define_model</code>.</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ModelDefinition</span>

  <span class="nb">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:table_name</span>

  <span class="c1"># @param [String] name</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
  <span class="k">end</span>

  <span class="c1"># @param [String]</span>
  <span class="c1"># @return [void]</span>
  <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
    <span class="vi">@table_name</span> <span class="o">=</span> <span class="n">table_name</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme le script de génération <code>generator.rb</code> des modèles sera lancé de manière indépendante du reste du code, je peux définir la méthode <code>define_model</code> de manière globale (dans un script indépendant elle ne risque pas de polluer l&#8217;espace de nommage), puis de faire un <code>require_relative</code> sur le fichier de configuration.</p>
</div>
<div class="paragraph">
<p>Lorsque le fichier sera chargé, la méthode <code>define_model</code> sera ainsi appelée pour chaque bloc du fichier <code>schema.rb</code>.</p>
</div>
<div class="paragraph">
<p>Chaque appel va instancier un <code>ModelDefinition</code> avec le nom du modèle, puis le passe en paramètre du bloc.</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># @yield [model_definition]</span>
<span class="c1"># @yieldparam [ModelDefinition] model_definition</span>
<span class="c1"># @yieldreturn [void]</span>
<span class="k">def</span> <span class="nf">define_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Defining model [</span><span class="si">#{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">]"</span>
  <span class="n">model_definition</span> <span class="o">=</span>
    <span class="no">ModelDefinition</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
  <span class="n">block</span><span class="p">.</span><span class="nf">yield</span><span class="p">(</span><span class="n">model_definition</span><span class="p">)</span>
<span class="k">end</span>

<span class="nb">require_relative</span> <span class="s1">'schema'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour pouvoir utiliser ensuite ces <code>ModelDefinition</code>, le constructeurs les stockera dans un tableau au fur et à mesure.</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ModelDefinition</span>

  <span class="no">MODELS_DEFINITIONS</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="nb">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:table_name</span>

  <span class="c1"># @param [String] name</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
    <span class="no">MODELS_DEFINITIONS</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
  <span class="k">end</span>

  <span class="c1"># …</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Après le chargement du fichier de configuration, <code>ModelDefinition::MODELS_DEFINITIONS</code> contiendra la ainsi liste des définitions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_un_template_pour_générer_le_fichier">Un template pour générer le fichier</h3>
<div class="paragraph">
<p>Une fois la configuration chargée je vais m&#8217;intéresser à la génération du code.</p>
</div>
<div class="paragraph">
<p>Comme à l&#8217;étape précendente, la première étape est de définir la syntaxe cible qui m&#8217;intéresse&#160;:</p>
</div>
<div class="listingblock">
<div class="title">models.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Color</span>

  <span class="c1"># @return [String]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name</span>
      <span class="s1">'color'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque modèle est dans une classe, exposant une méthode de classe pour récupérer le nom de la table.</p>
</div>
<div class="paragraph">
<p>Comme expliqué plus haut, je me sers d&#8217;erb pour la génération, voici donc le template de classe correspondant&#160;:</p>
</div>
<div class="listingblock">
<div class="title">models.rb.erb</div>
<div class="content">
<pre class="rouge highlight"><code>class &lt;%= model.name %&gt;

  # @return [String]
  def self.table_name
      '&lt;%= model.table_name %&gt;'
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour générer le fichier, il faut alors charger ce template, l&#8217;appliquer à chaque des définition qui sont disponibles dans <code>ModelDefinition::MODELS_DEFINITIONS</code>, et stocker le résultat dans un fichier.</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># …</span>

<span class="nb">require</span> <span class="s1">'erb'</span>

<span class="c1"># Récupère le template</span>
<span class="n">erb</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">IO</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'models.rb.erb'</span><span class="p">))</span>

<span class="c1"># Applique le template aux modèles</span>
<span class="n">models_code</span> <span class="o">=</span> <span class="no">ModelDefinition</span><span class="o">::</span><span class="no">MODELS_DEFINITIONS</span><span class="p">.</span>
    <span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
  <span class="c1"># Fait en sorte que le ModelDefinition soit disponible dans le template</span>
  <span class="c1"># via la variable `model`</span>
  <span class="n">erb</span><span class="p">.</span><span class="nf">result_with_hash</span><span class="p">(</span><span class="ss">model: </span><span class="n">model</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># Concatène le code des modèles et l'écrit dans un fichier</span>
<span class="no">IO</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span>
    <span class="s1">'models.rb'</span><span class="p">,</span>
    <span class="n">models_code</span><span class="p">.</span>
        <span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le code est alors terminé, il me manque seulement une tâche Rake pour pouvoir l&#8217;invoquer.
Comme les chemins des fichiers sont tous en dur dans le code, il n&#8217;y a pas besoin de le rendre paramétrable&#160;:</p>
</div>
<div class="listingblock">
<div class="title">Rakefile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">desc</span> <span class="s1">'Génère les modèles à partir du fichier schema.rb'</span>
<span class="n">task</span> <span class="ss">:generate_models</span> <span class="k">do</span>
  <span class="nb">require_relative</span> <span class="s1">'generator'</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut alors lancer la génération&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake generate_models
Defining model <span class="o">[</span>Color]
Defining model <span class="o">[</span>Brick]
Defining model <span class="o">[</span>Kit]
Defining model <span class="o">[</span>KitBrick]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et observer le résultat&#160;:</p>
</div>
<div class="listingblock">
<div class="title">models.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Color</span>

  <span class="c1"># @return [String]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name</span>
      <span class="s1">'color'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Brick</span>

  <span class="c1"># @return [String]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name</span>
      <span class="s1">'brick'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Kit</span>

  <span class="c1"># @return [String]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name</span>
      <span class="s1">'kit'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">KitBrick</span>

  <span class="c1"># @return [String]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name</span>
      <span class="s1">'kit_brick'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour le moment, tout ce que je peux faire c&#8217;est d&#8217;instancier les différentes classes&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'models'</span>
<span class="n">black</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mais la structure est en place, et dans l&#8217;article suivant je vais pouvoir m&#8217;en servir pour faire mes premières requêtes.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ORM-2">Partie 2&#160;: récupération des champs, insertion et sélection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ceci est le deuxième article d&#8217;une série de quatre décrivant pas à pas comment écrire un ORM SQL minimal en Ruby.</p>
</div>
<div class="paragraph">
<p>Après <a href="../ecrire-un-orm-en-ruby-1/">le premier article</a> où j&#8217;ai posé les bases de l&#8217;outil, je vais ici ajouter ce qu&#8217;il manque pour faire les premières requètes.</p>
</div>
<div class="sect2">
<h3 id="_des_modèles_avec_des_champs">Des modèles avec des champs</h3>
<div class="paragraph">
<p>La première étape va s&#8217;intéresser aux champs des modèles.</p>
</div>
<div class="paragraph">
<p>Il serait possible de les paramétrer via le fichier de configuration de schema <code>schema.rb</code>, mais je vais plutôt utiliser les métadonnées de la base de données, car c&#8217;est une bonne occasion de donner un aperçu de leur fonctionnement.</p>
</div>
<div class="paragraph">
<p>En effet même si tous les ORMs n&#8217;utilisent pas les métadonnées beaucoup le font, et comprendre que cela n&#8217;est pas si compliquée est bien utile.</p>
</div>
<div class="paragraph">
<p>Même si cela ne fait pas partie du standard SQL, la majorités des bases de données de ce type fournissent des requéter les métadonnées des bases telles que les tables, les index&#160;…</p>
</div>
<div class="paragraph">
<p>Suivant les systèmes on pourra utiliser du SQL&#8201;—&#160;en intérrogeant des tables particulières&#160;—&#8201;ou des commandes spécifiques.</p>
</div>
<div class="paragraph">
<p>Avec SQLite, l&#8217;accès aux métadonnées se fait via des <a href="https://www.sqlite.org/pragma.html">la commandes PRAGMA</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>$ sqlite3 orm-ruby.sqlite
sqlite&gt; .header on -- Active l'affichage des noms de colonnes dans les requêtes
sqlite&gt; pragma table_info('color'); -- Donne des informations sur la table `color`

cid|name|type|notnull|dflt_value|pk
0|id|INTEGER|1||1
1|name|TEXT|1||0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour chaque colonne <code>table_info</code> nous donne son identifiant, son nom, son type, si elle est nullable, son éventuelle valeur par défaut, et si il s&#8217;agit de la clé primaire de la table.</p>
</div>
<div class="paragraph">
<p>Avec la gem sqlite3, la méthode <code>SQLite3::Database#table_info</code> fait l&#8217;appel la pragma et renvoie le résultat sous une forme accessible.</p>
</div>
<div class="paragraph">
<p>Pour ajouter les colonnes disponibles dans chaque table, commençons par définir une classe <code>ColumnDefinition</code> qui contiendra les informations qui nous intéressent, à savoir le nom et le type de la colonne.</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ColumnDefinition</span>

  <span class="nb">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:type</span>

  <span class="c1"># @param [String] name</span>
  <span class="c1"># @param [String] type</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
    <span class="vi">@type</span> <span class="o">=</span> <span class="n">type</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite, je dois récupérer les colonnes de chaque table.
L&#8217;endroit le plus simple est de le faire juste avant de créer les classes de modèles, alors qu&#8217;on est déjà en train d&#8217;itérer sur chaque modèle, on pourra alors passer la liste des colonnes au template.</p>
</div>
<div class="paragraph">
<p>Mais pour commencer, il faut se connecter à la base de donnée.
Je vais utiliser une base en local avec un fichier stocké dans le répertoire du projet</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">DATABASE</span> <span class="o">=</span> <span class="no">SQLite3</span><span class="o">::</span><span class="no">Database</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'orm-ruby.sqlite'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>puis&#160;:</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">models_code</span> <span class="o">=</span> <span class="no">ModelDefinition</span><span class="o">::</span><span class="no">MODELS_DEFINITIONS</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
  <span class="c1"># Liste les colonnes de la table correspondante</span>
  <span class="n">columns_definitions</span> <span class="o">=</span> <span class="no">DATABASE</span><span class="p">.</span><span class="nf">table_info</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">table_name</span><span class="p">).</span><span class="nf">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">column_info</span><span class="o">|</span>
    <span class="n">column_name</span> <span class="o">=</span> <span class="n">column_info</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span>
    <span class="n">column_type</span> <span class="o">=</span> <span class="n">column_info</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span>
    <span class="no">ColumnDefinition</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">column_type</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">erb</span><span class="p">.</span><span class="nf">result_with_hash</span><span class="p">(</span><span class="ss">model: </span><span class="n">model</span><span class="p">,</span> <span class="ss">columns_definitions: </span><span class="n">columns_definitions</span><span class="p">)</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans le template, <code>columns_definitions</code> contient alors la liste des <code>ColumnDefinition</code> prêt à l&#8217;emploi.</p>
</div>
<div class="paragraph">
<p>Presque prêt à l&#8217;emploi car il reste une subtilité&#160;: <code>table_info</code> renvoie les types SQL des colonnes (ou plus précisément le type SQLite) comme <code>TEXT</code>, pour pouvoir l&#8217;utiliser dans le code je dois le transformer en types Ruby comme <code>String</code>.</p>
</div>
<div class="paragraph">
<p>Pour se faire, nous allons utiliser une <code>Hash</code> pour faire la conversion entre les deux.</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">SQLITE_TYPE_TO_RUBY_CLASS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'INTEGER'</span> <span class="o">=&gt;</span> <span class="s1">'Integer'</span><span class="p">,</span>
    <span class="s1">'TEXT'</span> <span class="o">=&gt;</span> <span class="s1">'String'</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Elle ne contient que les types que l&#8217;on va rencontrer dans notre exemple, il sera ensuite possible de l&#8217;enrichir en fonction des besoins.</p>
</div>
<div class="paragraph">
<p>En modifiant le code pour utiliser <code>SQLITE_TYPE_TO_RUBY_CLASS</code>, cela donne :</p>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">models_code</span> <span class="o">=</span> <span class="no">ModelDefinition</span><span class="o">::</span><span class="no">MODELS_DEFINITIONS</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
  <span class="c1"># Liste les colonnes de la table correspondante</span>
  <span class="n">columns_definitions</span> <span class="o">=</span> <span class="no">DATABASE</span><span class="p">.</span><span class="nf">table_info</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">table_name</span><span class="p">).</span><span class="nf">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">column_info</span><span class="o">|</span>
    <span class="n">column_name</span> <span class="o">=</span> <span class="n">column_info</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span>
    <span class="n">sql_type</span> <span class="o">=</span> <span class="n">column_info</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span>
    <span class="c1"># Transforme le type SQL en type Ruby</span>
    <span class="n">ruby_type</span> <span class="o">=</span> <span class="no">SQLITE_TYPE_TO_RUBY_CLASS</span><span class="p">[</span><span class="n">sql_type</span><span class="p">]</span>
    <span class="no">ColumnDefinition</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">ruby_type</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">erb</span><span class="p">.</span><span class="nf">result_with_hash</span><span class="p">(</span><span class="ss">model: </span><span class="n">model</span><span class="p">,</span> <span class="ss">columns_definitions: </span><span class="n">columns_definitions</span><span class="p">)</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Avec le nom et le type de chaque colonne, je vais pouvoir générer les getter et les setters en itérant sur les <code>ColumnDefinition</code> dans le template&#160;:</p>
</div>
<div class="listingblock">
<div class="title">models.erb.rb</div>
<div class="content">
<pre class="rouge highlight"><code>class &lt;%= model.name %&gt;

  &lt;% columns_definitions.each do |column_definition| %&gt;
  &lt;% column_name = column_definition.name %&gt;
  &lt;% column_type = column_definition.type %&gt;
  # @return [&lt;%= column_type %&gt;]
  def &lt;%= column_name %&gt;
    @&lt;%= column_name %&gt;
  end

  # @param [&lt;%= column_type%&gt;] &lt;%= column_name %&gt;
  # @return [void]
  def &lt;%= column_name %&gt;=(&lt;%= column_name %&gt;)
    @&lt;%= column_name %&gt; = &lt;%= column_name %&gt;
  end
  &lt;% end %&gt;

end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui donne ce résultat&#160;:</p>
</div>
<div class="listingblock">
<div class="title">models.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span>

  <span class="c1"># @return [Integer]</span>
  <span class="k">def</span> <span class="nf">id</span>
    <span class="vi">@id</span>
  <span class="k">end</span>

  <span class="c1"># @param [Integer] id</span>
  <span class="c1"># @return [void]</span>
  <span class="k">def</span> <span class="nf">id</span><span class="o">=</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="vi">@id</span> <span class="o">=</span> <span class="nb">id</span>
  <span class="k">end</span>

  <span class="c1"># @return [String]</span>
  <span class="k">def</span> <span class="nf">name</span>
    <span class="vi">@name</span>
  <span class="k">end</span>

  <span class="c1"># @param [String] name</span>
  <span class="c1"># @return [void]</span>
  <span class="k">def</span> <span class="nf">name</span><span class="o">=</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c1"># …</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui permet d&#8217;écrire&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'models'</span>

<span class="n">black</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span>
<span class="n">black</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Black'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut voir ici l&#8217;intérêt de la génération de code à froid&#160;: on peut facilement consulter les méthodes disponibles avec leurs informations de type.
Avec un IDE on peut même disposer de l&#8217;autocompletion.</p>
</div>
<div class="paragraph">
<p>En cas d&#8217;évolution d&#8217;un modèle, l&#8217;évolution sera visible dans les classes générées.</p>
</div>
<div class="paragraph">
<p>Je ne l&#8217;utilise pas dans mon exemple, mais l&#8217;information de nullabilité des colonnes peut servir pour renseigner la nullabilité des paramètres ou des retours des méthodes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_linsertion">L&#8217;insertion</h3>
<div class="paragraph">
<p>Une fois qu&#8217;on a la liste des champs et qu&#8217;il est possible de leur attribuer des valeurs, il est temps de pouvoir insérer ces données dans la base, en ajoutant une méthode <code>insert</code> aux modèles.</p>
</div>
<div class="paragraph">
<p>Pour cela il faut générer ce type de requêtes&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">table_name</span>
  <span class="p">(</span><span class="n">column_name_1</span><span class="p">,</span> <span class="n">column_name_2</span><span class="p">)</span>
  <span class="k">values</span> <span class="p">(</span><span class="n">column_value_1</span><span class="p">,</span> <span class="n">column_value_2</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour partager le code entre les modèles, je vais ajouter une classe <code>Model</code> qui sera parente des classes de modèles.</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># @abstract</span>
<span class="k">class</span> <span class="nc">Model</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Je la marque comme abstraite avec <code>@abstract</code> pour indiquer qu&#8217;elle n&#8217;est pas utilisable directement mais qu&#8217;on doit passer par les classes dérivées.</p>
</div>
<div class="paragraph">
<p>Pour générer les requêtes d&#8217;insertion, je vais avoir besoin du nom de la table et de la liste des colonnes de chaque modèle.
Pour cela je vais ajouter des méthodes de classes pour récupérer les valeurs.</p>
</div>
<div class="paragraph">
<p>Je les déclare dans la classe parente&#160;:</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># @abstract</span>
<span class="k">class</span> <span class="nc">Model</span>

  <span class="c1"># Méthode à implémenter dans les sous-classes</span>
  <span class="c1"># @abstract</span>
  <span class="c1"># @return [String]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span>
  <span class="k">end</span>

  <span class="c1"># Méthode à implémenter dans les sous-classes</span>
  <span class="c1"># @abstract</span>
  <span class="c1"># @return [Array&lt;String&gt;]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">columns</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Puis je les ajoute au template de modèle, avec la déclaration de l&#8217;héritage&#160;:</p>
</div>
<div class="listingblock">
<div class="title">models.erb.rb</div>
<div class="content">
<pre class="rouge highlight"><code>class &lt;%= model.name %&gt; &lt; Model
  # @return [String]
  def self.table_name
      '&lt;%= model.table_name %&gt;'
  end

  # @return [Array&lt;String&gt;]
  def self.columns
      &lt;%= columns_definitions.map do |column_definition|
        column_definition.name
      end %&gt;
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce qui donne, après avoir relançé la génération avec la commande <code>rake generate_models</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="title">models.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Color</span> <span class="o">&lt;</span> <span class="no">Model</span>

  <span class="c1"># @return [String]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">table_name</span>
      <span class="s1">'color'</span>
  <span class="k">end</span>

  <span class="c1"># @return [Array&lt;String&gt;]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">columns</span>
      <span class="p">[</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="c1"># …</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Avec ces méthodes je peux générer la requête, en ajoutant une connection à la base pour pouvoir l&#8217;exécuter.</p>
</div>
<div class="paragraph">
<p>Pour la requête je vais utiliser la méthode <code>SQLite3::Database#execute</code>, qui permet de passer les valeurs des colonnes en paramètre plutôt que de les mettre dans le corps de la requête, ce qui donnera ce genre d&#8217;appel&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">DATABASE</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s1">'INSERT INTO color (name) values (?)'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Black'</span><span class="p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette syntaxe permet d&#8217;éviter d&#8217;avoir à se préocuper du format à utiliser pour passer les valeurs à la base, et donc d&#8217;éviter des risque de sécurité.</p>
</div>
<div class="paragraph">
<p>Dans notre case les valeurs de l'`id` des modèles ne doivent pas être insérée car elles sont gérées par la base, c&#8217;est pour cela que les colonnes <code>id</code> sont déclarées en <code>AUTOINCREMENT</code>.
Cela simplifie le code et fournit une garantie d&#8217;unicité dans le cas d&#8217;une base SQL standard.</p>
</div>
<div class="paragraph">
<p>La manière de s&#8217;y prendre n&#8217;est pas standardisé et dépend donc de la base de données.
Il y a deux grandes approches&#160;: soit les valeurs sont retournées par la requête d&#8217;insertion, ou une requête spécifique permet de récupérer les <code>id</code> des valeurs qu&#8217;on vient d&#8217;insérer.</p>
</div>
<div class="paragraph">
<p>SQLite utilise la deuxième solution via <a href="https://www.sqlite.org/lang_corefunc.html#last_insert_rowid"><code>last_insert_rowid()</code></a>.</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'sqlite3'</span>

<span class="c1"># @abstract</span>
<span class="k">class</span> <span class="nc">Model</span>

  <span class="c1"># Connection à la base pour executer les requ^tes</span>
  <span class="no">DATABASE</span> <span class="o">=</span> <span class="no">SQLite3</span><span class="o">::</span><span class="no">Database</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'orm-ruby.sqlite'</span><span class="p">)</span>

  <span class="c1"># @return [void]</span>
  <span class="k">def</span> <span class="nf">insert</span>
    <span class="c1"># Liste des noms de colonnes sans la colonne id</span>
    <span class="c1"># car les valeurs des ids sont gérées par la base</span>
    <span class="n">columns_names_except_id</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">columns</span><span class="p">.</span>
        <span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">column</span><span class="o">|</span> <span class="n">column</span> <span class="o">!=</span> <span class="s1">'id'</span> <span class="p">}</span>

    <span class="c1"># Noms des colonnes échappées pour éviter</span>
    <span class="c1"># les problèmes avec des guillemets et d'autres symboles</span>
    <span class="n">quoted_columns_names_except_id</span> <span class="o">=</span> <span class="n">columns_names_except_id</span><span class="p">.</span>
        <span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">column_name</span><span class="o">|</span> <span class="no">SQLite3</span><span class="o">::</span><span class="no">Database</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span> <span class="p">}</span>

    <span class="c1"># Valeurs des colonnes à part la colonne 'id'</span>
    <span class="n">columns_values_except_id</span> <span class="o">=</span> <span class="n">columns_names_except_id</span><span class="p">.</span>
        <span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">column_name</span><span class="o">|</span> <span class="nb">self</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span> <span class="p">}</span>

    <span class="c1"># Les requêtes vont ressembler à</span>
    <span class="c1"># INSERT INTO table_name</span>
    <span class="c1">#   (column_name_1, column_name_2)</span>
    <span class="c1">#   VALUES (?, ?)</span>
    <span class="no">DATABASE</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s2">"INSERT INTO </span><span class="si">#{</span><span class="no">SQLite3</span><span class="o">::</span><span class="no">Database</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">table_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
            <span class="s2">"(</span><span class="si">#{</span><span class="n">quoted_columns_names_except_id</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2">) "</span> <span class="o">+</span>
            <span class="s2">"VALUES (</span><span class="si">#{</span><span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">columns_names_except_id</span><span class="p">.</span><span class="nf">length</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span><span class="p">,</span>
        <span class="n">columns_values_except_id</span>
    <span class="p">)</span>

    <span class="c1"># Définit la valeur  du champ `id` du modèle</span>
    <span class="c1"># en récupérant la valeur attribuée par la base</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">id</span> <span class="o">=</span> <span class="no">DATABASE</span><span class="p">.</span><span class="nf">last_insert_row_id</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les méthodes <code>table_name</code> et <code>columns</code> étant implémentées dans chaque classe de modèle, utiliser <code>self.class.table_name</code> et <code>self.class.columns</code> dans la classe parente <code>Model</code> appellera bien la méthode spécifique de chaque modèle plutôt que les méthodes de la classe <code>Model</code>.</p>
</div>
<div class="paragraph">
<p>Avec ce code, on peut enfin insérer les données&#160;:</p>
</div>
<div class="listingblock">
<div class="title">script.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'model'</span>
<span class="nb">require_relative</span> <span class="s1">'models'</span>

<span class="n">black</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span>
<span class="n">black</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Black'</span>
<span class="n">black</span><span class="p">.</span><span class="nf">insert</span>

<span class="n">brick</span> <span class="o">=</span> <span class="no">Brick</span><span class="p">.</span><span class="nf">new</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">color_id</span> <span class="o">=</span> <span class="n">black</span><span class="p">.</span><span class="nf">id</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Awesome brick'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s1">'This brick is awesome'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">insert</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut vérifier dans la base que tout s&#8217;est bien passé&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$bundle</span> <span class="nb">exec </span>ruby script.rb
<span class="nv">$ </span>sqlite3 orm-ruby.sqlite

sqlite&gt; <span class="k">select</span> <span class="k">*</span> from color<span class="p">;</span>

1|Black

sqlite&gt; <span class="k">select</span> <span class="k">*</span> from brick<span class="p">;</span>

1|Awesome brick|This brick is awesome|1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_la_récupération">La récupération</h3>
<div class="paragraph">
<p>Maintenant que je peux insérer des données, je vais pouvoir m&#8217;intéresser à leur récuparation.</p>
</div>
<div class="paragraph">
<p>Je commence par m&#8217;occuper de la récupération de l&#8217;intégralité des données d&#8217;une table en ajoutant une méthode de classe <code>all</code> aux modèles.</p>
</div>
<div class="paragraph">
<p>Cela permettra des appels du type&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Color</span><span class="p">.</span><span class="nf">all</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En SQL cela donne ce type de requêtes&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">SELECT</span> <span class="n">column_name_1</span><span class="p">,</span> <span class="n">column_name_2</span>
  <span class="k">FROM</span> <span class="k">table_name</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les noms de la table et des colonnes sont à disposition pour construire la requête.</p>
</div>
<div class="paragraph">
<p>Une fois les valeurs récupérées, pour chaque ligne trouvée il faur créer une instance de la classe du modèle, et attribuer leurs valeurs au différents champs.</p>
</div>
<div class="paragraph">
<p>Les noms des attributs étant les mêmes que ceux des colonnes, pour chaque colonne <code>nom_de_colonne</code>, j&#8217;appellerait le setter <code>nom_de_colonne=</code> via la méthode <code>send</code> qui permet d&#8217;appeller une méthode dynamiquement à partir de son nom.</p>
</div>
<div class="paragraph">
<p>À l&#8217;inverse du cas précédent, il nous faudra également récupérer la valeur de la colonne <code>id</code>.</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Model</span>
  <span class="c1"># @return [Array]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all</span>
    <span class="n">quoted_columns_names</span> <span class="o">=</span> <span class="n">columns</span><span class="p">.</span>
        <span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">column_name</span><span class="o">|</span> <span class="no">SQLite3</span><span class="o">::</span><span class="no">Database</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span> <span class="p">}</span>

    <span class="c1"># Les requêtes vont ressembler à</span>
    <span class="c1"># SELECT column_name_1, column_name_2</span>
    <span class="c1">#   FROM table_name</span>
    <span class="no">DATABASE</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s2">"SELECT </span><span class="si">#{</span><span class="n">quoted_columns_names</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
            <span class="s2">"FROM </span><span class="si">#{</span><span class="no">SQLite3</span><span class="o">::</span><span class="no">Database</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
    <span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">result_row</span><span class="o">|</span>
      <span class="c1"># Instancie l'objet de la classe du modèle</span>
      <span class="n">model_instance</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">new</span>
      <span class="c1"># Pour chaque colonne</span>
      <span class="n">columns</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">column</span><span class="p">,</span> <span class="n">column_index</span><span class="o">|</span>
        <span class="c1"># On récupère la valeur</span>
        <span class="n">column_value</span> <span class="o">=</span> <span class="n">result_row</span><span class="p">[</span><span class="n">column_index</span><span class="p">]</span>
        <span class="c1"># On stocke la valeur dans l'attribue correspondant</span>
        <span class="n">model_instance</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">column</span><span class="si">}</span><span class="s2">="</span><span class="p">,</span> <span class="n">colonne_value</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">model_instance</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut alors récupérer des données&#160;:</p>
</div>
<div class="listingblock">
<div class="title">script.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'model'</span>
<span class="nb">require_relative</span> <span class="s1">'models'</span>

<span class="n">black</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span>
<span class="n">black</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Black'</span>
<span class="n">black</span><span class="p">.</span><span class="nf">insert</span>

<span class="nb">puts</span> <span class="s1">'# Les couleurs'</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">color</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"  </span><span class="si">#{</span><span class="n">color</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> : </span><span class="si">#{</span><span class="n">color</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">brick</span> <span class="o">=</span> <span class="no">Brick</span><span class="p">.</span><span class="nf">new</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">color_id</span> <span class="o">=</span> <span class="n">black</span><span class="p">.</span><span class="nf">id</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Awesome brick'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s1">'This brick is awesome'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">insert</span>

<span class="nb">puts</span> <span class="s1">'Les briques'</span>
<span class="no">Brick</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">brick</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"  </span><span class="si">#{</span><span class="n">brick</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> : </span><span class="si">#{</span><span class="n">brick</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">brick</span><span class="p">.</span><span class="nf">description</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">brick</span><span class="p">.</span><span class="nf">color_id</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">id</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">name</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">description</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">color_id</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>ruby script.rb
Les couleurs
  1 : Black
Les briques
  1 : Awesome brick, This brick is awesome, 1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_et_la_suppression">Et la suppression</h3>
<div class="paragraph">
<p>Pour terminer, après l&#8217;insertion et la récupération il est temps de supprimer des données.</p>
</div>
<div class="paragraph">
<p>Dans le standard SQL, il existe une commande <code>TRUNCATE table_name</code> qui supprime le contenu d&#8217;une table.</p>
</div>
<div class="paragraph">
<p>Malheuresement elle n&#8217;est pas disponible dans SQLite, je vais donc devoir utiliser la requête SQL&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">DELETE</span> <span class="k">FROM</span> <span class="k">table_name</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Je vais tout de même appeller la méthode <code>truncate</code> pour qu&#8217;elle corresponde à la commande SQL, même l&#8217;implémentation ne l&#8217;utilise pas.</p>
</div>
<div class="paragraph">
<p>On a ici un exemple où l&#8217;ORM doit assurer la compatibilité entre les systèmes de bases de données.
Si ce cas est assez simple, il permet de comprendre la manière dont les choses pourraient être mises en œuvre&#160;:une méthode de base qui utiliserait la commande <code>truncate</code>, et une classe spécifique à SQLite qui utiliserait la requête <code>delete</code>.</p>
</div>
<div class="paragraph">
<p>Le code résultant est assez court et s&#8217;inspire des méthodes existantes&#160;:</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Model</span>
  <span class="c1"># @return [void]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">truncate</span>
    <span class="no">DATABASE</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">"DELETE FROM </span><span class="si">#{</span><span class="no">SQLite3</span><span class="o">::</span><span class="no">Database</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On peut alors la tester</p>
</div>
<div class="listingblock">
<div class="title">script.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'model'</span>
<span class="nb">require_relative</span> <span class="s1">'models'</span>

<span class="no">Brick</span><span class="p">.</span><span class="nf">truncate</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">truncate</span>

<span class="nb">puts</span> <span class="s1">'# Les couleurs'</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">color</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"  </span><span class="si">#{</span><span class="n">color</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> : </span><span class="si">#{</span><span class="n">color</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s1">'Les briques'</span>
<span class="no">Brick</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">brick</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"  </span><span class="si">#{</span><span class="n">brick</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> : </span><span class="si">#{</span><span class="n">brick</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">brick</span><span class="p">.</span><span class="nf">description</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">brick</span><span class="p">.</span><span class="nf">color_id</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">id</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">name</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">description</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">color_id</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>ruby script.rb
Les couleurs
  1 : Black
Les briques
  1 : Awesome brick, This brick is awesome, 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est tout pour cette fois.
Pour l&#8217;article suivant, je vais enrichir les méthodes de récupération pour pouvoir ajouter des filtres et trier les données.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ORM-3">Partie 3&#160;: filtrage et ordre</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ceci est le troisième article d&#8217;une série de quatre décrivant pas à pas comment écrire un ORM SQL minimal en Ruby.</p>
</div>
<div class="paragraph">
<p>Après <a href="../ecrire-un-orm-en-ruby-1/">le premier article</a> où j&#8217;ai posé les bases de l&#8217;outil, et <a href="../ecrire-un-orm-en-ruby-1/">le deuxième article</a> où j&#8217;ai ajouté la génération des requêtes, je vais m&#8217;occuper ici du filtrage et de l&#8217;order des résultats dans les requêtes de sélection.</p>
</div>
<div class="paragraph">
<p>À la fin de l&#8217;article, il sera possible d&#8217;utiliser ce genre d&#8217;appels&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Color</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'name = ?'</span><span class="p">,</span> <span class="s1">'Black'</span><span class="p">).</span><span class="nf">first</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'name = ?'</span><span class="p">,</span> <span class="s1">'b*'</span><span class="p">).</span><span class="nf">order_by</span><span class="p">(</span><span class="s1">'name desc'</span><span class="p">).</span><span class="nf">all</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_lapproche_builder">L&#8217;approche &#8220;builder&#8221;</h3>
<div class="paragraph">
<p>Ce type d&#8217;API utilise souvent le design pattern &#8220;builder&#8221; qui consiste à stocker les différent paramètres d&#8217;une requête dans des objets, et les utiliser au moment où la requête est executée.</p>
</div>
<div class="paragraph">
<p>Ainsi la commande</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Color</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'name = ?'</span><span class="p">,</span> <span class="s1">'b*'</span><span class="p">).</span><span class="nf">order_by</span><span class="p">(</span><span class="s1">'name desc'</span><span class="p">).</span><span class="nf">all</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>peut se décomposer en</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">query_parameters_1</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'name = ?'</span><span class="p">,</span> <span class="s1">'b*'</span><span class="p">)</span>
<span class="n">query_parameters_2</span> <span class="o">=</span> <span class="n">query_parameters_1</span><span class="p">.</span><span class="nf">order_by</span><span class="p">(</span><span class="s1">'name desc'</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">query_parameters_2</span><span class="p">.</span><span class="nf">all</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le premier appel <code>Color.where</code> construit un objet qui contient la condition <code>where</code>, appeler <code>order_by</code> sur cet objet construit un autre objet qui contient la condition <code>where</code> ainsi que l&#8217;ordre de tri du <code>order_by</code>.</p>
</div>
<div class="paragraph">
<p>Finalement appeller <code>all</code> sur le dernier objet utilise tous les paramètres stockés jusque là pour construire la requête.</p>
</div>
<div class="paragraph">
<p>Quand on enchaîne plusieurs appels comme dans</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Color</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'name = ?'</span><span class="p">,</span> <span class="s1">'b*'</span><span class="p">).</span><span class="nf">order_by</span><span class="p">(</span><span class="s1">'name desc'</span><span class="p">).</span><span class="nf">all</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>le code construit donc une suite d&#8217;objets, un à chaque appel.</p>
</div>
</div>
<div class="sect2">
<h3 id="_la_classe_queryparameters">La classe <code>QueryParameters</code></h3>
<div class="paragraph">
<p>La classe <code>QueryParameters</code> va donc contenir les différents types de paramètres qu&#8217;on peut utiliser dans une requêtes.
Dans notre exemple je vais couvrir le cas des filtres, de l&#8217;ordre et du nombre d&#8217;éléments remontés, mais dans un ORM plus complet il peut s&#8217;agit de l&#8217;ensemble de la grammaire SQL : <code>group by</code>, <code>distinct</code>, pouvoir choisir quels champs sont remontés&#160;…</p>
</div>
<div class="paragraph">
<p>Voici le début de la classe avec ses attributs&#160;:</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">QueryParameters</span>

  <span class="c1"># @param [Class] model_class</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>
    <span class="vi">@model_class</span> <span class="o">=</span> <span class="n">model_class</span>
    <span class="vi">@wheres</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="vi">@order_bys</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En plus des paramètres pour les <code>where</code> et les <code>order by</code>, elle a besoin de connaître la classe du modèle à traiter pour avoir accès au nom de la table et aux champs, et pour savoir quels objets instancier avec les résultats.</p>
</div>
<div class="paragraph">
<p>Comme décrit plus haut, appeller <code>where</code> ou <code>order_by</code> construit une nouvelle instance de <code>QueryParameters</code> en ajoutant le paramètre correspondant et la renvoie.</p>
</div>
<div class="paragraph">
<p>La méthode <code>order_by</code> prend un seul paramètre qui est une chaîne de caractère qui contient l&#8217;information de tri comme <code>'name desc'</code>.
Ils sont stockés sous la forme d&#8217;un tableau dans l&#8217;attribut <code>@order_bys</code>.</p>
</div>
<div class="paragraph">
<p>La méthode <code>where</code> prend un nombre variable de paramètres, le premier est une chaîne de caractère qui contient l&#8217;expression SQL comme <code>'name = ?'</code> et les éventuels paramètres suivants contiennent les valeurs à utiliser comme <code>'Black'</code> et auront donc des types variés (chaîne de charactère, nombre entier ou à virgule flotante&#160;…).
Ils sont stockés sous la forme d&#8217;un tableau de table de hachages (<code>Hash</code>) dans l&#8217;attribut <code>@wheres</code>, .</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">QueryParameters</span>
  <span class="c1"># …</span>

  <span class="c1"># @param [String] expression</span>
  <span class="c1"># @param [Array] parameters</span>
  <span class="c1"># @return [QueryParameters]</span>
  <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="o">*</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">new_query_parameters</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">dup</span>
    <span class="n">new_query_parameters</span><span class="p">.</span><span class="nf">wheres</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="ss">expression: </span><span class="n">expression</span><span class="p">,</span> <span class="ss">parameters: </span><span class="n">parameters</span><span class="p">}</span>
    <span class="n">new_query_parameters</span>
  <span class="k">end</span>

  <span class="c1"># @param [String] order_by</span>
  <span class="c1"># @return [QueryParameters]</span>
  <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
    <span class="n">new_query_parameters</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">dup</span>
    <span class="n">new_query_parameters</span><span class="p">.</span><span class="nf">order_bys</span> <span class="o">&lt;&lt;</span> <span class="n">order_by</span>
    <span class="n">new_query_parameters</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_les_méthodes_du_modèle">Les méthodes du modèle</h3>
<div class="paragraph">
<p>Cela permet de construire un <code>QueryParameters</code> à partir d&#8217;un <code>QueryParameters</code> existant, mais il faut aussi pouvoir construire le premier <code>QueryParameters</code> à partir du modèle, par exemple quand on appelle <code>Color.where('name = ?', 'Black')</code>.</p>
</div>
<div class="paragraph">
<p>Cela signifie ajouter ces mêmes méthodes aux modèles, qui initialisent le <code>QueryParameters</code> avec la classe du modèle et appelent les méthodes correspondantes sur le <code>QueryParameters</code>.</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Model</span>
  <span class="c1"># @return [QueryParameters]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">query_parameters</span>
    <span class="no">QueryParameters</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># @param [String] expression</span>
  <span class="c1"># @param [Array] parameters</span>
  <span class="c1"># @return [QueryParameters]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">where</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="o">*</span><span class="n">parameters</span><span class="p">)</span>
    <span class="n">query_parameters</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="o">*</span><span class="n">parameters</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># @param [String] order_by</span>
  <span class="c1"># @return [QueryParameters]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
    <span class="n">query_parameters</span><span class="p">.</span><span class="nf">order_by</span><span class="p">(</span><span class="n">order_by</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Avec cela je peux appeler <code>Color.where('name = ?', 'b*').order_by('name desc')</code> et récupérer un <code>QueryParameters</code> avec les bonnes données, reste ensuite à s&#8217;occuper de la génération de la requête.</p>
</div>
</div>
<div class="sect2">
<h3 id="_la_requête">La requête</h3>
<div class="paragraph">
<p>La méthode existante <code>Model#all</code> construit ce genre de requêtes&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">SELECT</span> <span class="n">column_name_1</span><span class="p">,</span> <span class="n">column_name_2</span>
  <span class="k">FROM</span> <span class="k">table_name</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Avec les nouveaux paramètres, cela va donner&#160;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">SELECT</span> <span class="n">column_name_1</span><span class="p">,</span> <span class="n">column_name_2</span>
  <span class="k">FROM</span> <span class="k">table_name</span>
  <span class="k">WHERE</span> <span class="n">column_A</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span> <span class="n">column_B</span> <span class="o">&lt;</span> <span class="o">?</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">column_X</span> <span class="k">asc</span><span class="p">,</span> <span class="n">column_Y</span> <span class="k">desc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour les <code>where</code> et <code>order by</code> la logique est la même&#160;: s&#8217;il existe au moins un paramétre de ce type, ajouter la clause en concaténants les éléments séparés par des <code>AND</code> ou des virgules, et pour le <code>where</code> il faut ensuite passer les valeurs à la requête sous forme d&#8217;un tableau contenant l&#8217;ensemble des éléments dans le bon ordre.</p>
</div>
<div class="paragraph">
<p>La partie finale de la méthode qui instancie et renseigne les modèles est reprise de la méthode <code>Model#all</code>.</p>
</div>
<div class="paragraph">
<p>C&#8217;est un peu fastidieux mais pas si long que ça&#160;:</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">QueryParameters</span>
  <span class="c1"># …</span>

  <span class="c1"># @return [Array]</span>
  <span class="k">def</span> <span class="nf">all</span>
    <span class="n">quoted_columns_names</span> <span class="o">=</span> <span class="vi">@model_class</span><span class="p">.</span><span class="nf">columns</span><span class="p">.</span>
        <span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">column_name</span><span class="o">|</span> <span class="no">SQLite3</span><span class="o">::</span><span class="no">Database</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span> <span class="p">}</span>

    <span class="k">if</span> <span class="vi">@wheres</span><span class="p">.</span><span class="nf">empty?</span>
      <span class="n">where_clause</span> <span class="o">=</span> <span class="s1">' '</span>
      <span class="n">where_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span>
      <span class="n">where_clause</span> <span class="o">=</span> <span class="s2">"WHERE </span><span class="si">#{</span><span class="vi">@wheres</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">where</span><span class="o">|</span> <span class="n">where</span><span class="p">[</span><span class="ss">:expression</span><span class="p">]</span> <span class="si">}</span><span class="s2">.join(' AND ')} "</span>
      <span class="n">where_params</span> <span class="o">=</span> <span class="vi">@wheres</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">where</span><span class="o">|</span> <span class="n">where</span><span class="p">[</span><span class="ss">:parameters</span><span class="p">]</span> <span class="p">}.</span><span class="nf">flatten</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="vi">@order_bys</span><span class="p">.</span><span class="nf">empty?</span>
      <span class="n">order_by_clause</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="k">else</span>
      <span class="n">order_by_clause</span> <span class="o">=</span> <span class="s2">"ORDER BY </span><span class="si">#{</span><span class="vi">@order_bys</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2"> "</span>
    <span class="k">end</span>

    <span class="c1"># Les requêtes vont ressembler à</span>
    <span class="c1"># SELECT column_name_1, column_name_2</span>
    <span class="c1">#   FROM table_name</span>
    <span class="c1">#   WHERE column_A = ? AND column_B &lt; ?</span>
    <span class="c1">#   ORDER BY column_X asc, column_Y desc</span>
    <span class="no">DATABASE</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s2">"SELECT </span><span class="si">#{</span><span class="n">quoted_columns_names</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
            <span class="s2">"FROM </span><span class="si">#{</span><span class="vi">@model_class</span><span class="p">.</span><span class="nf">quoted_table_name</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
            <span class="n">where_clause</span> <span class="o">+</span>
            <span class="n">order_by_clause</span><span class="p">,</span>
        <span class="n">where_params</span>
    <span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">result_row</span><span class="o">|</span>
      <span class="c1"># Construit les instances du modèle</span>
      <span class="n">model_instance</span> <span class="o">=</span> <span class="vi">@model_class</span><span class="p">.</span><span class="nf">new</span>
      <span class="vi">@model_class</span><span class="p">.</span><span class="nf">columns</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">column</span><span class="p">,</span> <span class="n">column_index</span><span class="o">|</span>
        <span class="n">model_instance</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">column</span><span class="si">}</span><span class="s2">="</span><span class="p">,</span> <span class="n">result_row</span><span class="p">[</span><span class="n">column_index</span><span class="p">])</span>
      <span class="k">end</span>
      <span class="n">model_instance</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ne me reste plus qu&#8217;à remplacer l&#8217;implémentation de <code>Model#all</code> existante par un appel à cette nouvelle méthode, pour pouvoir récupérer tous les éléments d&#8217;un modèle.</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Model</span>
  <span class="c1"># …</span>

  <span class="c1"># @return [Array]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all</span>
    <span class="n">query_parameters</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est le moment de tester&#160;:</p>
</div>
<div class="listingblock">
<div class="title">script.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'model'</span>
<span class="nb">require_relative</span> <span class="s1">'models'</span>

<span class="no">Brick</span><span class="p">.</span><span class="nf">truncate</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">truncate</span>

<span class="n">black</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span>
<span class="n">black</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Black'</span>
<span class="n">black</span><span class="p">.</span><span class="nf">insert</span>

<span class="n">yellow</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span>
<span class="n">yellow</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Yellow'</span>
<span class="n">yellow</span><span class="p">.</span><span class="nf">insert</span>

<span class="n">brick</span> <span class="o">=</span> <span class="no">Brick</span><span class="p">.</span><span class="nf">new</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">color_id</span> <span class="o">=</span> <span class="n">black</span><span class="p">.</span><span class="nf">id</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Awesome brick'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s1">'This brick is awesome'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">insert</span>

<span class="nb">puts</span> <span class="s1">'# All colors'</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">color</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">color</span><span class="p">.</span><span class="nf">id</span>
  <span class="nb">puts</span> <span class="n">color</span><span class="p">.</span><span class="nf">name</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s1">'# All Bricks'</span>
<span class="no">Brick</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">brick</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">id</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">name</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">description</span>
  <span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">color_id</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s1">'# Black color'</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'name = ?'</span><span class="p">,</span> <span class="s1">'Black'</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">color</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">color</span><span class="p">.</span><span class="nf">id</span>
  <span class="nb">puts</span> <span class="n">color</span><span class="p">.</span><span class="nf">name</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s1">'# Colors by name'</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">order_by</span><span class="p">(</span><span class="s1">'name desc'</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">color</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">color</span><span class="p">.</span><span class="nf">id</span>
  <span class="nb">puts</span> <span class="n">color</span><span class="p">.</span><span class="nf">name</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>ruby script.rb
<span class="c"># All colors</span>
73
Black
74
Yellow
<span class="c"># All Bricks</span>
55
Awesome brick
This brick is awesome
73
<span class="c"># Black color</span>
73
Black
<span class="c"># Colors by name</span>
74
Yellow
73
Black</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_limiter_les_résultats">Limiter les résultats</h3>
<div class="paragraph">
<p>Pour terminer cet article, je vais encore ajouter un cas, celui de la clause <code>limit</code> qui permet de limiter le nombre de résultats à récupérer en spcifiant un entier.</p>
</div>
<div class="paragraph">
<p>Au lieu de stocker les différentes valeurs comme pour <code>where</code> et <code>order by</code>, on ne conserve qu&#8217;une valeur.
On pourrait aussi envisager de lever une exception si une valeur a déjà été spécifié plus tôt dans la chaîne des <code>QueryParameters</code>.</p>
</div>
<div class="paragraph">
<p><code>limit</code> est le plus souvent utilisé indirectement quand on veut récupérer une seule valeur, sous la forme d&#8217;une méthode <code>first</code> qui spécifie le <code>limit</code> à 1, puis renvoie le premier élément du tableau de résultat.</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">QueryParameters</span>
  <span class="nb">attr_writer</span> <span class="ss">:limit</span>
  <span class="nb">attr_reader</span> <span class="ss">:wheres</span><span class="p">,</span> <span class="ss">:order_bys</span><span class="p">,</span> <span class="ss">:limit</span>

  <span class="c1"># @param [Class] model_class</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>
    <span class="vi">@model_class</span> <span class="o">=</span> <span class="n">model_class</span>
    <span class="vi">@wheres</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="vi">@order_bys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="vi">@limit</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="c1"># @param [Integer] limit</span>
  <span class="c1"># @return [Model::QueryParameters]</span>
  <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
    <span class="n">new_query_parameters</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">dup</span>
    <span class="n">new_query_parameters</span><span class="p">.</span><span class="nf">limit</span> <span class="o">=</span> <span class="n">limit</span>
    <span class="n">new_query_parameters</span>
  <span class="k">end</span>

    <span class="c1"># @return [Array]</span>
  <span class="k">def</span> <span class="nf">all</span>
    <span class="c1"># …</span>
    <span class="k">if</span> <span class="vi">@limit</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="n">limit_clause</span> <span class="o">=</span> <span class="s1">' '</span>
    <span class="k">else</span>
      <span class="n">limit_clause</span> <span class="o">=</span> <span class="s2">"LIMIT </span><span class="si">#{</span><span class="vi">@limit</span><span class="si">}</span><span class="s2"> "</span>
    <span class="k">end</span>

    <span class="c1"># Les requêtes vont ressembler à</span>
    <span class="c1"># SELECT column_name_1, column_name_2</span>
    <span class="c1">#   FROM table_name</span>
    <span class="c1">#   WHERE column_A = ? AND column_B &lt; ?</span>
    <span class="c1">#   ORDER BY column_X asc, column_Y desc</span>
    <span class="c1">#   LIMIT 10</span>
    <span class="no">DATABASE</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="s2">"SELECT </span><span class="si">#{</span><span class="n">quoted_columns_names</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
            <span class="s2">"FROM </span><span class="si">#{</span><span class="vi">@model_class</span><span class="p">.</span><span class="nf">quoted_table_name</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
            <span class="n">where_clause</span> <span class="o">+</span>
            <span class="n">order_by_clause</span> <span class="o">+</span>
            <span class="n">limit_clause</span><span class="p">,</span>
        <span class="n">where_params</span>
    <span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">result_row</span><span class="o">|</span>
    <span class="c1">#</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">first</span>
    <span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">first</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Reste encore à ajouter les méthodes sur le modèle qui font la délégation à <code>QueryParameters</code>&#160;:</p>
</div>
<div class="listingblock">
<div class="title">model.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Model</span>
  <span class="c1"># @param [Integer] limit</span>
  <span class="c1"># @return [Model::QueryParameters]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
    <span class="n">query_parameters</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># @return [Object]</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">first</span>
    <span class="n">query_parameters</span><span class="p">.</span><span class="nf">first</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est tout pour cette fois.
Pour l&#8217;article suivant, j&#8217;ajouterai une gestion minimale des relations entre objets permettant de parcourir une grape de dépendances.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ORM-4">Partie 4&#160;: relations</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">schema.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">define_model</span> <span class="s1">'Color'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'color'</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'Brick'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'brick'</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_one</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'color'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'Color'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'color_id'</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'Kit'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'kit'</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'KitBricks'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'kit_brick'</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_one</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'kit'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'Kit'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'kit_id'</span>
  <span class="p">)</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_one</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'brick'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'Brick'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'brick_id'</span>
  <span class="p">)</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ModelDefinition</span>

  <span class="no">MODELS_DEFINITIONS</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="nb">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:table_name</span><span class="p">,</span> <span class="ss">:has_ones</span>

  <span class="c1"># @param [String] name</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
    <span class="vi">@has_ones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="no">MODELS_DEFINITIONS</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
  <span class="k">end</span>

  <span class="c1"># …</span>

  <span class="c1"># @param [String] attribute_name</span>
  <span class="c1"># @param [String] model_class</span>
  <span class="c1"># @param [String] column_name</span>
  <span class="c1"># @return [void]</span>
  <span class="k">def</span> <span class="nf">has_one</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">:,</span> <span class="n">model_class</span><span class="p">:,</span> <span class="n">column_name</span><span class="p">:)</span>
    <span class="vi">@has_ones</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
        <span class="ss">attribute_name: </span><span class="n">attribute_name</span><span class="p">,</span>
        <span class="ss">model_class: </span><span class="n">model_class</span><span class="p">,</span>
        <span class="ss">column_name: </span><span class="n">column_name</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">models.rb.erb</div>
<div class="content">
<pre class="rouge highlight"><code>  &lt;% model.has_ones.each do |has_one| %&gt;
  # @return [&lt;%= has_one[:model_class] %&gt;]
  def &lt;%= has_one[:attribute_name] %&gt;
    &lt;%= has_one[:model_class] %&gt;.where('id = ?', &lt;%= has_one[:column_name] %&gt;).first
  end

  # @param [&lt;%= has_one[:model_class] %&gt;] &lt;%= has_one[:attribute_name] %&gt;
  # @return [void]
  def &lt;%= has_one[:attribute_name] %&gt;=(&lt;%= has_one[:attribute_name] %&gt;)
    @&lt;%= has_one[:column_name] %&gt; = &lt;%= has_one[:attribute_name] %&gt;.id
  end
  &lt;% end %&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">models.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Brick</span> <span class="o">&lt;</span> <span class="no">Model</span>
  <span class="c1"># …</span>
    <span class="c1"># @return [Color]</span>
  <span class="k">def</span> <span class="nf">color</span>
    <span class="no">Color</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id = ?'</span><span class="p">,</span> <span class="n">color_id</span><span class="p">).</span><span class="nf">first</span>
  <span class="k">end</span>

  <span class="c1"># @param [Color] color</span>
  <span class="c1"># @return [void]</span>
  <span class="k">def</span> <span class="nf">color</span><span class="o">=</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="vi">@color_id</span> <span class="o">=</span> <span class="n">color</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">script.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'model'</span>
<span class="nb">require_relative</span> <span class="s1">'models'</span>

<span class="n">black</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span>
<span class="n">black</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Black'</span>
<span class="n">black</span><span class="p">.</span><span class="nf">insert</span>

<span class="n">brick</span> <span class="o">=</span> <span class="no">Brick</span><span class="p">.</span><span class="nf">new</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">color</span> <span class="o">=</span> <span class="n">black</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Awesome brick'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s1">'This brick is awesome'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">insert</span>

<span class="nb">puts</span> <span class="n">brick</span><span class="p">.</span><span class="nf">color</span><span class="p">.</span><span class="nf">name</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>ruby script.rb
Black</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">schema.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">define_model</span> <span class="s1">'Color'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'color'</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_many</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'bricks'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'Brick'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'color_id'</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'Brick'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'brick'</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_one</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'color'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'Color'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'color_id'</span>
  <span class="p">)</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_many</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'kit_brick'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'KitBricks'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'brick_id'</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'Kit'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'kit'</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_many</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'kit_brick'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'KitBricks'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'kit_id'</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="n">define_model</span> <span class="s1">'KitBricks'</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_definition</span><span class="o">|</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">table</span> <span class="s1">'kit_brick'</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_one</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'kit'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'Kit'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'kit_id'</span>
  <span class="p">)</span>
  <span class="n">model_definition</span><span class="p">.</span><span class="nf">has_one</span><span class="p">(</span>
      <span class="ss">attribute_name: </span><span class="s1">'brick'</span><span class="p">,</span>
      <span class="ss">model_class: </span><span class="s1">'Brick'</span><span class="p">,</span>
      <span class="ss">column_name: </span><span class="s1">'brick_id'</span>
  <span class="p">)</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">generator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ModelDefinition</span>

  <span class="no">MODELS_DEFINITIONS</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="nb">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:table_name</span><span class="p">,</span> <span class="ss">:has_ones</span><span class="p">,</span> <span class="ss">:has_manys</span>

  <span class="c1"># @param [String] name</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
    <span class="vi">@has_ones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="vi">@has_manys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="no">MODELS_DEFINITIONS</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
  <span class="k">end</span>

  <span class="c1"># …</span>

  <span class="k">def</span> <span class="nf">has_many</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">:,</span> <span class="n">model_class</span><span class="p">:,</span> <span class="n">column_name</span><span class="p">:)</span>
    <span class="vi">@has_manys</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
        <span class="ss">attribute_name: </span><span class="n">attribute_name</span><span class="p">,</span>
        <span class="ss">model_class: </span><span class="n">model_class</span><span class="p">,</span>
        <span class="ss">column_name: </span><span class="n">column_name</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">models.rb.erb</div>
<div class="content">
<pre class="rouge highlight"><code>  &lt;% model.has_manys.each do |has_many| %&gt;
  # @return [Array&lt;&lt;%= has_many[:model_class] %&gt;&gt;]
  def &lt;%= has_many[:attribute_name] %&gt;
    &lt;%= has_many[:model_class] %&gt;.where('&lt;%= has_many[:column_name] %&gt; = ?', id).all
  end
  &lt;% end %&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">models.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Color</span> <span class="o">&lt;</span> <span class="no">Model</span>

  <span class="c1"># …</span>

  <span class="c1"># @return [Array&lt;Brick&gt;]</span>
  <span class="k">def</span> <span class="nf">bricks</span>
    <span class="no">Brick</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'color_id = ?'</span><span class="p">,</span> <span class="nb">id</span><span class="p">).</span><span class="nf">all</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">script.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'model'</span>
<span class="nb">require_relative</span> <span class="s1">'models'</span>

<span class="no">Brick</span><span class="p">.</span><span class="nf">truncate</span>
<span class="no">Color</span><span class="p">.</span><span class="nf">truncate</span>

<span class="n">black</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span>
<span class="n">black</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Black'</span>
<span class="n">black</span><span class="p">.</span><span class="nf">insert</span>

<span class="n">yellow</span> <span class="o">=</span> <span class="no">Color</span><span class="p">.</span><span class="nf">new</span>
<span class="n">yellow</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Yellow'</span>
<span class="n">yellow</span><span class="p">.</span><span class="nf">insert</span>

<span class="n">brick</span> <span class="o">=</span> <span class="no">Brick</span><span class="p">.</span><span class="nf">new</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">color</span> <span class="o">=</span> <span class="n">black</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Awesome brick'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s1">'This brick is awesome'</span>
<span class="n">brick</span><span class="p">.</span><span class="nf">insert</span>

<span class="nb">puts</span> <span class="n">black</span><span class="p">.</span><span class="nf">bricks</span><span class="p">.</span><span class="nf">length</span>
<span class="nb">puts</span> <span class="n">black</span><span class="p">.</span><span class="nf">bricks</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">name</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>ruby script.rb
1
Awesome brick</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version v0.1<br>
Last updated 2020-05-26 22:25:37 +0200
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #586e75;
}
pre.rouge .err {
  color: #002b36;
  background-color: #dc322f;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #657b83;
}
pre.rouge .cp {
  color: #b58900;
}
pre.rouge .nt {
  color: #b58900;
}
pre.rouge .o, pre.rouge .ow {
  color: #93a1a1;
}
pre.rouge .p, pre.rouge .pi {
  color: #93a1a1;
}
pre.rouge .gi {
  color: #859900;
}
pre.rouge .gd {
  color: #dc322f;
}
pre.rouge .gh {
  color: #268bd2;
  background-color: #002b36;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kv {
  color: #6c71c4;
}
pre.rouge .kc {
  color: #cb4b16;
}
pre.rouge .kt {
  color: #cb4b16;
}
pre.rouge .kd {
  color: #cb4b16;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sb, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1 {
  color: #859900;
}
pre.rouge .sr {
  color: #2aa198;
}
pre.rouge .si {
  color: #d33682;
}
pre.rouge .se {
  color: #d33682;
}
pre.rouge .nn {
  color: #b58900;
}
pre.rouge .nc {
  color: #b58900;
}
pre.rouge .no {
  color: #b58900;
}
pre.rouge .na {
  color: #268bd2;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #859900;
}
pre.rouge .ss {
  color: #859900;
}
</style>
</body>
</html>